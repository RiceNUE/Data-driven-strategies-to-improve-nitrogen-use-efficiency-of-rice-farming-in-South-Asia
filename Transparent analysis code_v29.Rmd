---
title: "Analysis_South Asia NUE"
author: "Sam Coggins"
date: '2024-06-23'
output: html_document
---

SECTION 1) Loading and cleaning data (see section 4.1 of methods)

1.1) Input data

```{R}
setwd("[insert working directory]")
raw_data <- read.csv("NUE_survey_dataset.csv")
```

1.2) Applying data exlcusion criteria

```{r}
# 
nib6 <- raw_data

# Applying exclusion criteria defined in section 4.1 of methods

## Trimming strange yield values
nib6 <- nib6[-which(nib6$yield_kg_ha  < 500),]
nib6 <- nib6[-which(nib6$yield_kg_ha > 10000),] 
nib6 <- nib6[which(is.na(nib6$yield_kg_ha) == F),]

## Trimming very low and very high N_rate values
nib6 <- nib6[-which(nib6$N_kg_ha > 400),]
nib6 <- nib6[-which(nib6$N_kg_ha == 0),] 
nib6 <- nib6[which(is.na(nib6$N_kg_ha) == F),]

## Trimming non-transplanted
nib6 <- nib6[which(nib6$EST_binary == "Transplanted"),]

## Trimming rabi
nib6 <- nib6[which(nib6$SEASON == "Kharif"),]

## Trimming weird crop calendar data
nib6 <- nib6[-which(nib6$Nursery_duration < 0 | nib6$Nursery_duration > 100),]
nib6 <- nib6[-which(nib6$Field_duration < 60 | nib6$Field_duration > 200),]
nib6 <- nib6[-which(nib6$Crop_duration < 90 | nib6$Crop_duration > 340),]

```

1.3) Defining required predcitor variables

```{r}
potpreds <- c(
  "GEN",
  "EDU",
  "SOCCAT",
  "HHMEM",
  "HIFAG",
  "DISMR",
  "SOPER",
  "SOILTEX",
  "DCLASS",
  "SoilGrids_bdod",
  "SoilGrids_phh2o",
  "SoilGrids_sand",
  "SoilGrids_soc",
  "PCRR", 
  "VARTYPE",
  "EST_line",
  "SRATEHA",
  "TDATE_rel",
  "IRRINU",
  "total_precip",
  "avg_dspell_length",
  "monsoon_onset",
  "monsoon_retreat",
  "WSEV",
  "DISEV",
  "DRSEV",
  "FLSEV",
  "LOD",
  "Nursery_duration",
  "Field_duration",
  "P2O5_ha",
  "K2O_ha",
  "GYP_ha",
  "BOR_ha",
  "Zn_ha",
  "Organic_ha",
  "Nperc_pre_7_DAT",
  "Nperc_7to30_DAT",
  "MaxUnsplit_Nperc_within_1_days"
)

pred_dashboard_0 <- as.data.frame(potpreds)

# Distinguishing character variables from continuous variables
pred_dashboard_0$class <- "tbc"
for (i in 1:nrow(pred_dashboard_0)){
  pred_dashboard_0[i,"class"] <- class(nib6[,pred_dashboard_0[i,"potpreds"]])
}

# Adding column names
regs <- data.frame(unique(nib6$Region))
colnames(regs)[1] <- "Region"
for(i in 1:nrow(regs)){
  pred_dashboard_0[,regs[i,"Region"]] <- "tbc"
}
pred_dashboard_0$Aggregated <- "tbc"

```

1.4) Reporting sample size for each year and region (Table S6 in Supplementary Information 9)

```{r}
library(formattable)
# Defining region names
regs$Region_figurename <- regs$Region
regs[which(regs$Region == "AP"),"Region_figurename"] <- "Andhra Pradesh"
regs[which(regs$Region == "Bihar"),"Region_figurename"] <- "Bihar & E.U.P."
regs[which(regs$Region == "Punjab_Haryana"),"Region_figurename"] <- "Punjab & Haryana"
regs[which(regs$Region == "Bangladesh"),"Region_figurename"] <- "Bangladesh's floodplains"
regs[which(regs$Region == "Nepal"),"Region_figurename"] <- "Terai of Nepal"


year_table <- data.frame(regs$Region_figurename)
colnames(year_table)[1] <- "Geography"

year_table[,ncol(year_table)+1] <- 0
colnames(year_table)[ncol(year_table)] <- "2016"

year_table[,ncol(year_table)+1] <- 0
colnames(year_table)[ncol(year_table)] <- "2017"

year_table[,ncol(year_table)+1] <- 0
colnames(year_table)[ncol(year_table)] <- "2018"

year_table[,ncol(year_table)+1] <- 0
colnames(year_table)[ncol(year_table)] <- "2019"

year_table[,ncol(year_table)+1] <- 0
colnames(year_table)[ncol(year_table)] <- "2020"

for(i in 1:nrow(regs)){
year_table[i,"2016"] <- length(which(nib6$Region == regs[i,"Region"] & nib6$year == 2016))
year_table[i,"2017"] <- length(which(nib6$Region == regs[i,"Region"] & nib6$year == 2017))
year_table[i,"2018"] <- length(which(nib6$Region == regs[i,"Region"] & nib6$year == 2018))
year_table[i,"2019"] <- length(which(nib6$Region == regs[i,"Region"] & nib6$year == 2019))
year_table[i,"2020"] <- length(which(nib6$Region == regs[i,"Region"] & nib6$year == 2020)) + length(which(nib6$Region == regs[i,"Region"] & nib6$year == 2021))

}

year_table2 <- year_table
year_table2[7, 1] <- "All geographies"
year_table2[nrow(year_table2), "2016"] <- sum(year_table2[1:6,"2016"])
year_table2[nrow(year_table2), "2017"] <- sum(year_table2[1:6,"2017"])
year_table2[nrow(year_table2), "2018"] <- sum(year_table2[1:6,"2018"])
year_table2[nrow(year_table2), "2019"] <- sum(year_table2[1:6,"2019"])
year_table2[nrow(year_table2), "2020"] <- sum(year_table2[1:6,"2020"])

year_table2$Total <- NA
for(i in 1:nrow(year_table2)){
year_table2[i, "Total"] <- sum(year_table2[i,2:6])
}

# Clarifying sample size for important thresholds
length(which(nib6$Region == "Nepal" & nib6$yield_kg_ha == 3000))
length(which(nib6$Region == "Nepal" & nib6$yield_kg_ha == 6000))
length(which(nib6$Region == "Odisha" & nib6$yield_kg_ha == 5000))
length(which(nib6$Region == "Bangladesh" & nib6$yield_kg_ha == 4940))

# Tidying
year_table3 <- year_table2[c(1,3,5,6,2,4,7),]
colnames(year_table3)[1] <- "Region"
year_table3[which(year_table3$Region == "All geographies"),"Region"] <- "Aggregate"
year_table3[which(year_table3$Region == "Bangladesh floodplains"),"Region"] <- "Bangladesh's floodplains"
year_table3[which(year_table3$Region == "Nepal Terai"),"Region"] <- "Terai of Nepal"


total_format <- formatter("span",style = x ~ style(font.weight = "bold"))
formattable(year_table3,
            list(Total = total_format))
            

```

1.5) Mapping sample distribution (Figure 5)

```{r}
library(raster)
library(sf)
library(dplyr)
library(sp)
library(leaflet)
library(ggraph)
library(arulesViz)
library(magrittr)
library(tools)
library(ggplot2)
library(geodata)

working_directory <- "[insert working directory]"

# Prepare nib6 for merging with shapefile
nib6_sf <- st_as_sf(nib6, coords = c("LONG", "LAT"), crs = "+proj=longlat +datum=WGS84 +no_defs")

# Get ploygons
India_states_polygon <- gadm(working_directory, country='IND', level=1)
Nepal_polygon <- gadm(working_directory, country='Nepal', level=0)
Bangladesh_polygon <- gadm(working_directory, country='Bangladesh', level=0)
India_polygon <- gadm(working_directory,country = 'India', level=0)
Region_boundaries_polygon <- rbind(India_states_polygon, Nepal_polygon, Bangladesh_polygon)
Country_boundaries_polygon <- rbind(India_polygon, Nepal_polygon, Bangladesh_polygon)

India_districts_polygon <- gadm(working_directory, country='IND', level=2)
Nepal_districts_polygon <- gadm(working_directory, country='Nepal', level=2)
Bangladesh_districts_polygon <- gadm(working_directory, country='Bangladesh', level=2)
Region_districts_polygon <- rbind(India_districts_polygon, Nepal_districts_polygon, Bangladesh_districts_polygon)

# Make polygon sf
India_states_sf <- st_as_sf(India_states_polygon)
Nepal_sf <- st_as_sf(Nepal_polygon)
Bangladesh_sf <- st_as_sf(Bangladesh_polygon)
India_sf <- st_as_sf(India_polygon)
Region_boundaries_sf <- st_as_sf(Region_boundaries_polygon)
Region_districts_sf <- st_as_sf(Region_districts_polygon)
Country_boundaries_sf <- st_as_sf(Country_boundaries_polygon)

# Get relevant region centroids
India_states_sf <- cbind(India_states_sf, st_coordinates(st_centroid(India_states_sf)))
Relevant_India_states_sf <- India_states_sf[which(
  India_states_sf$NAME_1 == "Bihar" |
  India_states_sf$NAME_1 == "Punjab" |
  India_states_sf$NAME_1 == "Haryana" |
  India_states_sf$NAME_1 == "Andhra Pradesh" |
  India_states_sf$NAME_1 == "Uttar Pradesh" |
  India_states_sf$NAME_1 == "Odisha"
  ),]
Irelevant_India_states_sf <- India_states_sf[-which(
  India_states_sf$NAME_1 == "Bihar" |
  India_states_sf$NAME_1 == "Punjab" |
  India_states_sf$NAME_1 == "Haryana" |
  India_states_sf$NAME_1 == "Andhra Pradesh" |
  India_states_sf$NAME_1 == "Uttar Pradesh" |
  India_states_sf$NAME_1 == "Odisha"
  ),]
Relevant_India_states_sf[which(Relevant_India_states_sf$NAME_1 == "Uttar Pradesh"),"NAME_1"] <- "Uttar\nPradesh"
Bangladesh_sf <- cbind(Bangladesh_sf, st_coordinates(st_centroid(Bangladesh_sf)))
Nepal_sf <- cbind(Nepal_sf, st_coordinates(st_centroid(Nepal_sf)))

# Decide on how to position lables
Region_label <- as.data.frame(c("AP","Bihar","Haryana","Odisha","Punjab","U.P.","Bangladesh","Nepal"))
colnames(Region_label)[1] <- "Region"
Region_label$nudge_x <- c(5.4,0.0,-3.4,4.6,-3.6,-5.4,3.5,2.4)
Region_label$nudge_y <- c(-1.1,-2.1,-1.7,-1.3,0.8,-2.6,2.4,1.4)


## ID district with no data
map_count_DISTRICT <- aggregate(nib6_sf,Region_districts_sf,length)
map_count_DISTRICT__LOSERS <- map_count_DISTRICT[-which(map_count_DISTRICT$Merged_ID > 0),]

## Make map
Figure5 <- ggplot() +
  geom_sf(data = Country_boundaries_sf, fill = 'white', colour = 'grey') +
  geom_sf(data = nib6_sf, color = 'grey', alpha=0.2) + 
  stat_density2d(data = nib6_sf,
                 aes(x = purrr::map_dbl(geometry, ~.[1]),y = purrr::map_dbl(geometry, ~.[2])
                ,fill = ..level..
                ,alpha = ..level..
                ),
                geom = "polygon") +
  scale_fill_continuous(type = "viridis") +
  geom_sf(data = Irelevant_India_states_sf, fill = 'white', colour = NA) +
  geom_sf(data = map_count_DISTRICT__LOSERS, fill = 'white', colour = NA) +
  geom_sf(data = Country_boundaries_sf, fill = NA, size = 0.1, colour = 'grey') +
  geom_sf(data = Relevant_India_states_sf, fill = NA, size = 1) +
  geom_sf(data = Bangladesh_sf, fill = NA, size = 1) +
  geom_sf(data = Nepal_sf, fill = NA, size = 1) +
  theme_bw() +
  theme(panel.background = element_rect(fill = 'white'),
        legend.position = "none"
        ) + 
  xlab("Longitude") +
  ylab("Latitude") +
  geom_label(data = Relevant_India_states_sf, aes(X, Y, label = NAME_1), size = 3, fontface = "bold",
  nudge_x = Region_label[1:6,"nudge_x"], nudge_y = Region_label[1:6,"nudge_y"], # AP,Bihar,Haryana,Odisha,Punjab,UP
  lineheight = 0.8) + # lineheight reduces size of line break inside label
  geom_label(data = Bangladesh_sf, aes(X, Y, label = COUNTRY), size = 3, fontface = "bold",
  nudge_x = Region_label[7,"nudge_x"], nudge_y = Region_label[7,"nudge_y"]) +
  geom_label(data = Nepal_sf, aes(X, Y, label = COUNTRY), size = 3, fontface = "bold",
  nudge_x = Region_label[8,"nudge_x"], nudge_y = Region_label[8,"nudge_y"])

# Save map
setwd('[insert working directory]')
ggsave(filename = "Figure5.png", plot = Figure5, width = 4.5, height = 4.5, units = "in", dpi = 1000)
  
```

SECTION 2) Analysing current NUE of rice crops in South Asia (see section 4.2 of methods)

2.1) Calculating nitrogen outcome metrics

```{r}
# Inputting assumptions defined in supplementary material 1 for assumptions
DM_perc <- 0.86 # % of reported yield that is dry matter
Grain_N_perc <- 0.0113 
Straw_N_perc <- 0.0069 
Harvest_index <- 0.481 
N_deposition <- 38

# Calculating N input
nib6$N_input_ladha <- nib6$N_kg_ha + N_deposition

# Calculating N output
nib6$yield_DM_kg_ha <- nib6$yield_kg_ha * DM_perc
nib6$Grain_N_output <- nib6$yield_DM_kg_ha * Grain_N_perc
nib6$Straw_mass <- (nib6$yield_DM_kg_ha / Harvest_index) - nib6$yield_DM_kg_ha # biological yield - grain yield
nib6$Straw_N_output <- nib6$Straw_mass * Straw_N_perc
nib6$N_output <- nib6$Grain_N_output + nib6$Straw_N_output
nib6$N_balance_ladha <- nib6$N_kg_ha - nib6$N_output + N_deposition

# Calculating NUE
nib6$NUE_excl_deposition <- nib6$yield_kg_ha / nib6$N_kg_ha

# Calculating NEI (N emission intensity)
nib6$laymansNEI_ladha <- nib6$N_balance_ladha / nib6$yield_kg_ha

# Calculating mean for each region
for(i in 1:nrow(regs)){
working_data <- nib6[which(nib6$Region == regs[i,1]),]
regs[i,"mean_N_kg_ha"] <- mean(working_data$N_kg_ha)
regs[i,"mean_laymansNEI_ladha"] <- mean(working_data$laymansNEI_ladha)
regs[i,"mean_NUE_excl_deposition"] <- mean(working_data$NUE_excl_deposition)
regs[i,"mean_N_output"] <- mean(working_data$N_output)
}

```

2.2) Analysing variation in mineral macronutrient application (Figure S2 in Supplementary Information 3)

```{r}
library(ggplot2)

# Naming regions appropriately
nib6$Region_name <- nib6$Region
nib6[which(nib6$Region == "AP"), "Region_name"] <- "Andhra Pradesh"
nib6[which(nib6$Region == "Bangladesh"), "Region_name"] <- "Bangladesh's floodplains"
nib6[which(nib6$Region == "Bihar"), "Region_name"] <- "Bihar & E.U.P."
nib6[which(nib6$Region == "Nepal"), "Region_name"] <- "Terai of Nepal"
nib6[which(nib6$Region == "Odisha"), "Region_name"] <- "Odisha"
nib6[which(nib6$Region == "Punjab_Haryana"), "Region_name"] <- "Punjab & Haryana"
nib6$Region_name <- factor(nib6$Region_name , levels=c("Andhra Pradesh", "Bihar & E.U.P.", "Odisha", "Punjab & Haryana","Bangladesh's floodplains","Terai of Nepal"))

## Add lines in axis labels
addline_format <- function(x,...){
    gsub('\\s','\n',x)
}

## N rate
ggplot(nib6,aes(Region_name, N_kg_ha))+
  geom_boxplot(aes(fill= Region_name)) +
  labs(y = expression("Nitrogen application rate (N kg ha"^{-1}*")"), x = "Region") +
  ylim(0,300)+ 
  theme(legend.position="none") +
  theme(text = element_text(size=17),
        axis.text.x = element_text(size=17),
        axis.text.y = element_text(size=17)) +
  scale_x_discrete(breaks=unique(nib6$Region_name),
  labels=addline_format(unique(nib6$Region_name))) +
  theme(axis.title.y = element_text(vjust=2)) +
  theme(axis.title.x = element_text(vjust=-0.2))

## P rate
ggplot(nib6,aes(Region_name,P2O5_ha))+
  geom_boxplot(aes(fill=Region_name)) +
  labs(y = expression("Phosphorus application rate (P2O5 kg ha"^{-1}*")"), x = "Region") +
  ylim(0,300)+ 
  theme(legend.position="none") +
  theme(text = element_text(size=17),
        axis.text.x = element_text(size=17),
        axis.text.y = element_text(size=17)) +
  scale_x_discrete(breaks=unique(nib6$Region_name),
  labels=addline_format(unique(nib6$Region_name))) +
  theme(axis.title.y = element_text(vjust=2)) +
  theme(axis.title.x = element_text(vjust=-0.2))

## K rate
ggplot(nib6,aes(Region_name,K2O_ha))+
  geom_boxplot(aes(fill=Region_name)) +
  labs(y = expression("Potassium application rate (K2O kg ha"^{-1}*")"), x = "Region") +
  ylim(0,300)+ 
  theme(legend.position="none")  +
  theme(text = element_text(size=17),
        axis.text.x = element_text(size=17),
        axis.text.y = element_text(size=17)) +
  scale_x_discrete(breaks=unique(nib6$Region_name),
  labels=addline_format(unique(nib6$Region_name))) +
  theme(axis.title.y = element_text(vjust=2)) +
  theme(axis.title.x = element_text(vjust=-0.2))

```

2.3) Comparing nitrogen outcomes across regions (Figure 1a)

```{r}
library(formattable)
library("htmltools")
library("webshot") 

# Input monsoon rice area assumptions defined in Table S4 in supplementary information 5
regs$Monsoon_area_ha <- NA

regs[which(regs$Region == "Bihar"),"Monsoon_area_ha"] <- (30.728 * 100000) +  
                                                         1199398 
regs[which(regs$Region == "Odisha"),"Monsoon_area_ha"] <- (34.998 * 100000) 
regs[which(regs$Region == "AP"),"Monsoon_area_ha"] <-  (13.220 * 100000)
regs[which(regs$Region == "Nepal"),"Monsoon_area_ha"] <- 1350859 
regs[which(regs$Region == "Bangladesh"),"Monsoon_area_ha"] <- 11895000 / 2.471 
regs[which(regs$Region == "Punjab_Haryana"),"Monsoon_area_ha"] <- (31.680 * 100000) + (13.910 * 100000) 

Total_monsoon_area <- sum(regs$Monsoon_area_ha)


## Mean (of area)
regs$Nrate_mean_excl_deposition <- NA
regs$Yield_mean <- NA
regs$PFP_mean_excl_deposition <- NA
regs$Surplus_mean_excl_deposition <- NA
regs$laymansNEI_mean_excl_deposition <- NA

for(i in 1:nrow(regs)){
region <- regs[i,"Region"]
regs[i,"Nrate_mean_excl_deposition"] <- round(mean(nib6[which(nib6$Region == region),"N_kg_ha"]),0)
regs[i,"Yield_mean"] <-  round(
  (mean(nib6[which(nib6$Region == region),"yield_kg_ha"]) / 1000),1)
regs[i,"PFP_mean_excl_deposition"] <-  round(
  sum(nib6[which(nib6$Region == region),"yield_kg_ha"]) /
  sum(nib6[which(nib6$Region == region),"N_kg_ha"])
  )
regs[i,"Surplus_mean_ladha"] <- round(
  (sum(nib6[which(nib6$Region == region),"N_input_ladha"]) -
  sum(nib6[which(nib6$Region == region),"N_output"]))
  / nrow(nib6[which(nib6$Region == region),]))
regs[i,"laymansNEI_mean_ladha"] <- regs[i,"Surplus_mean_ladha"] / 
  (regs[i,"Yield_mean"] * 1000)
}

## Selcect metrics we want
N_descriptive_summary <- data.frame(regs$Region)
colnames(N_descriptive_summary)[1] <- "Region"
N_descriptive_summary$Monsoon_area_million_ha <- round(regs$Monsoon_area_ha / 1000000, 1)
N_descriptive_summary$N_kg_ha <- regs$Nrate_mean_excl_deposition
N_descriptive_summary$Yield_t_ha <- regs$Yield_mean
N_descriptive_summary$N_PFP <- regs$PFP_mean_excl_deposition
N_descriptive_summary$N_surplus <- regs$Surplus_mean_ladha
N_descriptive_summary$laymansNEI <- regs$laymansNEI_mean_ladha
N_descriptive_summary$Region <- regs$Region_figurename


# Making aggregate figures
N_descriptive_summary[nrow(N_descriptive_summary)+1,] <- "tbc"
N_descriptive_summary[nrow(N_descriptive_summary), "Region"] <- "Aggregate"
N_descriptive_summary[nrow(N_descriptive_summary), "Yield_t_ha"] <- round(
  (((as.numeric(regs[1,"Yield_mean"]) * regs[1,"Monsoon_area_ha"]) +
  (as.numeric(regs[2,"Yield_mean"]) * regs[2,"Monsoon_area_ha"]) +
  (as.numeric(regs[3,"Yield_mean"]) * regs[3,"Monsoon_area_ha"]) +
  (as.numeric(regs[4,"Yield_mean"]) * regs[4,"Monsoon_area_ha"]) +
  (as.numeric(regs[5,"Yield_mean"]) * regs[5,"Monsoon_area_ha"]) +
  (as.numeric(regs[6,"Yield_mean"]) * regs[6,"Monsoon_area_ha"]))
  / Total_monsoon_area), 0)
N_descriptive_summary[nrow(N_descriptive_summary), "N_kg_ha"] <- round(
  (((as.numeric(regs[1,"Nrate_mean_excl_deposition"]) * regs[1,"Monsoon_area_ha"]) +
  (as.numeric(regs[2,"Nrate_mean_excl_deposition"]) * regs[2,"Monsoon_area_ha"]) +
  (as.numeric(regs[3,"Nrate_mean_excl_deposition"]) * regs[3,"Monsoon_area_ha"]) +
  (as.numeric(regs[4,"Nrate_mean_excl_deposition"]) * regs[4,"Monsoon_area_ha"]) +
  (as.numeric(regs[5,"Nrate_mean_excl_deposition"]) * regs[5,"Monsoon_area_ha"]) +
  (as.numeric(regs[6,"Nrate_mean_excl_deposition"]) * regs[6,"Monsoon_area_ha"]))
  / Total_monsoon_area), 0)
N_descriptive_summary[nrow(N_descriptive_summary), "N_PFP"] <- round(
  (((as.numeric(regs[1,"PFP_mean_excl_deposition"]) * regs[1,"Monsoon_area_ha"]) +
  (as.numeric(regs[2,"PFP_mean_excl_deposition"]) * regs[2,"Monsoon_area_ha"]) +
  (as.numeric(regs[3,"PFP_mean_excl_deposition"]) * regs[3,"Monsoon_area_ha"]) +
  (as.numeric(regs[4,"PFP_mean_excl_deposition"]) * regs[4,"Monsoon_area_ha"]) +
  (as.numeric(regs[5,"PFP_mean_excl_deposition"]) * regs[5,"Monsoon_area_ha"]) +
  (as.numeric(regs[6,"PFP_mean_excl_deposition"]) * regs[6,"Monsoon_area_ha"]))
  / Total_monsoon_area), 0)
N_descriptive_summary[nrow(N_descriptive_summary), "N_surplus"] <- round(
  (((as.numeric(regs[1,"Surplus_mean_ladha"]) * regs[1,"Monsoon_area_ha"]) +
  (as.numeric(regs[2,"Surplus_mean_ladha"]) * regs[2,"Monsoon_area_ha"]) +
  (as.numeric(regs[3,"Surplus_mean_ladha"]) * regs[3,"Monsoon_area_ha"]) +
  (as.numeric(regs[4,"Surplus_mean_ladha"]) * regs[4,"Monsoon_area_ha"]) +
  (as.numeric(regs[5,"Surplus_mean_ladha"]) * regs[5,"Monsoon_area_ha"]) +
  (as.numeric(regs[6,"Surplus_mean_ladha"]) * regs[6,"Monsoon_area_ha"]))
  / Total_monsoon_area), 0)
N_descriptive_summary[nrow(N_descriptive_summary), "laymansNEI"] <- 
  (((as.numeric(regs[1,"laymansNEI_mean_ladha"]) * regs[1,"Monsoon_area_ha"]) +
  (as.numeric(regs[2,"laymansNEI_mean_ladha"]) * regs[2,"Monsoon_area_ha"]) +
  (as.numeric(regs[3,"laymansNEI_mean_ladha"]) * regs[3,"Monsoon_area_ha"]) +
  (as.numeric(regs[4,"laymansNEI_mean_ladha"]) * regs[4,"Monsoon_area_ha"]) +
  (as.numeric(regs[5,"laymansNEI_mean_ladha"]) * regs[5,"Monsoon_area_ha"]) +
  (as.numeric(regs[6,"laymansNEI_mean_ladha"]) * regs[6,"Monsoon_area_ha"]))
  / Total_monsoon_area)
N_descriptive_summary[nrow(N_descriptive_summary), "Monsoon_area_million_ha"] <- 
  round(((regs[1,"Monsoon_area_ha"] +
  regs[2,"Monsoon_area_ha"] +
  regs[3,"Monsoon_area_ha"] +
  regs[4,"Monsoon_area_ha"] +
  regs[5,"Monsoon_area_ha"] +
  regs[6,"Monsoon_area_ha"]) / 1000000),1)

# Making laymans NEI POP
N_descriptive_summary$laymansNEI <- as.numeric(N_descriptive_summary$laymansNEI) * 1000
N_descriptive_summary$laymansNEI <- round(N_descriptive_summary$laymansNEI, 0)

# Ensuring .0 isn't removed
N_descriptive_summary$Yield_t_ha <- round(as.numeric(N_descriptive_summary$Yield_t_ha), 1)



Yield_green <- formatter("span",
                  style = x ~ style(display = "inline-block", color = "black","border-radius" = "4px",
                                    "padding-right" = "0px", "padding-left" = "0px", width = "90px", margin = "0px",
                                    "background-color" = ifelse(as.numeric(x) <= 2.3, colorRampPalette(c("transparent", "forestgreen"))(100)[5],
                                                         ifelse(as.numeric(x) <= 2.6, colorRampPalette(c("transparent", "forestgreen"))(100)[10],
                                                         ifelse(as.numeric(x) <= 2.9, colorRampPalette(c("transparent", "forestgreen"))(100)[15],
                                                         ifelse(as.numeric(x) <= 3.2, colorRampPalette(c("transparent", "forestgreen"))(100)[20],
                                                         ifelse(as.numeric(x) <= 3.5, colorRampPalette(c("transparent", "forestgreen"))(100)[25],
                                                         ifelse(as.numeric(x) <= 3.8, colorRampPalette(c("transparent", "forestgreen"))(100)[30],
                                                         ifelse(as.numeric(x) <= 4.1, colorRampPalette(c("transparent", "forestgreen"))(100)[35],
                                                         ifelse(as.numeric(x) <= 4.4, colorRampPalette(c("transparent", "forestgreen"))(100)[40],
                                                         ifelse(as.numeric(x) <= 4.7, colorRampPalette(c("transparent", "forestgreen"))(100)[45],
                                                         ifelse(as.numeric(x) <= 5, colorRampPalette(c("transparent", "forestgreen"))(100)[50],
                                                         ifelse(as.numeric(x) <= 5.3, colorRampPalette(c("transparent", "forestgreen"))(100)[55],
                                                         ifelse(as.numeric(x) <= 5.6, colorRampPalette(c("transparent", "forestgreen"))(100)[60],
                                                         ifelse(as.numeric(x) <= 5.9, colorRampPalette(c("transparent", "forestgreen"))(100)[65],
                                                         ifelse(as.numeric(x) <= 6.2, colorRampPalette(c("transparent", "forestgreen"))(100)[70],
                                                         ifelse(as.numeric(x) <= 6.5, colorRampPalette(c("transparent", "forestgreen"))(100)[75],
                                                         ifelse(as.numeric(x) <= 6.8, colorRampPalette(c("transparent", "forestgreen"))(100)[80],
                                                         ifelse(as.numeric(x) <= 7.1, colorRampPalette(c("transparent", "forestgreen"))(100)[85],
                                                         ifelse(as.numeric(x) <= 7.4, colorRampPalette(c("transparent", "forestgreen"))(100)[90],
                                                         ifelse(as.numeric(x) <= 7.7, colorRampPalette(c("transparent", "forestgreen"))(100)[95],
                                                         ifelse(as.numeric(x) <= 8, colorRampPalette(c("transparent", "forestgreen"))(100)[100]))))))))))))))))))))))

Nrate_orange <- formatter("span",
                  style = x ~ style(display = "inline-block", color = "black","border-radius" = "4px",
                                    "padding-right" = "0px", "padding-left" = "0px", width = "90px", margin = "0px",
                                    "background-color" = ifelse(as.numeric(x) <= 56, colorRampPalette(c("transparent", "orange"))(100)[5],
                                                         ifelse(as.numeric(x) <= 64, colorRampPalette(c("transparent", "orange"))(100)[10],
                                                         ifelse(as.numeric(x) <= 74, colorRampPalette(c("transparent", "orange"))(100)[15],
                                                         ifelse(as.numeric(x) <= 82, colorRampPalette(c("transparent", "orange"))(100)[20],
                                                         ifelse(as.numeric(x) <= 90, colorRampPalette(c("transparent", "orange"))(100)[25],
                                                         ifelse(as.numeric(x) <= 98, colorRampPalette(c("transparent", "orange"))(100)[30],
                                                         ifelse(as.numeric(x) <= 106, colorRampPalette(c("transparent", "orange"))(100)[35],
                                                         ifelse(as.numeric(x) <= 114, colorRampPalette(c("transparent", "orange"))(100)[40],
                                                         ifelse(as.numeric(x) <= 122, colorRampPalette(c("transparent", "orange"))(100)[45],
                                                         ifelse(as.numeric(x) <= 130, colorRampPalette(c("transparent", "orange"))(100)[50],
                                                         ifelse(as.numeric(x) <= 138, colorRampPalette(c("transparent", "orange"))(100)[55],
                                                         ifelse(as.numeric(x) <= 146, colorRampPalette(c("transparent", "orange"))(100)[60],
                                                         ifelse(as.numeric(x) <= 154, colorRampPalette(c("transparent", "orange"))(100)[65],
                                                         ifelse(as.numeric(x) <= 162, colorRampPalette(c("transparent", "orange"))(100)[70],
                                                         ifelse(as.numeric(x) <= 170, colorRampPalette(c("transparent", "orange"))(100)[75],
                                                         ifelse(as.numeric(x) <= 178, colorRampPalette(c("transparent", "orange"))(100)[80],
                                                         ifelse(as.numeric(x) <= 186, colorRampPalette(c("transparent", "orange"))(100)[85],
                                                         ifelse(as.numeric(x) <= 194, colorRampPalette(c("transparent", "orange"))(100)[90],
                                                         ifelse(as.numeric(x) <= 202, colorRampPalette(c("transparent", "orange"))(100)[95],
                                                         ifelse(as.numeric(x) <= 210, colorRampPalette(c("transparent", "orange"))(100)[100]))))))))))))))))))))))


PFP_green <- formatter("span",
                  style = x ~ style(display = "inline-block", color = "black","border-radius" = "4px",
                                    "padding-right" = "0px", "padding-left" = "0px", width = "90px", margin = "0px",
                                    "background-color" = ifelse(as.numeric(x) <= 23, colorRampPalette(c("transparent", "forestgreen"))(100)[5],
                                                         ifelse(as.numeric(x) <= 26, colorRampPalette(c("transparent", "forestgreen"))(100)[10],
                                                         ifelse(as.numeric(x) <= 29, colorRampPalette(c("transparent", "forestgreen"))(100)[15],
                                                         ifelse(as.numeric(x) <= 32, colorRampPalette(c("transparent", "forestgreen"))(100)[20],
                                                         ifelse(as.numeric(x) <= 35, colorRampPalette(c("transparent", "forestgreen"))(100)[25],
                                                         ifelse(as.numeric(x) <= 38, colorRampPalette(c("transparent", "forestgreen"))(100)[30],
                                                         ifelse(as.numeric(x) <= 41, colorRampPalette(c("transparent", "forestgreen"))(100)[35],
                                                         ifelse(as.numeric(x) <= 44, colorRampPalette(c("transparent", "forestgreen"))(100)[40],
                                                         ifelse(as.numeric(x) <= 47, colorRampPalette(c("transparent", "forestgreen"))(100)[45],
                                                         ifelse(as.numeric(x) <= 50, colorRampPalette(c("transparent", "forestgreen"))(100)[50],
                                                         ifelse(as.numeric(x) <= 53, colorRampPalette(c("transparent", "forestgreen"))(100)[55],
                                                         ifelse(as.numeric(x) <= 56, colorRampPalette(c("transparent", "forestgreen"))(100)[60],
                                                         ifelse(as.numeric(x) <= 59, colorRampPalette(c("transparent", "forestgreen"))(100)[65],
                                                         ifelse(as.numeric(x) <= 62, colorRampPalette(c("transparent", "forestgreen"))(100)[70],
                                                         ifelse(as.numeric(x) <= 65, colorRampPalette(c("transparent", "forestgreen"))(100)[75],
                                                         ifelse(as.numeric(x) <= 68, colorRampPalette(c("transparent", "forestgreen"))(100)[80],
                                                         ifelse(as.numeric(x) <= 71, colorRampPalette(c("transparent", "forestgreen"))(100)[85],
                                                         ifelse(as.numeric(x) <= 74, colorRampPalette(c("transparent", "forestgreen"))(100)[90],
                                                         ifelse(as.numeric(x) <= 77, colorRampPalette(c("transparent", "forestgreen"))(100)[95],
                                                         ifelse(as.numeric(x) <= 80, colorRampPalette(c("transparent", "forestgreen"))(100)[100]))))))))))))))))))))))     

Nsurplus_red <- formatter("span",
                  style = x ~ style(display = "inline-block", color = "black","border-radius" = "4px",
                                    "padding-right" = "0px", "padding-left" = "0px", width = "90px", margin = "0px",
                                    "background-color" = ifelse(as.numeric(x) <= 34, colorRampPalette(c("transparent", "indianred4"))(100)[5],
                                                         ifelse(as.numeric(x) <= 38, colorRampPalette(c("transparent", "indianred4"))(100)[10],
                                                         ifelse(as.numeric(x) <= 42, colorRampPalette(c("transparent", "indianred4"))(100)[15],
                                                         ifelse(as.numeric(x) <= 46, colorRampPalette(c("transparent", "indianred4"))(100)[20],
                                                         ifelse(as.numeric(x) <= 50, colorRampPalette(c("transparent", "indianred4"))(100)[25],
                                                         ifelse(as.numeric(x) <= 54, colorRampPalette(c("transparent", "indianred4"))(100)[30],
                                                         ifelse(as.numeric(x) <= 58, colorRampPalette(c("transparent", "indianred4"))(100)[35],
                                                         ifelse(as.numeric(x) <= 62, colorRampPalette(c("transparent", "indianred4"))(100)[40],
                                                         ifelse(as.numeric(x) <= 66, colorRampPalette(c("transparent", "indianred4"))(100)[45],
                                                         ifelse(as.numeric(x) <= 70, colorRampPalette(c("transparent", "indianred4"))(100)[50],
                                                         ifelse(as.numeric(x) <= 74, colorRampPalette(c("transparent", "indianred4"))(100)[55],
                                                         ifelse(as.numeric(x) <= 78, colorRampPalette(c("transparent", "indianred4"))(100)[60],
                                                         ifelse(as.numeric(x) <= 82, colorRampPalette(c("transparent", "indianred4"))(100)[65],
                                                         ifelse(as.numeric(x) <= 86, colorRampPalette(c("transparent", "indianred4"))(100)[70],
                                                         ifelse(as.numeric(x) <= 90, colorRampPalette(c("transparent", "indianred4"))(100)[75],
                                                         ifelse(as.numeric(x) <= 94, colorRampPalette(c("transparent", "indianred4"))(100)[80],
                                                         ifelse(as.numeric(x) <= 98, colorRampPalette(c("transparent", "indianred4"))(100)[85],
                                                         ifelse(as.numeric(x) <= 102, colorRampPalette(c("transparent", "indianred4"))(100)[90],
                                                         ifelse(as.numeric(x) <= 106, colorRampPalette(c("transparent", "indianred4"))(100)[95],
                                                         ifelse(as.numeric(x) <= 110, colorRampPalette(c("transparent", "indianred4"))(100)[100]))))))))))))))))))))))

NEI_red <- formatter("span",
                  style = x ~ style(display = "inline-block", color = "black","border-radius" = "4px",
                                    "padding-right" = "0px", "padding-left" = "0px", width = "90px", margin = "0px",  
                                    "background-color" = ifelse(as.numeric(x) <= 1.5, colorRampPalette(c("transparent", "indianred4"))(100)[5],
                                                         ifelse(as.numeric(x) <= 3, colorRampPalette(c("transparent", "indianred4"))(100)[10],
                                                         ifelse(as.numeric(x) <= 4.5, colorRampPalette(c("transparent", "indianred4"))(100)[15],
                                                         ifelse(as.numeric(x) <= 6, colorRampPalette(c("transparent", "indianred4"))(100)[20],
                                                         ifelse(as.numeric(x) <= 7.5, colorRampPalette(c("transparent", "indianred4"))(100)[25],
                                                         ifelse(as.numeric(x) <= 9, colorRampPalette(c("transparent", "indianred4"))(100)[30],
                                                         ifelse(as.numeric(x) <= 10.5, colorRampPalette(c("transparent", "indianred4"))(100)[35],
                                                         ifelse(as.numeric(x) <= 12, colorRampPalette(c("transparent", "indianred4"))(100)[40],
                                                         ifelse(as.numeric(x) <= 13.5, colorRampPalette(c("transparent", "indianred4"))(100)[45],
                                                         ifelse(as.numeric(x) <= 15, colorRampPalette(c("transparent", "indianred4"))(100)[50],
                                                         ifelse(as.numeric(x) <= 16.5, colorRampPalette(c("transparent", "indianred4"))(100)[55],
                                                         ifelse(as.numeric(x) <= 18, colorRampPalette(c("transparent", "indianred4"))(100)[60],
                                                         ifelse(as.numeric(x) <= 19.5, colorRampPalette(c("transparent", "indianred4"))(100)[65],
                                                         ifelse(as.numeric(x) <= 21, colorRampPalette(c("transparent", "indianred4"))(100)[70],
                                                         ifelse(as.numeric(x) <= 22.5, colorRampPalette(c("transparent", "indianred4"))(100)[75],
                                                         ifelse(as.numeric(x) <= 24, colorRampPalette(c("transparent", "indianred4"))(100)[80],
                                                         ifelse(as.numeric(x) <= 25.5, colorRampPalette(c("transparent", "indianred4"))(100)[85],
                                                         ifelse(as.numeric(x) <= 27, colorRampPalette(c("transparent", "indianred4"))(100)[90],
                                                         ifelse(as.numeric(x) <= 28.5, colorRampPalette(c("transparent", "indianred4"))(100)[95],
                                                         ifelse(as.numeric(x) <= 30, colorRampPalette(c("transparent", "indianred4"))(100)[100]))))))))))))))))))))))

Region_label <- formatter("span",
                  style = x ~ style(display = "inline-block", color = "black","border-radius" = "4px",
                                    "padding-right" = "4px", width = "160px"))
Monsoon_area_label <- formatter("span",
                  style = x ~ style(display = "inline-block", color = "black","border-radius" = "4px",
                                    "padding-right" = "4px", width = "90px"))

# Rearrange regions
N_descriptive_summary_2 <- N_descriptive_summary[c(1,3,5,6,2,4,7),]
N_descriptive_summary_2[which(N_descriptive_summary_2$Region == "Nepal Terai"),"Region"] <- "Terai of Nepal"
N_descriptive_summary_2[which(N_descriptive_summary_2$Region == "Bangladesh floodplains"),"Region"] <- "Bangladesh's floodplains"

# Making nice table                  
Figure1a <- formattable(N_descriptive_summary_2,
            col.names = c("Region",
                          "Monsoon<br>rice area<br>(million ha)",
                          paste0("Mean N<br>fertilizer<br>(kg ha","\U207B","\U00B9",")"),
                          paste0("Mean rice<br>yield<br>(t ha","\U207B","\U00B9",")"),
                          paste0("NUE<br>(kg rice<br>kg","\U207B","\U00B9"," N)"),
                          paste0("N surplus per<br>planted area<br>(kg ha","\U207B","\U00B9",")"),
                          paste0("N surplus per<br>rice harvested<br>(kg t","\U207B","\U00B9",")")),
            row.names = F,
            align = "c",
            list(
              Region = Region_label,
              Monsoon_area_million_ha = Monsoon_area_label,
              Yield_t_ha = Yield_green,
              N_kg_ha = Nrate_orange,
              N_PFP = PFP_green,
              N_surplus = Nsurplus_red,
              laymansNEI = NEI_red
            ))

# save table
setwd('[insert working directory]')

export_formattable <- function(f, file, width = "80%", height = 800, 
                               background = "white", delay = 0.2, zoom = 15)
    {
      w <- as.htmlwidget(f, width = width, height = height)
      path <- html_print(w, background = background, viewer = NULL)
      url <- paste0("file:///", gsub("\\\\", "/", normalizePath(path)))
      webshot(url,
              file = file,
              selector = ".formattable_widget",
              delay = delay,
              zoom = zoom)
    }

export_formattable(Figure1a,"Figure1a.png")


```

2.4) Comparing nitrogen outcomes across regions (Figure 1b)

```{r}
library(gridExtra)
library(grid)

regs$Region_figurename2 <- regs$Region_figurename
regs[which(regs$Region == "Bihar"), "Region_figurename2"] <- "Bihar & eastern Uttar Pradesh"

# Annotated plot
nib6$yield_t_ha <- nib6$yield_kg_ha / 1000
for(i in 1:nrow(regs)){  
density_plot <- ggplot(nib6[which(nib6$Region == regs[i,"Region"]),], aes(x = N_kg_ha, y =  yield_t_ha)) +
  annotate("rect", ymin = 0, ymax = 5,
                  xmin = 113, 
                  xmax = 300,
                  fill = "red", alpha = 0.1) +
  annotate("text", x = 45, y = 9,
          label = "Low-input\nHigh-output" , color="black",
          size=3.5, fontface="bold") +
  annotate("text", x = 255, y = 9,
          label = "High-input\nHigh-output" , color="black",
          size=3.5, fontface="bold") +
  annotate("text", x = 45, y = 1,
          label = "Low-input\nLow-output" , color="black",
          size=3.5, fontface="bold") +
  annotate("text", x = 255, y = 1,
          label = "High-input\nLow-output" , color="dark red",
          size=3.5, fontface="bold") +
  geom_point(mapping = aes(x = N_kg_ha, y = yield_t_ha), color = 'grey', alpha=0.4) +
  stat_density_2d(aes(fill = ..level..), geom = "polygon") +
  scale_fill_continuous(type = "viridis") +
  theme_bw() +
  theme(legend.position="none",
  axis.title.x=element_blank(),
  axis.title.y=element_blank()) +
  geom_vline(xintercept = 113) +
  geom_hline(yintercept = 5) +
  labs(title = regs[i,"Region_figurename2"]) +
  theme(plot.title = element_text(size=16),
        axis.text.x = element_text(size=11),
        axis.text.y = element_text(size=11)) +
  scale_x_continuous(limits = c(0,300), expand = c(0, 0)) +
  scale_y_continuous(breaks = c(0,2,4,6,8,10), limits = c(0,10), expand = c(0, 0))
assign(paste(regs[i,"Region"], "_", "density_plot_annotated", sep = ""), density_plot)
}

# comparison_plot_annotated_unexplained
(Figure1b <- grid.arrange(AP_density_plot_annotated,
             Bihar_density_plot_annotated,
             Odisha_density_plot_annotated,
             Punjab_Haryana_density_plot_annotated,
             Bangladesh_density_plot_annotated,
             Nepal_density_plot_annotated,
             ncol=3, 
             bottom = textGrob(paste0("Nitrogen application rate (kg ha","\U207B","\U00B9",")"),
                               gp = gpar(fontsize = 16)),
             left = textGrob(paste0("Rice yield (t ha","\U207B","\U00B9",")"),
                               rot = 90, gp = gpar(fontsize = 16))
             ))


# save table
setwd('[insert working directory]')
ggsave(filename = "Figure1b.png", plot = Figure1b, width = 10, height = 6, units = "in", dpi = 400)

```

2.5) Get mean and standard error for each variable in Figure 1a (Table S1 in Supplementary Information 1)

```{r}
library("plotrix")

# Make region variable a factor
nib6$Region_factor_neat <- nib6$Region
for(i in 1:nrow(regs)){
  nib6[which(nib6$Region == regs[i,"Region"]), "Region_factor_neat"] <- regs[i,"Region_figurename"]
}
nib6$Region_factor_neat <- as.factor(nib6$Region_factor_neat)

# Convert units
nib6$N_surplus_kg_ha <- nib6$N_balance_ladha
nib6$NUE_kg_ha <- nib6$NUE_excl_deposition
nib6$NEI_kg_t <- nib6$laymansNEI_ladha * 1000 # convert kg to t

# Define variables of interest
continuous_vars <- c(
  "N_kg_ha",
  "yield_t_ha",
  "NUE_excl_deposition", # NUE defined as N partial factor productivity
  "N_surplus_kg_ha", # N surplus per ha, defined using assumptions in Ladha et al. (2016)
  "NEI_kg_t" # N surplus per yield, defined using assumptions in Ladha et al. (2016)
  )

categorical_var <- "Region_factor_neat"

# Define desired table for standard error
standard_error_table <- data.frame(regs$Region)
colnames(standard_error_table)[1] <- "Region"
for(i in 1:length(continuous_vars)){
standard_error_table[,paste0(continuous_vars[i], "_mean")] <- NA
standard_error_table[,paste0(continuous_vars[i], "_SE")] <- NA}

# Populate desired table
for(i in 1:length(continuous_vars)){
for(j in 1:nrow(standard_error_table)){
standard_error_table[j,paste0(continuous_vars[i], "_mean")] <- round(
  mean(nib6[which(nib6$Region == standard_error_table[j,"Region"]),
            continuous_vars[i]]), 1)
standard_error_table[j,paste0(continuous_vars[i], "_SE")] <- round(
  std.error(nib6[which(nib6$Region == standard_error_table[j,"Region"]),
            continuous_vars[i]]), 2)
}}

standard_error_table_neat <- standard_error_table
standard_error_table_neat$Region <- regs[,"Region_figurename"]
standard_error_table_neat <- standard_error_table_neat[c(1,3,5,6,2,4),]

library('stringr')
setwd("[insert working directory]")
timedatenow <- Sys.time()
timedatenow <- str_replace_all(timedatenow,"-","_")
timedatenow <- str_replace_all(timedatenow,":","_")
timedatenow <- str_replace_all(timedatenow," ","__")
write.csv(standard_error_table_neat, paste("standard_error_table_neat__",timedatenow, ".csv"))

```

2.6) Testing statistical signficance of regional differences for each variable in Figure 1a (Table S2 in Supplementary Information 1)

```{r}
library(multcomp)
library(broom)

# Populate desired table
for (i in 1:length(continuous_vars)) {

  # Fit linear model
  formula <- as.formula(paste(continuous_vars[i], "~", categorical_var))
  model <- lm(formula, data = nib6)
  
  # Perform Tukey's HSD test
  tukey_test <- glht(model, linfct = mcp(Region_factor_neat = "Tukey"))
  tukey_summary <- summary(tukey_test)
 
add_stars <- function(estimate, p_value) {
  formatted_estimate <- format(round(estimate, 1), nsmall = 1)  # Format estimate with 1 decimal place
  if (p_value < 0.001) {
    return(paste0(formatted_estimate, "***"))
  } else if (p_value < 0.01) {
    return(paste0(formatted_estimate, "**"))
  } else if (p_value < 0.05) {
    return(paste0(formatted_estimate, "*"))
  } else {
    return(formatted_estimate)  # Return formatted estimate without asterisks
  }
}

# Create a neat table with only the contrast and modified estimates
tukey_results <- tidy(tukey_summary)
neat_tukey_results <- tukey_results %>%
  dplyr::select(contrast, estimate, adj.p.value) %>%
  dplyr::mutate(estimate = mapply(add_stars, estimate, adj.p.value)) %>%
  dplyr::select(contrast, estimate)  # Only keep contrast and modified estimate

assign(paste0("tukey_", continuous_vars[i]), neat_tukey_results)
}

tukey_full <- tukey_N_kg_ha[,1]
colnames(tukey_full)[1] <- "Comparison"
for(i in 1:length(continuous_vars)){
tukey_full[,continuous_vars[i]] <- get(paste0("tukey_", continuous_vars[i]))[,"estimate"]
}

library('stringr')
setwd("[insert working directory]")
timedatenow <- Sys.time()
timedatenow <- str_replace_all(timedatenow,"-","_")
timedatenow <- str_replace_all(timedatenow,":","_")
timedatenow <- str_replace_all(timedatenow," ","__")
write.csv(tukey_full, paste("tukey_full__",timedatenow, ".csv"))

```

2.7) Clarifying sample size within different combinations of N rate and region (Table S3 in Supplementary Information 3)

```{r}
# Clarifying sample size within each N rate range
Sample_size_across_Nrates <- data.frame(regs[,"Region"])
colnames(Sample_size_across_Nrates)[1] <- "Region"
Sample_size_across_Nrates$N_0to50_kg_ha <- NA
Sample_size_across_Nrates$N_50to100_kg_ha <- NA
Sample_size_across_Nrates$N_100to150_kg_ha <- NA
Sample_size_across_Nrates$N_150to200_kg_ha <- NA
Sample_size_across_Nrates$N_200to400_kg_ha <- NA
Sample_size_across_Nrates$total_samples <- NA
for(i in 1:nrow(Sample_size_across_Nrates)){
Sample_size_across_Nrates[i,"N_0to50_kg_ha"] <- paste0(
  round(
  length(which(nib6$Region == Sample_size_across_Nrates[i,"Region"] &
           nib6$N_kg_ha < 50)) /
    length(which(nib6$Region == Sample_size_across_Nrates[i,"Region"])) *
    100, 1), "%")
Sample_size_across_Nrates[i,"N_50to100_kg_ha"] <- paste0(
  round(
  length(which(nib6$Region == Sample_size_across_Nrates[i,"Region"] &
           nib6$N_kg_ha >= 50 & nib6$N_kg_ha <100)) /
    length(which(nib6$Region == Sample_size_across_Nrates[i,"Region"])) *
    100, 1), "%")
Sample_size_across_Nrates[i,"N_100to150_kg_ha"] <- paste0(
  round(
  length(which(nib6$Region == Sample_size_across_Nrates[i,"Region"] &
           nib6$N_kg_ha >= 100 & nib6$N_kg_ha <150)) /
    length(which(nib6$Region == Sample_size_across_Nrates[i,"Region"])) *
    100, 1), "%")
Sample_size_across_Nrates[i,"N_150to200_kg_ha"] <- paste0(
  round(
  length(which(nib6$Region == Sample_size_across_Nrates[i,"Region"] &
           nib6$N_kg_ha >= 150 & nib6$N_kg_ha <=200)) /
    length(which(nib6$Region == Sample_size_across_Nrates[i,"Region"])) *
    100, 1), "%")
Sample_size_across_Nrates[i,"N_200to400_kg_ha"] <- paste0(
  round(
  length(which(nib6$Region == Sample_size_across_Nrates[i,"Region"] &
           nib6$N_kg_ha > 200)) /
    length(which(nib6$Region == Sample_size_across_Nrates[i,"Region"])) *
    100, 1), "%")
Sample_size_across_Nrates[i,"total_samples"] <- length(which(nib6$Region == Sample_size_across_Nrates[i,"Region"]))
}
Sample_size_across_Nrates$Region <- regs[,"Region_figurename"]

library('stringr')
setwd("[insert working directory]")
timedatenow <- Sys.time()
timedatenow <- str_replace_all(timedatenow,"-","_")
timedatenow <- str_replace_all(timedatenow,":","_")
timedatenow <- str_replace_all(timedatenow," ","__")
write.csv(Sample_size_across_Nrates, paste("Sample_size_across_Nrates__",timedatenow, ".csv"))
```

2.8) Modelling average NUE for any given nitrogen rate in each region (Figure S1 in Supplementary Information 2)

```{r}
library(tidyverse)
library(npreg)
library(readxl)
library(MASS)

# Applying additional data exclusion criteria defined and explained in section 4.2 of methods
min_Nrate_0 <- 0
min_Nrate_50 <- 50
max_Nrate_tight <- 200
min_yield_tight <- 500
max_yield_tight <- 10000

## Individual regions
for(i in 1:nrow(regs)){
working_data <- nib6[which(nib6$Region == regs[i,"Region"] & 
                           nib6$N_kg_ha >= min_Nrate_50 &
                           nib6$N_kg_ha <= max_Nrate_tight &
                           nib6$yield_kg_ha >= min_yield_tight &
                           nib6$yield_kg_ha <= max_yield_tight),] 

if(regs[i,"Region"] == "Punjab_Haryana"){
working_data <- working_data[-which(working_data$N_kg_ha < 100),]}
if(regs[i,"Region"] == "Odisha"){
working_data <- working_data[-which(working_data$N_kg_ha > 150),]}


plot(PFPn ~ N_kg_ha, data = working_data, ylim=c(0,150),xlim=c(50,200),
     main = paste0(regs[i,"Region_figurename"]),
     xlab = "Nitrogen rate (kg/ha)",
     ylab = "NUE (rice kg / N kg)")
central_tendency_spline <- ss(working_data$N_kg_ha, working_data$PFPn, method = "OCV")
lines(central_tendency_spline, lty = 1, col = "red")
assign(paste0("CTspline_","PFPvsN_",regs[i,"Region"]),central_tendency_spline)
}
```


2.9) Modelling 'frontier' NUE for any given nitrogen rate in each region (Figure 2)


```{r}
library(gridExtra)
library(ggplot2)
library(tidyverse)
library(splines)
library(ggplotFL)

regs$colour <- NA
regs[which(regs[,1] == "AP"),"colour"] <- 'dark grey'
regs[which(regs[,1] == "Bangladesh"),"colour"] <- 'seagreen'
regs[which(regs[,1] == "Bihar"),"colour"] <- 'red'
regs[which(regs[,1] == "Nepal"),"colour"] <- 'orchid'
regs[which(regs[,1] == "Odisha"),"colour"] <- 'blue'
regs[which(regs[,1] == "Punjab_Haryana"),"colour"] <- 'orange'


# Categorize N rate in 10 kg/ha increments

tags_Nrate <- c(
  "[0-10)",
  "[10-20)",
  "[20-30)",
  "[30-40)",
  "[40-50)",
  "[50-60)",
  "[60-70)",
  "[70-80)",
  "[80-90)",
  "[90-100)",
  "[100-110)",
  "[110-120)", 
  "[120-130)", 
  "[130-140)", 
  "[140-150)", 
  "[150-160)",
  "[160-170)", 
  "[170-180)", 
  "[180-190)",
  "[190-200)", 
  "[200-210)",
  "[210-220)",
  "[220-230)",
  "[230-240)",
  "[240-250)",
  "[250-260)",
  "[260-270)",
  "[270-280)",
  "[280-290)",
  "[290-300)",
  "[300-310)",
  "[310-320)", 
  "[320-330)", 
  "[330-340)", 
  "[340-350)", 
  "[350-360)",
  "[360-370)", 
  "[370-380)", 
  "[380-390)",
  "[390-400)" 
  )

library (tidyverse)
nib6_Nratebinned <- as_tibble(nib6) %>%
  mutate(tagging = case_when(
    N_kg_ha >= 0 & N_kg_ha < 10 ~ tags_Nrate[1],
    N_kg_ha >= 10 & N_kg_ha < 20 ~ tags_Nrate[2],
    N_kg_ha >= 20 & N_kg_ha < 30 ~ tags_Nrate[3],
    N_kg_ha >= 30 & N_kg_ha < 40 ~ tags_Nrate[4],
    N_kg_ha >= 40 & N_kg_ha < 50 ~ tags_Nrate[5],
    N_kg_ha >= 50 & N_kg_ha < 60 ~ tags_Nrate[6],
    N_kg_ha >= 60 & N_kg_ha < 70 ~ tags_Nrate[7],
    N_kg_ha >= 70 & N_kg_ha < 80 ~ tags_Nrate[8],
    N_kg_ha >= 80 & N_kg_ha < 90 ~ tags_Nrate[9],
    N_kg_ha >= 90 & N_kg_ha < 100 ~ tags_Nrate[10],
    N_kg_ha >= 100 & N_kg_ha < 110 ~ tags_Nrate[11],
    N_kg_ha >= 110 & N_kg_ha < 120 ~ tags_Nrate[12],
    N_kg_ha >= 120 & N_kg_ha < 130 ~ tags_Nrate[13],
    N_kg_ha >= 130 & N_kg_ha < 140 ~ tags_Nrate[14],
    N_kg_ha >= 140 & N_kg_ha < 150 ~ tags_Nrate[15],
    N_kg_ha >= 150 & N_kg_ha < 160 ~ tags_Nrate[16],
    N_kg_ha >= 160 & N_kg_ha < 170 ~ tags_Nrate[17],
    N_kg_ha >= 170 & N_kg_ha < 180 ~ tags_Nrate[18],
    N_kg_ha >= 180 & N_kg_ha < 190 ~ tags_Nrate[19],
    N_kg_ha >= 190 & N_kg_ha < 200 ~ tags_Nrate[20],
    N_kg_ha >= 200 & N_kg_ha < 210 ~ tags_Nrate[21],
    N_kg_ha >= 210 & N_kg_ha < 220 ~ tags_Nrate[22],
    N_kg_ha >= 220 & N_kg_ha < 230 ~ tags_Nrate[23],
    N_kg_ha >= 230 & N_kg_ha < 240 ~ tags_Nrate[24],
    N_kg_ha >= 240 & N_kg_ha < 250 ~ tags_Nrate[25],
    N_kg_ha >= 250 & N_kg_ha < 260 ~ tags_Nrate[26],
    N_kg_ha >= 260 & N_kg_ha < 270 ~ tags_Nrate[27],
    N_kg_ha >= 270 & N_kg_ha < 280 ~ tags_Nrate[28],
    N_kg_ha >= 280 & N_kg_ha < 290 ~ tags_Nrate[29],
    N_kg_ha >= 290 & N_kg_ha < 300 ~ tags_Nrate[30],
    N_kg_ha >= 300 & N_kg_ha < 310 ~ tags_Nrate[31],
    N_kg_ha >= 310 & N_kg_ha < 320 ~ tags_Nrate[32],
    N_kg_ha >= 320 & N_kg_ha < 330 ~ tags_Nrate[33],
    N_kg_ha >= 330 & N_kg_ha < 340 ~ tags_Nrate[34],
    N_kg_ha >= 340 & N_kg_ha < 350 ~ tags_Nrate[35],
    N_kg_ha >= 350 & N_kg_ha < 360 ~ tags_Nrate[36],
    N_kg_ha >= 360 & N_kg_ha < 370 ~ tags_Nrate[37],
    N_kg_ha >= 370 & N_kg_ha < 380 ~ tags_Nrate[38],
    N_kg_ha >= 380 & N_kg_ha < 390 ~ tags_Nrate[39],
    N_kg_ha >= 390 & N_kg_ha < 400 ~ tags_Nrate[40],
    ))
nib6$tag_Nrate <- factor(nib6_Nratebinned$tagging,
                       levels = tags_Nrate,
                       ordered = FALSE)



## Finding 25th, 50th and 75th percentile farmers
q = c(.25, .5, .75, 0.9, 0.33, 0.66)

for( i in 1:nrow(regs)){
working_data <- nib6[which(nib6$Region == regs[i,"Region"] & 
                           nib6$N_kg_ha >= min_Nrate_50 &
                           nib6$N_kg_ha <= max_Nrate_tight &
                           nib6$yield_kg_ha >= min_yield_tight &
                           nib6$yield_kg_ha <= max_yield_tight),]

if(i == 6){
working_data <- working_data[-which(working_data$N_kg_ha < 100),]}
if(i == 5){
working_data <- working_data[-which(working_data$N_kg_ha > 150),]}

frontiers <- data.frame(tags_Nrate)
colnames(frontiers)[1] <- "tag_Nrate"
frontiers$quant25 <- NA
frontiers$quant50 <- NA
frontiers$quant75 <- NA
frontiers$quant90 <- NA
frontiers$quant33 <- NA
frontiers$quant66 <- NA


for(y in 1:nrow(frontiers)){
frontiers[y,"quant25"] <- quantile(working_data[which(working_data$tag_Nrate == frontiers[y,"tag_Nrate"]),"PFPn"], probs = q[1])
frontiers[y,"quant50"] <- quantile(working_data[which(working_data$tag_Nrate == frontiers[y,"tag_Nrate"]),"PFPn"], probs = q[2])
frontiers[y,"quant75"] <- quantile(working_data[which(working_data$tag_Nrate == frontiers[y,"tag_Nrate"]),"PFPn"], probs = q[3])
frontiers[y,"quant90"] <- quantile(working_data[which(working_data$tag_Nrate == frontiers[y,"tag_Nrate"]),"PFPn"], probs = q[4])
frontiers[y,"quant33"] <- quantile(working_data[which(working_data$tag_Nrate == frontiers[y,"tag_Nrate"]),"PFPn"], probs = q[5])
frontiers[y,"quant66"] <- quantile(working_data[which(working_data$tag_Nrate == frontiers[y,"tag_Nrate"]),"PFPn"], probs = q[6])

}
frontiers <- frontiers[rowSums(is.na(frontiers[,2:5])) != ncol(frontiers[,2:5]), ] # remove rows that have all NAs

colnames(frontiers)<-c("N.bin", "PFPn.Q25", "PFPn.Q50", "PFPn.Q75", "PFPn.Q90","PFPn.Q33","PFPn.Q66")

if(i < 5){
frontiers$N.seq <- seq(55,200, by = 10)}
if(regs[i,"Region"] == "Punjab_Haryana"){
frontiers$N.seq <- seq(105,200, by = 10)}
if(regs[i,"Region"] == "Odisha"){
frontiers$N.seq <- seq(55,150, by = 10)}

frontier_spline_q25 <- ss(frontiers$N.seq, frontiers$PFPn.Q25, method = "OCV")
# plot(frontiers$N.seq, frontiers$PFPn.Q25, main = regs[i,1], ylim = c(0,150), ylab="PFPn", xlab="N-rate (kg/ha)")
# lines(frontier_spline_q25, lty=1, col = regs[i,"colour"])
assign(paste0(regs[i,1],"_frontiers"), frontiers)
assign(paste0(regs[i,1],"_frontier_spline_q25"), frontier_spline_q25)

frontier_spline_q50 <- ss(frontiers$N.seq, frontiers$PFPn.Q50, method = "OCV")
# plot(frontiers$N.seq, frontiers$PFPn.Q50, main = regs[i,1], ylim = c(0,150), ylab="PFPn", xlab="N-rate (kg/ha)")
# lines(frontier_spline_q50, lty=1, col = regs[i,"colour"])
assign(paste0(regs[i,1],"_frontiers"), frontiers)
assign(paste0(regs[i,1],"_frontier_spline_q50"), frontier_spline_q50)


frontier_spline_q75 <- ss(frontiers$N.seq, frontiers$PFPn.Q75, method = "OCV")
# plot(frontiers$N.seq, frontiers$PFPn.Q75, main = regs[i,1], ylim = c(0,150), ylab="PFPn", xlab="N-rate (kg/ha)")
# lines(frontier_spline_q75, lty=1, col = regs[i,"colour"])
assign(paste0(regs[i,1],"_frontiers"), frontiers)
assign(paste0(regs[i,1],"_frontier_spline_q75"), frontier_spline_q75)

frontier_spline_q90 <- ss(frontiers$N.seq, frontiers$PFPn.Q90, method = "OCV")
# plot(frontiers$N.seq, frontiers$PFPn.Q90, main = regs[i,1], ylim = c(0,150), ylab="PFPn", xlab="N-rate (kg/ha)")
# lines(frontier_spline_q90, lty=1, col = regs[i,"colour"])
assign(paste0(regs[i,1],"_frontiers"), frontiers)
assign(paste0(regs[i,1],"_frontier_spline_q90"), frontier_spline_q90)

frontier_spline_q33 <- ss(frontiers$N.seq, frontiers$PFPn.Q33, method = "OCV")
# plot(frontiers$N.seq, frontiers$PFPn.Q33, main = regs[i,1], ylim = c(0,150), ylab="PFPn", xlab="N-rate (kg/ha)")
# lines(frontier_spline_q33, lty=1, col = regs[i,"colour"])
assign(paste0(regs[i,1],"_frontiers"), frontiers)
assign(paste0(regs[i,1],"_frontier_spline_q33"), frontier_spline_q33)

frontier_spline_q66 <- ss(frontiers$N.seq, frontiers$PFPn.Q66, method = "OCV")
# plot(frontiers$N.seq, frontiers$PFPn.Q66, main = regs[i,1], ylim = c(0,150), ylab="PFPn", xlab="N-rate (kg/ha)")
# lines(frontier_spline_q66, lty=1, col = regs[i,"colour"])
assign(paste0(regs[i,1],"_frontiers"), frontiers)
assign(paste0(regs[i,1],"_frontier_spline_q66"), frontier_spline_q66)

}

# Addressing overfitting for Odisha and Nepal frontier spline
Nepal_frontier_spline_q75 <- ss(Nepal_frontiers$N.seq, Nepal_frontiers$PFPn.Q75, df = 3)
Odisha_frontier_spline_q75 <- ss(Odisha_frontiers$N.seq, Odisha_frontiers$PFPn.Q75, df = 3)

# ggplotting
nib6$figure_colour <- "Unassigned"
for(i in 1:nrow(regs)){
nib6[which(nib6$Region == regs[i,"Region"]),"figure_colour"] <- regs[i,"colour"]
}

nib6$N.seq <- nib6$N_kg_ha
nib6$PFPn_Q50potential_givenNrate <- NA
nib6$PFPn_Q75potential_givenNrate <- NA
nib6$PFPn_Q90potential_givenNrate <- NA

## CT
for(i in 1:nrow(regs)){
predictable_rows <- which(nib6$Region == regs[i,"Region"] & 
                           nib6$N.seq >= min_Nrate_50 &
                           nib6$N.seq <= max_Nrate_tight &
                           nib6$yield_kg_ha >= min_yield_tight &
                           nib6$yield_kg_ha <= max_yield_tight)
working_model <- get(paste0("CTspline_PFPvsN_",regs[i,"Region"]))
working_prediction <- as.data.frame(predict(working_model, nib6[predictable_rows,"N.seq"]))
nib6[predictable_rows,"CT_PFPn_potential_givenNrate"] <- working_prediction$y
}


## Q75
for(i in 1:nrow(regs)){
predictable_rows <- which(nib6$Region == regs[i,"Region"] & 
                           nib6$N.seq >= min_Nrate_50 &
                           nib6$N.seq <= max_Nrate_tight &
                           nib6$yield_kg_ha >= min_yield_tight &
                           nib6$yield_kg_ha <= max_yield_tight)
working_model <- get(paste0(regs[i,"Region"],"_frontier_spline_q75"))
working_prediction <- as.data.frame(predict(working_model, nib6[predictable_rows,"N.seq"]))
nib6[predictable_rows,"Q75PFPn_potential_givenNrate"] <- working_prediction$y
}

## Putting together
nib_frontier_plot_data <- nib6 
nib_frontier_plot_data <- nib_frontier_plot_data[which(nib6$N.seq >= min_Nrate_50 &
                           nib6$N.seq <= max_Nrate_tight &
                           nib6$yield_kg_ha >= min_yield_tight &
                           nib6$yield_kg_ha <= max_yield_tight),]
nib_frontier_plot_data <- nib_frontier_plot_data[-which(nib_frontier_plot_data$Region == "Odisha" & nib_frontier_plot_data$N.seq >= 150),] 
nib_frontier_plot_data <- nib_frontier_plot_data[-which(nib_frontier_plot_data$Region == "Punjab_Haryana" & nib_frontier_plot_data$N.seq <= 100),] 

# Add proper region names
for(i in 1:nrow(regs)){
Region <- regs[i,"Region"]
nib_frontier_plot_data[which(nib_frontier_plot_data$Region == Region), "Region"] <- regs[i,"Region_figurename2"]
}
  
# Figure 2
Figure2 <- ggplot() +
  xlim(c(50,200)) +
  ylim(c(0,100)) +
  theme_bw() +
  geom_line(data = nib_frontier_plot_data, aes(x = N.seq, y = Q75PFPn_potential_givenNrate, color = Region), linetype = 'longdash', size = 1.5) +
  geom_line(data = nib_frontier_plot_data, aes(x = N.seq, y = CT_PFPn_potential_givenNrate, color = Region), linetype = 'solid', size = 1.5) +
  # scale_color_manual(values = regs$colour) +
  ggtitle("") +
  labs(y = paste0("Nitrogen use efficiency (kg rice kg","\U207B","\U00B9"," N)"),
       x = paste0("Nitrogen application rate (kg ha","\U207B","\U00B9",")")) +
  guides(fill = guide_legend(byrow = TRUE)) +
  theme(legend.position = c(0.78, 0.8), axis.text=element_text(size=14), axis.title=element_text(size=19),
        legend.text=element_text(size=19), legend.title=element_text(size=19)) +
  scale_color_manual(name="Region", values = c("Punjab & Haryana" = "blue","Andhra Pradesh" = "dark grey","Bangladesh's floodplains" = 'seagreen',"Odisha" = "orchid",  "Terai of Nepal" = 'orange', "Bihar & eastern Uttar Pradesh" = "red"))

setwd('[insert working directory]')
ggsave(filename = "Figure2.png", plot = Figure2, width = 10, height = 6, units = "in", dpi = 700)

```

2.10) Figure 2 without addressing overfitting in frontier splines for Odisha and Nepal (Figure S9 in Supplementary Information 10)

```{r}
library(gridExtra)
library(ggplot2)
library(tidyverse)
library(splines)
library(ggplotFL)

regs$colour <- NA
regs[which(regs[,1] == "AP"),"colour"] <- 'dark grey'
regs[which(regs[,1] == "Bangladesh"),"colour"] <- 'seagreen'
regs[which(regs[,1] == "Bihar"),"colour"] <- 'red'
regs[which(regs[,1] == "Nepal"),"colour"] <- 'orchid'
regs[which(regs[,1] == "Odisha"),"colour"] <- 'blue'
regs[which(regs[,1] == "Punjab_Haryana"),"colour"] <- 'orange'


# Categorize N rate in 10 kg/ha increments

tags_Nrate <- c(
  "[0-10)",
  "[10-20)",
  "[20-30)",
  "[30-40)",
  "[40-50)",
  "[50-60)",
  "[60-70)",
  "[70-80)",
  "[80-90)",
  "[90-100)",
  "[100-110)",
  "[110-120)", 
  "[120-130)", 
  "[130-140)", 
  "[140-150)", 
  "[150-160)",
  "[160-170)", 
  "[170-180)", 
  "[180-190)",
  "[190-200)", 
  "[200-210)",
  "[210-220)",
  "[220-230)",
  "[230-240)",
  "[240-250)",
  "[250-260)",
  "[260-270)",
  "[270-280)",
  "[280-290)",
  "[290-300)",
  "[300-310)",
  "[310-320)", 
  "[320-330)", 
  "[330-340)", 
  "[340-350)", 
  "[350-360)",
  "[360-370)", 
  "[370-380)", 
  "[380-390)",
  "[390-400)" 
  )

library (tidyverse)
nib6_Nratebinned <- as_tibble(nib6) %>%
  mutate(tagging = case_when(
    N_kg_ha >= 0 & N_kg_ha < 10 ~ tags_Nrate[1],
    N_kg_ha >= 10 & N_kg_ha < 20 ~ tags_Nrate[2],
    N_kg_ha >= 20 & N_kg_ha < 30 ~ tags_Nrate[3],
    N_kg_ha >= 30 & N_kg_ha < 40 ~ tags_Nrate[4],
    N_kg_ha >= 40 & N_kg_ha < 50 ~ tags_Nrate[5],
    N_kg_ha >= 50 & N_kg_ha < 60 ~ tags_Nrate[6],
    N_kg_ha >= 60 & N_kg_ha < 70 ~ tags_Nrate[7],
    N_kg_ha >= 70 & N_kg_ha < 80 ~ tags_Nrate[8],
    N_kg_ha >= 80 & N_kg_ha < 90 ~ tags_Nrate[9],
    N_kg_ha >= 90 & N_kg_ha < 100 ~ tags_Nrate[10],
    N_kg_ha >= 100 & N_kg_ha < 110 ~ tags_Nrate[11],
    N_kg_ha >= 110 & N_kg_ha < 120 ~ tags_Nrate[12],
    N_kg_ha >= 120 & N_kg_ha < 130 ~ tags_Nrate[13],
    N_kg_ha >= 130 & N_kg_ha < 140 ~ tags_Nrate[14],
    N_kg_ha >= 140 & N_kg_ha < 150 ~ tags_Nrate[15],
    N_kg_ha >= 150 & N_kg_ha < 160 ~ tags_Nrate[16],
    N_kg_ha >= 160 & N_kg_ha < 170 ~ tags_Nrate[17],
    N_kg_ha >= 170 & N_kg_ha < 180 ~ tags_Nrate[18],
    N_kg_ha >= 180 & N_kg_ha < 190 ~ tags_Nrate[19],
    N_kg_ha >= 190 & N_kg_ha < 200 ~ tags_Nrate[20],
    N_kg_ha >= 200 & N_kg_ha < 210 ~ tags_Nrate[21],
    N_kg_ha >= 210 & N_kg_ha < 220 ~ tags_Nrate[22],
    N_kg_ha >= 220 & N_kg_ha < 230 ~ tags_Nrate[23],
    N_kg_ha >= 230 & N_kg_ha < 240 ~ tags_Nrate[24],
    N_kg_ha >= 240 & N_kg_ha < 250 ~ tags_Nrate[25],
    N_kg_ha >= 250 & N_kg_ha < 260 ~ tags_Nrate[26],
    N_kg_ha >= 260 & N_kg_ha < 270 ~ tags_Nrate[27],
    N_kg_ha >= 270 & N_kg_ha < 280 ~ tags_Nrate[28],
    N_kg_ha >= 280 & N_kg_ha < 290 ~ tags_Nrate[29],
    N_kg_ha >= 290 & N_kg_ha < 300 ~ tags_Nrate[30],
    N_kg_ha >= 300 & N_kg_ha < 310 ~ tags_Nrate[31],
    N_kg_ha >= 310 & N_kg_ha < 320 ~ tags_Nrate[32],
    N_kg_ha >= 320 & N_kg_ha < 330 ~ tags_Nrate[33],
    N_kg_ha >= 330 & N_kg_ha < 340 ~ tags_Nrate[34],
    N_kg_ha >= 340 & N_kg_ha < 350 ~ tags_Nrate[35],
    N_kg_ha >= 350 & N_kg_ha < 360 ~ tags_Nrate[36],
    N_kg_ha >= 360 & N_kg_ha < 370 ~ tags_Nrate[37],
    N_kg_ha >= 370 & N_kg_ha < 380 ~ tags_Nrate[38],
    N_kg_ha >= 380 & N_kg_ha < 390 ~ tags_Nrate[39],
    N_kg_ha >= 390 & N_kg_ha < 400 ~ tags_Nrate[40],
    ))
nib6$tag_Nrate <- factor(nib6_Nratebinned$tagging,
                       levels = tags_Nrate,
                       ordered = FALSE)



## Finding 25th, 50th and 75th percentile farmers
q = c(.25, .5, .75, 0.9, 0.33, 0.66)

for( i in 1:nrow(regs)){
working_data <- nib6[which(nib6$Region == regs[i,"Region"] & 
                           nib6$N_kg_ha >= min_Nrate_50 &
                           nib6$N_kg_ha <= max_Nrate_tight &
                           nib6$yield_kg_ha >= min_yield_tight &
                           nib6$yield_kg_ha <= max_yield_tight),]

if(i == 6){
working_data <- working_data[-which(working_data$N_kg_ha < 100),]}
if(i == 5){
working_data <- working_data[-which(working_data$N_kg_ha > 150),]}

frontiers <- data.frame(tags_Nrate)
colnames(frontiers)[1] <- "tag_Nrate"
frontiers$quant25 <- NA
frontiers$quant50 <- NA
frontiers$quant75 <- NA
frontiers$quant90 <- NA
frontiers$quant33 <- NA
frontiers$quant66 <- NA


for(y in 1:nrow(frontiers)){
frontiers[y,"quant25"] <- quantile(working_data[which(working_data$tag_Nrate == frontiers[y,"tag_Nrate"]),"PFPn"], probs = q[1])
frontiers[y,"quant50"] <- quantile(working_data[which(working_data$tag_Nrate == frontiers[y,"tag_Nrate"]),"PFPn"], probs = q[2])
frontiers[y,"quant75"] <- quantile(working_data[which(working_data$tag_Nrate == frontiers[y,"tag_Nrate"]),"PFPn"], probs = q[3])
frontiers[y,"quant90"] <- quantile(working_data[which(working_data$tag_Nrate == frontiers[y,"tag_Nrate"]),"PFPn"], probs = q[4])
frontiers[y,"quant33"] <- quantile(working_data[which(working_data$tag_Nrate == frontiers[y,"tag_Nrate"]),"PFPn"], probs = q[5])
frontiers[y,"quant66"] <- quantile(working_data[which(working_data$tag_Nrate == frontiers[y,"tag_Nrate"]),"PFPn"], probs = q[6])

}
frontiers <- frontiers[rowSums(is.na(frontiers[,2:5])) != ncol(frontiers[,2:5]), ] # remove rows that have all NAs

colnames(frontiers)<-c("N.bin", "PFPn.Q25", "PFPn.Q50", "PFPn.Q75", "PFPn.Q90","PFPn.Q33","PFPn.Q66")

if(i < 5){
frontiers$N.seq <- seq(55,200, by = 10)}
if(regs[i,"Region"] == "Punjab_Haryana"){
frontiers$N.seq <- seq(105,200, by = 10)}
if(regs[i,"Region"] == "Odisha"){
frontiers$N.seq <- seq(55,150, by = 10)}

frontier_spline_q25 <- ss(frontiers$N.seq, frontiers$PFPn.Q25, method = "OCV")
# plot(frontiers$N.seq, frontiers$PFPn.Q25, main = regs[i,1], ylim = c(0,150), ylab="PFPn", xlab="N-rate (kg/ha)")
# lines(frontier_spline_q25, lty=1, col = regs[i,"colour"])
assign(paste0(regs[i,1],"_frontiers"), frontiers)
assign(paste0(regs[i,1],"_frontier_spline_q25"), frontier_spline_q25)

frontier_spline_q50 <- ss(frontiers$N.seq, frontiers$PFPn.Q50, method = "OCV")
# plot(frontiers$N.seq, frontiers$PFPn.Q50, main = regs[i,1], ylim = c(0,150), ylab="PFPn", xlab="N-rate (kg/ha)")
# lines(frontier_spline_q50, lty=1, col = regs[i,"colour"])
assign(paste0(regs[i,1],"_frontiers"), frontiers)
assign(paste0(regs[i,1],"_frontier_spline_q50"), frontier_spline_q50)


frontier_spline_q75 <- ss(frontiers$N.seq, frontiers$PFPn.Q75, method = "OCV")
# plot(frontiers$N.seq, frontiers$PFPn.Q75, main = regs[i,1], ylim = c(0,150), ylab="PFPn", xlab="N-rate (kg/ha)")
# lines(frontier_spline_q75, lty=1, col = regs[i,"colour"])
assign(paste0(regs[i,1],"_frontiers"), frontiers)
assign(paste0(regs[i,1],"_frontier_spline_q75"), frontier_spline_q75)

frontier_spline_q90 <- ss(frontiers$N.seq, frontiers$PFPn.Q90, method = "OCV")
# plot(frontiers$N.seq, frontiers$PFPn.Q90, main = regs[i,1], ylim = c(0,150), ylab="PFPn", xlab="N-rate (kg/ha)")
# lines(frontier_spline_q90, lty=1, col = regs[i,"colour"])
assign(paste0(regs[i,1],"_frontiers"), frontiers)
assign(paste0(regs[i,1],"_frontier_spline_q90"), frontier_spline_q90)

frontier_spline_q33 <- ss(frontiers$N.seq, frontiers$PFPn.Q33, method = "OCV")
# plot(frontiers$N.seq, frontiers$PFPn.Q33, main = regs[i,1], ylim = c(0,150), ylab="PFPn", xlab="N-rate (kg/ha)")
# lines(frontier_spline_q33, lty=1, col = regs[i,"colour"])
assign(paste0(regs[i,1],"_frontiers"), frontiers)
assign(paste0(regs[i,1],"_frontier_spline_q33"), frontier_spline_q33)

frontier_spline_q66 <- ss(frontiers$N.seq, frontiers$PFPn.Q66, method = "OCV")
# plot(frontiers$N.seq, frontiers$PFPn.Q66, main = regs[i,1], ylim = c(0,150), ylab="PFPn", xlab="N-rate (kg/ha)")
# lines(frontier_spline_q66, lty=1, col = regs[i,"colour"])
assign(paste0(regs[i,1],"_frontiers"), frontiers)
assign(paste0(regs[i,1],"_frontier_spline_q66"), frontier_spline_q66)

}

# ggplotting
nib6$figure_colour <- "Unassigned"
for(i in 1:nrow(regs)){
nib6[which(nib6$Region == regs[i,"Region"]),"figure_colour"] <- regs[i,"colour"]
}

nib6$N.seq <- nib6$N_kg_ha
nib6$PFPn_Q50potential_givenNrate <- NA
nib6$PFPn_Q75potential_givenNrate <- NA
nib6$PFPn_Q90potential_givenNrate <- NA

## CT
for(i in 1:nrow(regs)){
predictable_rows <- which(nib6$Region == regs[i,"Region"] & 
                           nib6$N.seq >= min_Nrate_50 &
                           nib6$N.seq <= max_Nrate_tight &
                           nib6$yield_kg_ha >= min_yield_tight &
                           nib6$yield_kg_ha <= max_yield_tight)
working_model <- get(paste0("CTspline_PFPvsN_",regs[i,"Region"]))
working_prediction <- as.data.frame(predict(working_model, nib6[predictable_rows,"N.seq"]))
nib6[predictable_rows,"CT_PFPn_potential_givenNrate"] <- working_prediction$y
}


## Q75
for(i in 1:nrow(regs)){
predictable_rows <- which(nib6$Region == regs[i,"Region"] & 
                           nib6$N.seq >= min_Nrate_50 &
                           nib6$N.seq <= max_Nrate_tight &
                           nib6$yield_kg_ha >= min_yield_tight &
                           nib6$yield_kg_ha <= max_yield_tight)
working_model <- get(paste0(regs[i,"Region"],"_frontier_spline_q75"))
working_prediction <- as.data.frame(predict(working_model, nib6[predictable_rows,"N.seq"]))
nib6[predictable_rows,"Q75PFPn_potential_givenNrate"] <- working_prediction$y
}

## Putting together
nib_frontier_plot_data <- nib6 
nib_frontier_plot_data <- nib_frontier_plot_data[which(nib6$N.seq >= min_Nrate_50 &
                           nib6$N.seq <= max_Nrate_tight &
                           nib6$yield_kg_ha >= min_yield_tight &
                           nib6$yield_kg_ha <= max_yield_tight),]
nib_frontier_plot_data <- nib_frontier_plot_data[-which(nib_frontier_plot_data$Region == "Odisha" & nib_frontier_plot_data$N.seq >= 150),] 
nib_frontier_plot_data <- nib_frontier_plot_data[-which(nib_frontier_plot_data$Region == "Punjab_Haryana" & nib_frontier_plot_data$N.seq <= 100),] 

# Add proper region names
for(i in 1:nrow(regs)){
Region <- regs[i,"Region"]
nib_frontier_plot_data[which(nib_frontier_plot_data$Region == Region), "Region"] <- regs[i,"Region_figurename2"]
}
  
# Figure
ggplot() +
  xlim(c(50,200)) +
  ylim(c(0,100)) +
  theme_bw() +
  geom_line(data = nib_frontier_plot_data, aes(x = N.seq, y = Q75PFPn_potential_givenNrate, color = Region), linetype = 'longdash', size = 1.5) +
  geom_line(data = nib_frontier_plot_data, aes(x = N.seq, y = CT_PFPn_potential_givenNrate, color = Region), linetype = 'solid', size = 1.5) +
  # scale_color_manual(values = regs$colour) +
  ggtitle("") +
  labs(y = paste0("Nitrogen use efficiency (kg rice / kg N)"),
       x = paste0("Nitrogen application rate (kg/ha)")) +
  guides(fill = guide_legend(byrow = TRUE)) +
  theme(legend.position = c(0.78, 0.8), axis.text=element_text(size=14), axis.title=element_text(size=19),
        legend.text=element_text(size=19), legend.title=element_text(size=19)) +
  scale_color_manual(name="Region", values = c("Punjab & Haryana" = "blue","Andhra Pradesh" = "dark grey","Bangladesh's floodplains" = 'seagreen',"Odisha" = "orchid",  "Terai of Nepal" = 'orange', "Bihar & eastern Uttar Pradesh" = "red"))


```

SECTION 3) Analysing potential to improve NUE of rice crops in South Asia  (see section 4.3 of methods)

3.1) Applying additional exclusion criteria defined in section 4.3

```{r}

# Adding N bin subsets
Nbins <- c("50to200","50to100","100to150","150to200")
Nbins <- as.data.frame(Nbins)
Nbins$Nmin <- c(50,50,100,150)
Nbins$Nmax <- c(200,100,150,200)

# Defining datasets
nib7 <- nib6
pred_dashboard_1 <- pred_dashboard_0

# Applying original data exclusion criteria defined in section 4.1 of methods
nib7 <- nib7[which(nib7$N_kg_ha >= min_Nrate_0 &
                           nib7$N_kg_ha <= max_Nrate_tight &
                           nib7$yield_kg_ha >= min_yield_tight &
                           nib7$yield_kg_ha <= max_yield_tight),]
```

3.2) Addressing predictor variables with missing data for random forest models predicting yield

```{r}

# Cutting rows with missing predictor data

## Look for missing data
pred_dashboard_1_missingTOTAL_nib7 <- pred_dashboard_1
pred_dashboard_1_missingPERC_nib7 <- pred_dashboard_1

for(i in 1:nrow(regs)){
working_data <- nib7[which(nib7$Region == regs[i,"Region"]),]
for(w in 1:nrow(pred_dashboard_1_missingTOTAL_nib7)){
predictor <- pred_dashboard_1_missingTOTAL_nib7[w,"potpreds"]
NA_total <- sum(is.na(working_data[,predictor])) + length(which(working_data[,predictor] == ""))
NA_perc <- round(NA_total / nrow(working_data) * 100,0)
pred_dashboard_1_missingTOTAL_nib7[w, regs[i,"Region"]] <- as.numeric(NA_total)
pred_dashboard_1_missingPERC_nib7[w, regs[i,"Region"]] <- as.numeric(NA_perc)
}}

## Cut rows where there is <15% missing data for a given predictor (as stipulated in section 4.3 of methods)
for(i in 1:nrow(regs)){
preds_to_save <- pred_dashboard_1_missingPERC_nib7[which(as.numeric(pred_dashboard_1_missingPERC_nib7[,regs[i,"Region"]]) < 15), "potpreds"]
for(w in 1:length(preds_to_save)){
specific_pred <- preds_to_save[w]
nib7 <- nib7[which(nib7$Region != regs[i,"Region"] | nib7$Region == regs[i,"Region"] & is.na(nib7[,specific_pred]) == F),]
nib7 <- nib7[which(nib7$Region != regs[i,"Region"] | nib7$Region == regs[i,"Region"] & nib7[,specific_pred] != ""),]
}}

# ## Cut rows where there is missing data for field duration or cropduraiton in Bangladesh
nib7 <- nib7[which(nib7$Region != "Bangladesh" | nib7$Region == "Bangladesh" & is.na(nib7[,"Crop_duration"]) == F),]
nib7 <- nib7[which(nib7$Region != "Bangladesh" | nib7$Region == "Bangladesh" & nib7[,"Crop_duration"] != ""),]
nib7 <- nib7[which(nib7$Region != "Bangladesh" | nib7$Region == "Bangladesh" & is.na(nib7[,"Field_duration"]) == F),]
nib7 <- nib7[which(nib7$Region != "Bangladesh" | nib7$Region == "Bangladesh" & nib7[,"Field_duration"] != ""),]


# Look for more missing data 
pred_dashboard_1_missingTOTAL_nib7 <- pred_dashboard_1
pred_dashboard_1_missingPERC_nib7 <- pred_dashboard_1

for(i in 1:nrow(regs)){
working_data <- nib7[which(nib7$Region == regs[i,"Region"]),]
for(w in 1:nrow(pred_dashboard_1_missingTOTAL_nib7)){
predictor <- pred_dashboard_1_missingTOTAL_nib7[w,"potpreds"]
NA_total <- sum(is.na(working_data[,predictor])) + length(which(working_data[,predictor] == ""))
NA_perc <- round(NA_total / nrow(working_data) * 100,0)
pred_dashboard_1_missingTOTAL_nib7[w, regs[i,"Region"]] <- NA_total
pred_dashboard_1_missingPERC_nib7[w, regs[i,"Region"]] <- NA_perc
}}

## Cut predictors where there is >15% missing data for a given predictor (as stipulated in section 4.3 of methods)
for(i in 1:nrow(regs)){
specific_pred_missingPERC <- pred_dashboard_1_missingPERC_nib7[,regs[i,"Region"]]
pred_dashboard_1[which(as.numeric(specific_pred_missingPERC) > 0), regs[i,"Region"]] <- "Missing_data"
pred_dashboard_1[,"Aggregated"] <- paste0(pred_dashboard_1[,"Aggregated"]," | ",pred_dashboard_1[,regs[i,"Region"]])
}
pred_dashboard_1[grep("Missing_data", pred_dashboard_1$Aggregated),"Aggregated"] <- "Missing_data"
pred_dashboard_1[-grep("Missing_data", pred_dashboard_1$Aggregated),"Aggregated"] <- "tbc"

```

3.3) Addressing predictor variables with low inference space for random forest models predicting yield

```{r}
library(summarytools)

pred_dashboard_2 <- pred_dashboard_1

# Extract highest frequency value for each predictor*region combination
pred_HighestFreqPerc <- pred_dashboard_2

# Remove predictors where more than 90% of data for the predictor shared the same value (as stipulated in section 4.3 of methods)

## Each region individually
for(i in 1:nrow(regs)){
for(y in 1:nrow(pred_dashboard_2)){

region <- regs[i,"Region"]
if(pred_dashboard_2[y,region] != "tbc") next # don't care if predictor already excluded for given region

frequency_table <- NA # blank slate
highest_freq <- NA # blank slate

working_data <- nib7[which(nib7$Region == region),]
highest_freq <- max(table(working_data[,pred_dashboard_2[y, "potpreds"]])) / nrow(working_data) * 100
pred_HighestFreqPerc[y,region] <- highest_freq

if(highest_freq < 90) next
pred_dashboard_2[y,region] <- paste("Low inference (", round(highest_freq,0), "%)", sep = "")
}}

## Aggregated
for(y in 1:nrow(pred_dashboard_2)){

if(pred_dashboard_2[y,"Aggregated"] != "tbc") next # don't care if predictor already excluded for given region

frequency_table <- NA # blank slate
highest_freq <- NA # blank slate
  
working_data <- nib7
highest_freq <- max(table(working_data[,pred_dashboard_2[y, "potpreds"]])) / nrow(working_data) * 100
pred_HighestFreqPerc[y,"Aggregated"] <- highest_freq


if(highest_freq < 90) next
pred_dashboard_2[y,"Aggregated"] <- paste("Low inference (", round(highest_freq,0), "%)", sep = "")
}


```

3.4) Addressing correlations between non-Nitrogen rate predictor variables for random forest models predicting yield

```{r}
library(gridExtra)
library(ggplot2)
library (tidyverse)

pred_dashboard_3 <- pred_dashboard_2

## Isolating numeric predictors
pred_cor <- pred_dashboard_3[which(pred_dashboard_3$class == "numeric" | pred_dashboard_3$class == "integer"),]

## Getting rid of "tbc"
for(i in 1:ncol(pred_cor)){
pred_cor[which(pred_cor[,i] == "tbc"),i] <- ""
}

## Making framework
for(i in 1:nrow(regs)){
for(j in 2:nrow(Nbins)){
  pred_cor[,paste0(regs[i,"Region"],"_",Nbins[j,"Nbins"])] <- pred_cor[,regs[i,"Region"]]
}}
pred_cor[,"Aggregated_50to100"] <- pred_cor[,"Aggregated"]
pred_cor[,"Aggregated_100to150"] <- pred_cor[,"Aggregated"]
pred_cor[,"Aggregated_150to200"] <- pred_cor[,"Aggregated"]

# Look for correlations
for(i in 1:nrow(regs)){
working_data <- nib7[which(nib7$Region == regs[i,"Region"]),]
cors <- as.data.frame(as.table(
    round(cor(
        subset(working_data, select = pred_cor[which(pred_cor[,regs[i,"Region"]] == ""),"potpreds"])
         ),2)))
bad_cors <- cors[-which(cors$Freq > -0.6 & cors$Freq < 0.6),]
bad_cors <- bad_cors[-which(bad_cors$Freq == 1),]
for(w in 1:nrow(bad_cors)){
pred_cor[which(pred_cor[,"potpreds"] == bad_cors[w,1]), regs[i,"Region"]] <- paste0(
  pred_cor[which(pred_cor[,"potpreds"] == bad_cors[w,1]), regs[i,"Region"]],
  bad_cors[w,1], " & ", bad_cors[w,2], " (", bad_cors[w,3], ") | ")
}
pred_cor[which(pred_cor[,regs[i,"Region"]] == ""), regs[i,"Region"]] <- "TICK"
}

# Removing predictors with correlations > 0.6 (as stiupalted in section 4.3 of methods)

## AP
pred_dashboard_3[which(pred_dashboard_3$potpreds == "SoilGrids_phh2o"), "AP"] <- pred_cor[which(pred_cor$potpreds == "SoilGrids_phh2o"), "AP"] # correlated with total_precip and worse predictoor (2.77 vs 1.77)

## Bangladesh
pred_dashboard_3[which(pred_dashboard_3$potpreds == "SoilGrids_sand"), "Bangladesh"] <- pred_cor[which(pred_cor$potpreds == "SoilGrids_sand"), "Bangladesh"] # correlated with total precip
pred_dashboard_3[which(pred_dashboard_3$potpreds == "Field_duration"), "Bangladesh"] <- pred_cor[which(pred_cor$potpreds == "Field_duration"), "Bangladesh"] # correlated with TDATE_rel and worse predictor (1.73 vs 1,32)

## Bihar
# No correlated variables to remove

## Nepal
# No correlated variables to remove

## Odisha
pred_dashboard_3[which(pred_dashboard_3$potpreds == "SoilGrids_bdod"), "Odisha"] <- pred_cor[which(pred_cor$potpreds == "SoilGrids_bdod"), "Odisha"] # correlated with soil carbon and worse predictor (1.55 vs 0.24)
pred_dashboard_3[which(pred_dashboard_3$potpreds == "SoilGrids_phh2o"), "Odisha"] <- pred_cor[which(pred_cor$potpreds == "SoilGrids_phh2o"), "Odisha"] # correlated with soil sandniess and worse predictor (2.45 vs 1.34)

## Punjab_Haryana
pred_dashboard_3[which(pred_dashboard_3$potpreds == "SoilGrids_soc"), "Punjab_Haryana"] <- pred_cor[which(pred_cor$potpreds == "SoilGrids_soc"), "Punjab_Haryana"] # correlated with four vars and not good predictor
pred_dashboard_3[which(pred_dashboard_3$potpreds == "total_precip"), "Punjab_Haryana"] <- pred_cor[which(pred_cor$potpreds == "total_precip"), "Punjab_Haryana"] # correlated with four vars
pred_dashboard_3[which(pred_dashboard_3$potpreds == "SoilGrids_bdod"), "Punjab_Haryana"] <- pred_cor[which(pred_cor$potpreds == "SoilGrids_bdod"), "Punjab_Haryana"] # correlated with three vars (soc and rain already excluded) but worse predictor than soil sandiness (2.45 vs 1.66)
pred_dashboard_3[which(pred_dashboard_3$potpreds == "Nperc_7to30_DAT"), "Punjab_Haryana"] <- pred_cor[which(pred_cor$potpreds == "Nperc_7to30_DAT"), "Punjab_Haryana"] # correlated with early N and slightly worse predictor (1.25 vs 1.19)

# Clearing the other predictors 
for(k in 3:ncol(pred_dashboard_3)){
  pred_dashboard_3[which(pred_dashboard_3[,k] == "tbc"),k] <- "Included"
}

```

3.5) Checking if nitrogen rate is correlated with any predictors for random forest models predicting yield

```{r}
library(gridExtra)
library(ggplot2)
library (tidyverse)

nib7$N_input_ladha <- nib7$N_kg_ha + 38 # nitrogen surplus assumptions in Ladha et al. (2016), see supplementary material 1

pred_dashboard_NRATE <- pred_dashboard_3

## Isolating numeric predictors 
pred_cor_NRATE <- pred_dashboard_NRATE[which(pred_dashboard_NRATE$class == "numeric" | pred_dashboard_NRATE$class == "integer"),]

## Getting rid of "tbc"
for(i in 1:ncol(pred_cor_NRATE)){
pred_cor_NRATE[which(pred_cor_NRATE[,i] == "tbc"),i] <- ""
}
relevant_predictors <- as.data.frame(pred_cor_NRATE$potpreds)
colnames(relevant_predictors)[1] <- "Predictor"
# relevant_predictors$correlation_with_Nrate <- "tbc"
for(i in 1:nrow(relevant_predictors)){
for(j in 1:nrow(regs)){
relevant_predictors[i,paste0("correlation_with_Nrate_",regs[j,"Region"])] <- cor(nib7[which(nib7$Region == regs[j,"Region"]),relevant_predictors[i,"Predictor"]],nib7[which(nib7$Region == regs[j,"Region"]),"N_kg_ha"])
}}

relevant_predictors_SIMPLES <- relevant_predictors
for(i in 2:ncol(relevant_predictors_SIMPLES)){
relevant_predictors_SIMPLES[which(relevant_predictors_SIMPLES[,i] < 0.6 &
                                    relevant_predictors_SIMPLES[,i] > -0.6), i] <- "TICK"
}



```

3.6) Identifying optimal paramteters for random forest models predicting yield

```{r}
library('caret')
library('dplyr')

for(i in 1:nrow(regs)){

response_name <- "yield_kg_ha"
predictor_names <- pred_dashboard_3[which(pred_dashboard_3[,regs[i,"Region"]] == "Included"), "potpreds"]
rf_formula <- as.formula(paste0(response_name, " ~ ", paste(predictor_names, collapse = " + ")))
predictor_names <- c(predictor_names, "N_kg_ha")

working_data <- nib7[which(nib7$Region == regs[i,"Region"] & nib7$N_kg_ha <= max_Nrate_tight),c(response_name,predictor_names)]

(mtry.default <- floor(sqrt(dim(working_data)[2])))
getModelInfo("ranger")$ranger$parameters
system.time(
  ranger.tune <- train(
                    rf_formula,
                    data = working_data,
                    method="ranger",
                    tuneGrid = expand.grid(.mtry = (mtry.default-1):(mtry.default+3),
                    .splitrule = "variance",
                    .min.node.size = 2:6),
                    trControl = trainControl(method = 'cv')))
print(plot.train(ranger.tune, metric="Rsquared", main = paste0(regs[i,"Region"],"_",Nbins[j,"Nbins"])))
print(plot.train(ranger.tune, metric="RMSE", main = paste0(regs[i,"Region"],"_",Nbins[j,"Nbins"])))
}


```

3.7) Defining optimal paramteters for random forest models predicting yield

```{r}
# Make tables collating mtry (number of variables to possibly split at in each node) and min.node.size for each model
mtry_table_YIELD <- data.frame(matrix(ncol = 1, nrow = nrow(regs)))
colnames(mtry_table_YIELD) <- "0to200"
rownames(mtry_table_YIELD) <- c(regs[,"Region"])

min_node_size_table_YIELD <- data.frame(matrix(ncol = 1, nrow = nrow(regs)))
colnames(min_node_size_table_YIELD) <- "0to200"
rownames(min_node_size_table_YIELD) <- c(regs[,"Region"])

## AP
mtry_table_YIELD["AP","0to200"] <- 8
min_node_size_table_YIELD["AP","0to200"] <- 6

## Bangladesh
mtry_table_YIELD["Bangladesh","0to200"] <- 7
min_node_size_table_YIELD["Bangladesh","0to200"] <- 2

## Bihar
mtry_table_YIELD["Bihar","0to200"] <- 9
min_node_size_table_YIELD["Bihar","0to200"] <- 2

## Nepal
mtry_table_YIELD["Nepal","0to200"] <- 8
min_node_size_table_YIELD["Nepal","0to200"] <- 5


## Odisha
mtry_table_YIELD["Odisha","0to200"] <- 8
min_node_size_table_YIELD["Odisha","0to200"] <- 6

## Punjab_Haryana
mtry_table_YIELD["Punjab_Haryana","0to200"] <- 6
min_node_size_table_YIELD["Punjab_Haryana","0to200"] <- 4


```

3.8) Fitting random forest models predicting yield

```{r}
require('ranger')

# Modeling each region individually
for(i in 1:nrow(regs)){

response_name <- "yield_kg_ha"
predictor_names <- pred_dashboard_3[which(pred_dashboard_3[,regs[i,"Region"]] == "Included"), "potpreds"]
predictor_names <- c(predictor_names, "N_kg_ha")

rf_formula <- as.formula(paste0(response_name, " ~ ", paste(predictor_names, collapse = " + ")))
working_data <- nib7[which(nib7$Region == regs[i,"Region"]),]

rf_model <- ranger(formula = rf_formula, data = working_data,importance = "permutation"
    , mtry = mtry_table_YIELD[regs[i,"Region"],"0to200"]
    , min.node.size = min_node_size_table_YIELD[regs[i,"Region"],"0to200"]
)
summary(model_fit <- predict(rf_model, data = working_data)$predictions)
assign(paste0("RF_","yieldALLN_",regs[i,"Region"]), rf_model)
}

# Remodelling Punjab_Haryana without 'unsplit N' predictor (it's correlated with N rate)
response_name <- "yield_kg_ha"
predictor_names <- pred_dashboard_3[which(pred_dashboard_3[,"Punjab_Haryana"] == "Included"), "potpreds"]
predictor_names <- c(predictor_names, "N_kg_ha")
predictor_names <- predictor_names[! predictor_names %in% c("MaxUnsplit_Nperc_within_1_days")]
rf_formula <- as.formula(paste0(response_name, " ~ ", paste(predictor_names, collapse = " + ")))
working_data <- nib7[which(nib7$Region == "Punjab_Haryana"),]

rf_model <- ranger(formula = rf_formula, data = working_data,importance = "permutation"
    , mtry = mtry_table_YIELD["Punjab_Haryana","0to200"]
    , min.node.size = min_node_size_table_YIELD["Punjab_Haryana","0to200"]
)
summary(model_fit <- predict(rf_model, data = working_data)$predictions)
assign("RF_yieldALLN_Punjab_Haryana", rf_model)


## Make table collating R2 for each model
Rsquared_yieldALLN <- data.frame(matrix(ncol = 1, nrow = nrow(regs)))
colnames(Rsquared_yieldALLN) <- "0to200"
rownames(Rsquared_yieldALLN) <- c(regs[,"Region"])

for (i in 1:nrow(regs)){
R2 <- get(paste0("RF_","yieldALLN_",regs[i,"Region"]))$r.squared
Sample_size <- get(paste0("RF_","yieldALLN_",regs[i,"Region"]))$num.samples
Rsquared_yieldALLN[i,1] <- paste0(round(R2,2))
}

# Make nice table
Rsquared_yieldALLN_nice <- Rsquared_yieldALLN
colnames(Rsquared_yieldALLN_nice)[1] <- "RF_0to200"

```

3.9) Developing predictor assessment framework for random forests predciting yield

```{r}

pred_comparison <- pred_dashboard_3

# Importance
pred_comparison[,paste0("Importance_mean","_","0to200")] <- NA
pred_comparison[,paste0("Importance_median","_","0to200")] <- NA

# Setting up framework for each model
pred_comparison_YIELD <- pred_comparison

```

3.10) Estimating Shapley values for random forest models predicing yield

```{r}
set.seed(42)
pfun <- function(object, newdata) predict(object, data = newdata)$predictions

varImportance_start <- Sys.time()

pred_dashboard_YIELD <- pred_dashboard_3

# MaxUnsplit_Nperc_within_1_days was excluded in Punjab_Haryana
pred_dashboard_YIELD[which(pred_dashboard_YIELD$potpreds == "MaxUnsplit_Nperc_within_1_days"),"Punjab_Haryana"] <- "Special_exclusion"
pred_comparison_YIELD[which(pred_comparison_YIELD$potpreds == "MaxUnsplit_Nperc_within_1_days"),"Punjab_Haryana"] <- "Special_exclusion"

## Ensure N rate included in dashboard
pred_comparison_YIELD[nrow(pred_comparison_YIELD)+1,] <- "Included"
pred_comparison_YIELD[nrow(pred_comparison_YIELD),"potpreds"] <- "N_kg_ha"
pred_comparison_YIELD[nrow(pred_comparison_YIELD),"class"] <- "numeric"

# Each region

for(i in 1:nrow(regs)){
for(j in 1){ # N bins irrelevant for yield model including N rate


region <- regs[i,"Region"]

## Identify predictor data
predictor_names <- pred_dashboard_YIELD[which(pred_dashboard_YIELD[,region] == "Included"), "potpreds"]
predictor_names <- c(predictor_names, "N_kg_ha")
predictor_data <- nib7[which(nib7$Region == region), predictor_names]

## Identify model
model_name <- paste0("RF_","yieldALLN_",regs[i,"Region"])

# Calculate local shap (i.e. average predictor importance for EACH row)
shap <- fastshap::explain(get(model_name),
                          X = predictor_data,
                          pred_wrapper = pfun,
                          adjust = T, # This asks SHAP to say how much each predictor pushed prediction away from average prediction
                          nsim = 10)

# Calculate global shap (i.e. average predictor importance for ALL rows)
shap_imp <- data.frame(
  Variable = names(shap),
  Importance = apply(shap, MARGIN = 2, FUN = function(x) mean(abs(x)))
)

## Plug values into dashboard
for(y in 1:nrow(pred_comparison_YIELD)){
name_of_predictor <- pred_comparison_YIELD[y,"potpreds"]
if(pred_comparison_YIELD[y,region] != "Included") next
pred_comparison_YIELD[y, paste("Importance_",region,"_0to200", sep="")] <- round((shap_imp[which(shap_imp$Variable == name_of_predictor),"Importance"]),4)
}

## Create shap importance plot
print(ggplot(shap_imp, aes(reorder(Variable, Importance), Importance)) +
  geom_col() +
  coord_flip() +
  xlab("") +
  ylab(paste0("Mean shap value in ",region)))

## Store variable importance results and plot
assign(paste("shap_imp_","YIELDreg","_",region,"_0to200", sep = ""),shap_imp)
assign(paste("shap_","YIELDreg","_",region,"_0to200", sep = ""),shap)
}}

# Work out computational time
varImportance_end <- Sys.time()
print(round(varImportance_end - varImportance_start),0)
```

3.11) Isolating average relationship between nitrogen rate and yield for each region (Figure S3 in Supplementary Information 4)

```{r}
library(segmented)
library(ggplot2)
library(gridtext)
library(gridExtra)
library(grid)

set.seed(42)

nib7$SHAP_N_kg_ha <- "tbc"
regs$N_rate_breakpoint <- "tbc"
regs$N_input_breakpoint <- "tbc"
regs$SHAP_at_breakpoint <- "tbc"
regs$N_output_breakpoint <- "tbc"
regs$N_surplus_breakpoint <- "tbc"

for(i in 1:nrow(regs)){
for(j in 1){
  region <- regs[i,"Region"]
nib7[which(nib7$Region == region),"SHAP_N_kg_ha"] <- 
get(paste("shap_","YIELDreg","_",region,"_0to200", sep = ""))$N_kg_ha
}}
nib7$SHAP_N_kg_ha <- as.numeric(nib7$SHAP_N_kg_ha)


for(i in 1:nrow(regs)){
region <- regs[i,"Region"] 

x = as.numeric(nib7[which(nib7$Region == region),"N_kg_ha"])
y = as.numeric(nib7[which(nib7$Region == region),"SHAP_N_kg_ha"])
lin.model <- lm(y~x)
segmented.mod <- segmented(lin.model, seg.Z = ~x)
residuals <- as.numeric(segmented.mod$residuals)
plot(segmented.mod, main = regs[i,"Region_figurename"], res = T, xlim = c(0,200), ylim = c(-1000, 500), xlab = "Nitrogen rate (kg/ha)", ylab = "Change in predicted yield (kg/ha)", 
     res.col = ifelse(x < 50,"black",
               ifelse(residuals <= 0 & x < segmented.mod$psi[2],"black",
               ifelse(residuals > 0 & x < segmented.mod$psi[2],"black",
               ifelse(residuals > 0 & x > segmented.mod$psi[2],"black",
               "black")))))

## Calculate N surplus at breakpint

### N rate at breakpoint
regs[i, "N_rate_breakpoint"] <- segmented.mod$psi[2]
regs$N_rate_breakpoint <- as.numeric(regs$N_rate_breakpoint)

### N input at breakpoint
regs[i, "N_input_breakpoint"] <- regs[i, "N_rate_breakpoint"] + 38 # nitrogen surplus assumptions in Ladha et al. (2016) - see Supplementary material 1
regs$N_input_breakpoint <- as.numeric(regs$N_input_breakpoint)

### View results
regs[,c("Region","N_input_breakpoint","SHAP_at_breakpoint","N_output_breakpoint","N_surplus_breakpoint")]

## Save models
assign(paste("lin.model_",region,sep = ""),lin.model)
assign(paste("segmented.mod_",region,sep = ""),segmented.mod)

}

```

3.12) Calculating potential NUE increases

```{r}
# Calculating potential N saving
nib6$potential_N <- NA
nib6$seg_N_saving_kg_ha <- NA

for(i in 1:nrow(regs)){
region <- regs[i,"Region"]
nib6[which(nib6$Region == region), "potential_N"] <- regs[i, "N_rate_breakpoint"]
nib6[which(nib6$Region == region), "seg_N_saving_kg_ha"] <-
  nib6[which(nib6$Region == region), "N_kg_ha"] -
  nib6[which(nib6$Region == region), "potential_N"]
}
nib6[which(nib6$seg_N_saving_kg_ha < 0), "seg_N_saving_kg_ha"] <- 0

# Calculating potential yield gain
nib6$x <- nib6$N_kg_ha
nib6[which(nib6$N_kg_ha > nib6$potential_N), "x"] <-
  nib6[which(nib6$N_kg_ha > nib6$potential_N), "potential_N"]

nib6$predicted_yield_SHAP <- NA
nib6$seg_predicted_yield_kg_ha <- NA
nib6$seg_yield_gain_kg_ha <- NA

for(i in 1:nrow(regs)){
region <- regs[i,"Region"]
nib6[which(nib6$Region == region), "predicted_yield_SHAP"] <- predict(get(paste0("segmented.mod_",region)),
                                                                      nib6[which(nib6$Region == region),])
nib6[which(nib6$Region == region), "seg_predicted_yield_kg_ha"] <-
  nib6[which(nib6$Region == region), "predicted_yield_SHAP"] +
  mean(get(paste0("RF_yieldALLN_", region))$predictions) # Average predicted yield for this region

nib6[which(nib6$Region == region), "seg_yield_gain_kg_ha"] <-
  nib6[which(nib6$Region == region), "seg_predicted_yield_kg_ha"] -
  nib6[which(nib6$Region == region), "yield_kg_ha"]
}

# Prevent low N farmers from mining
nib6[which(nib6$N_kg_ha < 50), "seg_yield_gain_kg_ha"] <- 0

# Prevent model for extraploating too far in Odisha and Punjab_Haryana
nib6[which(nib6$N_kg_ha < 100 & nib6$Region == "Punjab_Haryana"), "seg_yield_gain_kg_ha"] <- 0
# nib6[which(nib6$N_kg_ha > 150 & nib6$Region == "Odisha"), "seg_yield_gain_kg_ha"] <- 0

# Remove negative yield gains
nib6[which(nib6$seg_yield_gain_kg_ha < 0), "seg_yield_gain_kg_ha"] <- 0

# Calculate regional average
regs$mean_potential_yield_gain_kg_ha <- "tbc"
for(i in 1:nrow(regs)){
regs[i,"mean_potential_yield_gain_kg_ha"] <- mean(nib6[which(nib6$Region == regs[i, "Region"]), "seg_yield_gain_kg_ha"])
}


# Calculating implications for surplus
nib6$seg_yield_gain_kg_ha_GrainDM <- nib6$seg_yield_gain_kg_ha * DM_perc
nib6$seg_yield_gain_kg_ha_GrainN <- nib6$seg_yield_gain_kg_ha_GrainDM * Grain_N_perc
nib6$seg_yield_gain_kg_ha_StrawDM <- (nib6$seg_yield_gain_kg_ha_GrainDM / Harvest_index) - nib6$seg_yield_gain_kg_ha_GrainDM
nib6$seg_yield_gain_kg_ha_StrawN <- nib6$seg_yield_gain_kg_ha_StrawDM * Straw_N_perc
nib6$seg_yield_gain_kg_ha_NoutputGAIN <- nib6$seg_yield_gain_kg_ha_GrainN + nib6$seg_yield_gain_kg_ha_StrawN
nib6$seg_yield_gain_kg_ha_NbalanceCHANGE <- nib6$N_balance_ladha - nib6$seg_yield_gain_kg_ha_NoutputGAIN


# Fitting different scenarios
## Scenario 1 = N saving
## Scenario 2 = Q50 yield gain
## Scenario 3 = both

nib6$S1_seg_N_saving_kg_ha <- nib6$seg_N_saving_kg_ha
nib6$S2_seg_N_saving_kg_ha <- 0
nib6$S3_seg_N_saving_kg_ha <- nib6$seg_N_saving_kg_ha

nib6$S1_seg_yield_gain_kg_ha <- 0
nib6$S2_seg_yield_gain_kg_ha <- nib6$seg_yield_gain_kg_ha
nib6$S3_seg_yield_gain_kg_ha <- nib6$seg_yield_gain_kg_ha

nib6$S1_seg_N_surplus_saving_kg_ha <- nib6$seg_N_saving_kg_ha
nib6$S2_seg_N_surplus_saving_kg_ha <- nib6$seg_yield_gain_kg_ha_NoutputGAIN
nib6$S3_seg_N_surplus_saving_kg_ha <- nib6$seg_N_saving_kg_ha + nib6$seg_yield_gain_kg_ha_NoutputGAIN



```

3.13) Visualising potential NUE increases (Figure S10 in Supplementary Information 12)

```{r}


library(segmented)
library(ggplot2)

regs$average_yield_kg_ha <- "tbc"

for(i in 1:nrow(regs)){
# Find fitted model
region <- regs[i,"Region"]
x = as.numeric(nib7[which(nib7$Region == region),"N_kg_ha"])
y = as.numeric(nib7[which(nib7$Region == region),"SHAP_N_kg_ha"])
yield_kg_ha <- as.numeric(nib7[which(nib7$Region == region),"yield_kg_ha"])
Region <- nib7[which(nib7$Region == region),"Region"]

fit <- numeric(length(x)) * NA
fit[complete.cases(rowSums(cbind(y, x)))] <- broken.line(get(paste0("segmented.mod_",region)))$fit
data1 <- data.frame(x = x, y = y, fit = fit, yield_kg_ha = yield_kg_ha, Region = Region)
# Convert relative difference to actual difference
regs[i,"average_yield_kg_ha"] <- mean(get(paste0("RF_yieldALLN_",region))$predictions)
data1$fit <- as.numeric(regs[i,"average_yield_kg_ha"]) + data1$fit
# Fit production function to raw data
plot <- ggplot() +
  geom_point(data = data1, aes(x = x, y = yield_kg_ha), color = 'grey', alpha = 0.3) +
  geom_line(data = data1, aes(x = x, y = fit), color = 'black') +
  theme_bw()
print(plot)
# Assign dataset data
assign(paste("prodfunc_",region,sep = ""),data1)
}

prodfunc_Punjab_Haryana <- prodfunc_Punjab_Haryana[-which(prodfunc_Punjab_Haryana$x < 100),]
prodfunc_Odisha <- prodfunc_Odisha[-which(prodfunc_Odisha$x > 150),]

ggplot() +
  geom_line(data = get(paste0("prodfunc_", "AP")), aes(x = x, y = fit, color = 'Andhra Pradesh')) +
  geom_line(data = get(paste0("prodfunc_", "Bangladesh")), aes(x = x, y = fit, color = 'Bangladesh')) +
  geom_line(data = get(paste0("prodfunc_", "Bihar")), aes(x = x, y = fit, color = 'Bihar & E.U.P.')) +
  geom_line(data = get(paste0("prodfunc_", "Nepal")), aes(x = x, y = fit, color = 'Nepal')) +
  geom_line(data = get(paste0("prodfunc_", "Odisha")), aes(x = x, y = fit, color = 'Odisha')) +
  geom_line(data = get(paste0("prodfunc_", "Punjab_Haryana")), aes(x = x, y = fit, color = 'Punjab & Haryana')) +
  ggtitle("") +
  scale_color_manual(name='Region',
                     breaks=c('Andhra Pradesh', 'Bangladesh', 'Bihar & E.U.P.', 'Nepal', 'Odisha', 'Punjab & Haryana'),
                     values=c('Andhra Pradesh' = 'dark grey', 'Bangladesh' = 'dark green', 'Bihar & E.U.P.' = 'black', 'Nepal' = 'dark red', 'Odisha' = 'blue', 'Punjab & Haryana' = 'orange')) +
  theme_bw() +
  ylim(c(0,7000)) +
  labs(x = "N rate (kg/ha)", y = "Predicted yield (kg/ha)") +
  theme(legend.position="none") +
  theme(axis.text=element_text(size=10), axis.title=element_text(size=13))

# Showcasing
nib6$Pathway <- "No pathway"
nib6[which(nib6$seg_N_saving_kg_ha > 0), "Pathway"] <- "Pathway 1"
nib6[which(nib6$seg_yield_gain_kg_ha > 0), "Pathway"] <- "Pathway 2"
nib6[which(nib6$seg_N_saving_kg_ha > 0 & nib6$seg_yield_gain_kg_ha > 0), "Pathway"] <- "Pathway 1&2"

for(i in 1:nrow(regs)){
print(
ggplot() +
  ggtitle(regs[i,"Region_figurename"]) +
  geom_point(data = nib6[which(nib6$Region == regs[i,"Region"]),], aes (N_kg_ha,yield_kg_ha, colour = Pathway)) +
  scale_color_manual(name='Pathway',
                     values=c('Pathway 1' = 'yellow3', 'Pathway 2' = ' dark blue', 'Pathway 1&2' = 'dark green', 'No pathway' = 'grey')) +
  geom_line(data = get(paste0("prodfunc_", regs[i,"Region"])), aes(x = x, y = fit), colour = 'red', size = 1.5) +
  theme_bw() +
  ylim(c(0,10000)) +
  labs(x = "N rate (kg/ha)", y = "Predicted yield (kg/ha)") +
  theme(axis.text=element_text(size=10), axis.title=element_text(size=13)) +
  theme(legend.position=c(0.92,0.15))
)
}


```

3.14) Calculating practical implications of potential NUE increases

```{r}
# Design table
Desired_table <- data.frame(c(regs$Region,"Aggregated",
                              regs$Region,"Aggregated",
                              regs$Region,"Aggregated"))
colnames(Desired_table)[1] <- "Region"
Desired_table$Scenario <- "tbc"
Desired_table[1:7,"Scenario"] <- "Scenario_1"
Desired_table[8:14,"Scenario"] <- "Scenario_2"
Desired_table[15:21,"Scenario"] <- "Scenario_3"

Scen <- c("Scenario_1",
          "Scenario_2",
          "Scenario_3")
Scent <- data.frame(Scen)
Scent$Abb <- c("S1","S2","S3")

# Input price and subsidy assumptions defined in Table S4 Supplementary information 5

## Bangladesh

### Gov N subsidy
Bangladesh_subsidy_Tk_per_urea_kg <- 21
Bangladesh_subsidy_Tk_per_N_kg <- Bangladesh_subsidy_Tk_per_urea_kg / 0.46
Bangladesh_subsidy_USD_per_N_kg <- Bangladesh_subsidy_Tk_per_N_kg / 106.0933

### Farmer N cost
Bangladesh_farmercost_Tk_per_urea_kg <- 27
Bangladesh_farmercost_Tk_per_N_kg <- Bangladesh_farmercost_Tk_per_urea_kg / 0.46
Bangladesh_farmercost_USD_per_N_kg <- Bangladesh_farmercost_Tk_per_N_kg / 106.0933

### Farmer paddy price
Bangladesh_paddy_price_Tk_per_kg <- 30
Bangladesh_paddy_price_USD_per_kg <- Bangladesh_paddy_price_Tk_per_kg / 106.0933

## Nepal

### Gov N subsidy
Nepal_subsidy_NepalRupees_per_urea_kg <- (25 / (100-64.49)) * 64.49
Nepal_subsidy_NepalRupees_per_N_kg <- Nepal_subsidy_NepalRupees_per_urea_kg / 0.46
Nepal_subsidy_USD_per_N_kg <- Nepal_subsidy_NepalRupees_per_N_kg / 131.38

### Farmer N cost
Nepal_farmercost_NepalRs_per_urea_kg <- 25
Nepal_farmercost_NepalRs_per_N_kg <- Nepal_farmercost_NepalRs_per_urea_kg / 0.46
Nepal_farmercost_USD_per_N_kg <- Nepal_farmercost_NepalRs_per_N_kg / 131.38

### Farmer paddy price
Nepal_paddy_price_Rs_per_quintal <- 2752
Nepal_paddy_price_Rs_per_kg <- Nepal_paddy_price_Rs_per_quintal / 100
Nepal_paddy_price_USD_per_kg <- Nepal_paddy_price_Rs_per_kg / 131.38

## India

### Gov N subsidy
India_subsidy_Rs_per_N_kg <- 76
India_subsidy_USD_per_N_kg <- India_subsidy_Rs_per_N_kg / 82.726

### Farmer N cost
India_farmercost_IndiaRs_per_urea_kg <- 276 / 45
India_farmercost_IndiaRs_per_N_kg <- India_farmercost_IndiaRs_per_urea_kg / 0.46
India_farmercost_USD_per_N_kg <- India_farmercost_IndiaRs_per_N_kg / 82.726

### Farmer paddy price
India_paddy_price_Rs_per_quintal <- 2040
India_paddy_price_Rs_per_kg <- India_paddy_price_Rs_per_quintal / 100
India_paddy_price_USD_per_kg <- India_paddy_price_Rs_per_kg / 82.726

# 1) Monsoon_area_ha
Desired_table[which(Desired_table$Region == "Bihar"),"Monsoon_area_ha"] <- regs[which(regs$Region == "Bihar"), "Monsoon_area_ha"]
Desired_table[which(Desired_table$Region == "Odisha"),"Monsoon_area_ha"] <- regs[which(regs$Region == "Odisha"), "Monsoon_area_ha"]
Desired_table[which(Desired_table$Region == "AP"),"Monsoon_area_ha"] <-  regs[which(regs$Region == "AP"), "Monsoon_area_ha"]
Desired_table[which(Desired_table$Region == "Nepal"),"Monsoon_area_ha"] <- regs[which(regs$Region == "Nepal"), "Monsoon_area_ha"]
Desired_table[which(Desired_table$Region == "Bangladesh"),"Monsoon_area_ha"] <- regs[which(regs$Region == "Bangladesh"), "Monsoon_area_ha"]
Desired_table[which(Desired_table$Region == "Punjab_Haryana"),"Monsoon_area_ha"] <- regs[which(regs$Region == "Punjab_Haryana"), "Monsoon_area_ha"]
Desired_table[which(Desired_table$Region == "Aggregated"),"Monsoon_area_ha"] <-
  (Desired_table[1,"Monsoon_area_ha"] +
  Desired_table[2,"Monsoon_area_ha"] +
  Desired_table[3,"Monsoon_area_ha"] +
  Desired_table[4,"Monsoon_area_ha"] +
  Desired_table[5,"Monsoon_area_ha"] +
  Desired_table[6,"Monsoon_area_ha"])


# 2) percentage_Nsavers

## Range involved
for(j in 1:nrow(Scent)){
Desired_table[,paste0(Scent[j,"Abb"],".1_percentage_Nsavers")] <- NA

for(i in 1:6){

Desired_table[i+(7*(j-1)),paste0(Scent[j,"Abb"],".1_percentage_Nsavers")] <- round(
  length(which(nib6$Region == Desired_table[i,"Region"] & nib6[,paste0(Scent[j,"Abb"],"_seg_N_saving_kg_ha")] > 0)) /
  length(which(nib6$Region == Desired_table[i,"Region"])) * 100
  ,0)
Desired_table[i+(7*(j-1)),"percentage_Nsavers"] <-
 paste0(Desired_table[i+(7*(j-1)),paste0(Scent[j,"Abb"],".1_percentage_Nsavers")],
        "%")
}
Desired_table[7+(7*(j-1)),"percentage_Nsavers"] <- paste0(
  round((
  ((Desired_table[1+(7*(j-1)),paste0(Scent[j,"Abb"],".1_percentage_Nsavers")] * Desired_table[1+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table[2+(7*(j-1)),paste0(Scent[j,"Abb"],".1_percentage_Nsavers")] * Desired_table[2+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table[3+(7*(j-1)),paste0(Scent[j,"Abb"],".1_percentage_Nsavers")] * Desired_table[3+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table[4+(7*(j-1)),paste0(Scent[j,"Abb"],".1_percentage_Nsavers")] * Desired_table[4+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table[5+(7*(j-1)),paste0(Scent[j,"Abb"],".1_percentage_Nsavers")] * Desired_table[5+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table[6+(7*(j-1)),paste0(Scent[j,"Abb"],".1_percentage_Nsavers")] * Desired_table[6+(7*(j-1)),"Monsoon_area_ha"]))
  / Desired_table[7+(7*(j-1)),"Monsoon_area_ha"]),0),
  "%"
)
}

# 3) mean_N_saving_kg_ha
for(j in 1:nrow(Scent)){
Desired_table[,paste0(Scent[j,"Abb"],".1_mean_N_saving_kg_ha")] <- NA

for(i in 1:6){

Desired_table[i+(7*(j-1)),paste0(Scent[j,"Abb"],".1_mean_N_saving_kg_ha")] <- round(
  mean(nib6[which(nib6$Region == Desired_table[i,"Region"]), paste0(Scent[j,"Abb"],"_seg_N_saving_kg_ha")])
  ,0)
Desired_table[i+(7*(j-1)),"mean_N_saving_kg_ha"] <-
 paste0(Desired_table[i+(7*(j-1)),paste0(Scent[j,"Abb"],".1_mean_N_saving_kg_ha")]
        )
}
Desired_table[7+(7*(j-1)),"mean_N_saving_kg_ha"] <- paste0(
  round((
  ((Desired_table[1+(7*(j-1)),paste0(Scent[j,"Abb"],".1_mean_N_saving_kg_ha")] * Desired_table[1+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table[2+(7*(j-1)),paste0(Scent[j,"Abb"],".1_mean_N_saving_kg_ha")] * Desired_table[2+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table[3+(7*(j-1)),paste0(Scent[j,"Abb"],".1_mean_N_saving_kg_ha")] * Desired_table[3+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table[4+(7*(j-1)),paste0(Scent[j,"Abb"],".1_mean_N_saving_kg_ha")] * Desired_table[4+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table[5+(7*(j-1)),paste0(Scent[j,"Abb"],".1_mean_N_saving_kg_ha")] * Desired_table[5+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table[6+(7*(j-1)),paste0(Scent[j,"Abb"],".1_mean_N_saving_kg_ha")] * Desired_table[6+(7*(j-1)),"Monsoon_area_ha"]))
  / Desired_table[7+(7*(j-1)),"Monsoon_area_ha"]),0)
)
}



# 4) mean_yield_increase_kg_ha
for(j in 1:nrow(Scent)){
for(i in 1:6){

Desired_table[i+(7*(j-1)),"mean_yield_increase_kg_ha"] <- round(
  mean(nib6[which(nib6$Region == Desired_table[i,"Region"]), paste0(Scent[j,"Abb"],"_seg_yield_gain_kg_ha")])
  ,0)
}
Desired_table[7+(7*(j-1)),"mean_yield_increase_kg_ha"] <-
  round((
  (as.numeric(Desired_table[1+(7*(j-1)),"mean_yield_increase_kg_ha"]) * Desired_table[1+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table[2+(7*(j-1)),"mean_yield_increase_kg_ha"]) * Desired_table[2+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table[3+(7*(j-1)),"mean_yield_increase_kg_ha"]) * Desired_table[3+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table[4+(7*(j-1)),"mean_yield_increase_kg_ha"]) * Desired_table[4+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table[5+(7*(j-1)),"mean_yield_increase_kg_ha"]) * Desired_table[5+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table[6+(7*(j-1)),"mean_yield_increase_kg_ha"]) * Desired_table[6+(7*(j-1)),"Monsoon_area_ha"]))
  / Desired_table[7+(7*(j-1)),"Monsoon_area_ha"],0)
}



# 5) mean_Nsaving_USD_ha
Desired_table$FarmerCost_USDperKGofN <- round(India_farmercost_USD_per_N_kg, 2)
Desired_table[which(Desired_table$Region == "Bangladesh"), "FarmerCost_USDperKGofN"] <-
  round(Bangladesh_farmercost_USD_per_N_kg, 2)
Desired_table[which(Desired_table$Region == "Nepal"), "FarmerCost_USDperKGofN"] <-
  round(Nepal_farmercost_USD_per_N_kg, 2)
Desired_table[which(Desired_table$Region == "Aggregated"), "FarmerCost_USDperKGofN"] <- NA



for(j in 1:nrow(Scent)){
Desired_table[,paste0(Scent[j,"Abb"],".1_mean_Nsaving_USD_ha")] <- NA

for(i in 1:6){

Desired_table[i+(7*(j-1)),paste0(Scent[j,"Abb"],".1_mean_Nsaving_USD_ha")] <- round(
  mean(nib6[which(nib6$Region == Desired_table[i,"Region"]), paste0(Scent[j,"Abb"],"_seg_N_saving_kg_ha")]) *
    Desired_table[i+(7*(j-1)),"FarmerCost_USDperKGofN"]
  ,0)
Desired_table[i+(7*(j-1)),"mean_Nsaving_USD_ha"] <-
 Desired_table[i+(7*(j-1)),paste0(Scent[j,"Abb"],".1_mean_Nsaving_USD_ha")]
}
Desired_table[7+(7*(j-1)),"mean_Nsaving_USD_ha"] <- paste0(
  round((
  ((Desired_table[1+(7*(j-1)),paste0(Scent[j,"Abb"],".1_mean_Nsaving_USD_ha")] * Desired_table[1+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table[2+(7*(j-1)),paste0(Scent[j,"Abb"],".1_mean_Nsaving_USD_ha")] * Desired_table[2+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table[3+(7*(j-1)),paste0(Scent[j,"Abb"],".1_mean_Nsaving_USD_ha")] * Desired_table[3+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table[4+(7*(j-1)),paste0(Scent[j,"Abb"],".1_mean_Nsaving_USD_ha")] * Desired_table[4+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table[5+(7*(j-1)),paste0(Scent[j,"Abb"],".1_mean_Nsaving_USD_ha")] * Desired_table[5+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table[6+(7*(j-1)),paste0(Scent[j,"Abb"],".1_mean_Nsaving_USD_ha")] * Desired_table[6+(7*(j-1)),"Monsoon_area_ha"]))
  / Desired_table[7+(7*(j-1)),"Monsoon_area_ha"]),0)
)
}


# 6) mean_N
for(j in 1:nrow(Scent)){
for(i in 1:6){
Desired_table[i+(7*(j-1)),"mean_N"] <-
  round(mean(nib6[which(nib6$Region == Desired_table[i,"Region"]),"N_kg_ha"]),0)
}
Desired_table[7+(7*(j-1)),"mean_N"] <-
  round((
  (as.numeric(Desired_table[1+(7*(j-1)),"mean_N"]) * Desired_table[1+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table[2+(7*(j-1)),"mean_N"]) * Desired_table[2+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table[3+(7*(j-1)),"mean_N"]) * Desired_table[3+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table[4+(7*(j-1)),"mean_N"]) * Desired_table[4+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table[5+(7*(j-1)),"mean_N"]) * Desired_table[5+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table[6+(7*(j-1)),"mean_N"]) * Desired_table[6+(7*(j-1)),"Monsoon_area_ha"]))
  / Desired_table[7+(7*(j-1)),"Monsoon_area_ha"],0)
}

# 7) mean_yield
for(j in 1:nrow(Scent)){
for(i in 1:6){
Desired_table[i+(7*(j-1)),"mean_yield"] <-
  round(mean(nib6[which(nib6$Region == Desired_table[i,"Region"]),"yield_kg_ha"]),0)
}
Desired_table[7+(7*(j-1)),"mean_yield"] <-
  round((
  (as.numeric(Desired_table[1+(7*(j-1)),"mean_yield"]) * Desired_table[1+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table[2+(7*(j-1)),"mean_yield"]) * Desired_table[2+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table[3+(7*(j-1)),"mean_yield"]) * Desired_table[3+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table[4+(7*(j-1)),"mean_yield"]) * Desired_table[4+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table[5+(7*(j-1)),"mean_yield"]) * Desired_table[5+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table[6+(7*(j-1)),"mean_yield"]) * Desired_table[6+(7*(j-1)),"Monsoon_area_ha"]))
  / Desired_table[7+(7*(j-1)),"Monsoon_area_ha"],0)
}

# 8) mean_NUE_change_absolute
for(j in 1:nrow(Scent)){
for(i in 1:6){

Desired_table[i+(7*(j-1)),"mean_NUE_change_absolute"] <-
round(
  (as.numeric(Desired_table[i+(7*(j-1)),"mean_yield_increase_kg_ha"] +
                as.numeric(Desired_table[i+(7*(j-1)),"mean_yield"])) /
  as.numeric(Desired_table[i+(7*(j-1)),"mean_N"] -
               as.numeric(Desired_table[i+(7*(j-1)),"mean_N_saving_kg_ha"]))) -
  (as.numeric(Desired_table[i+(7*(j-1)),"mean_yield"]) /
  as.numeric(Desired_table[i+(7*(j-1)),"mean_N"])),0)

}
Desired_table[7+(7*(j-1)),"mean_NUE_change_absolute"] <-
  round((
  (as.numeric(Desired_table[1+(7*(j-1)),"mean_NUE_change_absolute"]) * Desired_table[1+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table[2+(7*(j-1)),"mean_NUE_change_absolute"]) * Desired_table[2+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table[3+(7*(j-1)),"mean_NUE_change_absolute"]) * Desired_table[3+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table[4+(7*(j-1)),"mean_NUE_change_absolute"]) * Desired_table[4+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table[5+(7*(j-1)),"mean_NUE_change_absolute"]) * Desired_table[5+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table[6+(7*(j-1)),"mean_NUE_change_absolute"]) * Desired_table[6+(7*(j-1)),"Monsoon_area_ha"]))
  / Desired_table[7+(7*(j-1)),"Monsoon_area_ha"],0)
}

# 9) mean_NUE_change_perc
for(j in 1:nrow(Scent)){
for(i in 1:6){

Desired_table[i+(7*(j-1)),"mean_NUE_change_perc"] <-
round(
  as.numeric(Desired_table[i+(7*(j-1)),"mean_NUE_change_absolute"]) /
  ((as.numeric(Desired_table[i+(7*(j-1)),"mean_yield"]) /
  as.numeric(Desired_table[i+(7*(j-1)),"mean_N"]))) *  100
  ,0)

}
Desired_table[7+(7*(j-1)),"mean_NUE_change_perc"] <-
  round((
  (as.numeric(Desired_table[1+(7*(j-1)),"mean_NUE_change_perc"]) * Desired_table[1+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table[2+(7*(j-1)),"mean_NUE_change_perc"]) * Desired_table[2+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table[3+(7*(j-1)),"mean_NUE_change_perc"]) * Desired_table[3+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table[4+(7*(j-1)),"mean_NUE_change_perc"]) * Desired_table[4+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table[5+(7*(j-1)),"mean_NUE_change_perc"]) * Desired_table[5+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table[6+(7*(j-1)),"mean_NUE_change_perc"]) * Desired_table[6+(7*(j-1)),"Monsoon_area_ha"]))
  / Desired_table[7+(7*(j-1)),"Monsoon_area_ha"],0)
}

# 10) mean_revenue_increase_USD_ha
Desired_table$FarmerRevenue_USDperKGofPaddy <- round(India_paddy_price_USD_per_kg, 2)
Desired_table[which(Desired_table$Region == "Bangladesh"), "FarmerRevenue_USDperKGofPaddy"] <-
  round(Bangladesh_paddy_price_USD_per_kg, 2)
Desired_table[which(Desired_table$Region == "Nepal"), "FarmerRevenue_USDperKGofPaddy"] <-
  round(Nepal_paddy_price_USD_per_kg, 2)
Desired_table[which(Desired_table$Region == "Aggregated"), "FarmerRevenue_USDperKGofPaddy"] <- NA

for(j in 1:nrow(Scent)){
for(i in 1:6){

Desired_table[i+(7*(j-1)),"mean_revenue_increase_USD_ha"] <- round(
  mean(nib6[which(nib6$Region == Desired_table[i,"Region"]), paste0(Scent[j,"Abb"],"_seg_yield_gain_kg_ha")]) *
    Desired_table[i+(7*(j-1)),"FarmerRevenue_USDperKGofPaddy"]
  ,0)
}
Desired_table[7+(7*(j-1)),"mean_revenue_increase_USD_ha"] <-
  round((
  (as.numeric(Desired_table[1+(7*(j-1)),"mean_revenue_increase_USD_ha"]) * Desired_table[1+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table[2+(7*(j-1)),"mean_revenue_increase_USD_ha"]) * Desired_table[2+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table[3+(7*(j-1)),"mean_revenue_increase_USD_ha"]) * Desired_table[3+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table[4+(7*(j-1)),"mean_revenue_increase_USD_ha"]) * Desired_table[4+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table[5+(7*(j-1)),"mean_revenue_increase_USD_ha"]) * Desired_table[5+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table[6+(7*(j-1)),"mean_revenue_increase_USD_ha"]) * Desired_table[6+(7*(j-1)),"Monsoon_area_ha"]))
  / Desired_table[7+(7*(j-1)),"Monsoon_area_ha"],0)
}

# 11) mean_Nsurplus_saving_kg_ha

## Scenarios where there is range
for(j in 1:nrow(Scent)){
Desired_table[,paste0(Scent[j,"Abb"],".1_mean_Nsurplus_saving_kg_ha")] <- NA

for(i in 1:6){

Desired_table[i+(7*(j-1)),paste0(Scent[j,"Abb"],".1_mean_Nsurplus_saving_kg_ha")] <- round(
  mean(nib6[which(nib6$Region == Desired_table[i,"Region"]), paste0(Scent[j,"Abb"],"_seg_N_surplus_saving_kg_ha")])
  ,0)
Desired_table[i+(7*(j-1)),"mean_Nsurplus_saving_kg_ha"] <-
 paste0(Desired_table[i+(7*(j-1)),paste0(Scent[j,"Abb"],".1_mean_Nsurplus_saving_kg_ha")]
        )
}
Desired_table[7+(7*(j-1)),"mean_Nsurplus_saving_kg_ha"] <- paste0(
  round((
  ((Desired_table[1+(7*(j-1)),paste0(Scent[j,"Abb"],".1_mean_Nsurplus_saving_kg_ha")] * Desired_table[1+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table[2+(7*(j-1)),paste0(Scent[j,"Abb"],".1_mean_Nsurplus_saving_kg_ha")] * Desired_table[2+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table[3+(7*(j-1)),paste0(Scent[j,"Abb"],".1_mean_Nsurplus_saving_kg_ha")] * Desired_table[3+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table[4+(7*(j-1)),paste0(Scent[j,"Abb"],".1_mean_Nsurplus_saving_kg_ha")] * Desired_table[4+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table[5+(7*(j-1)),paste0(Scent[j,"Abb"],".1_mean_Nsurplus_saving_kg_ha")] * Desired_table[5+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table[6+(7*(j-1)),paste0(Scent[j,"Abb"],".1_mean_Nsurplus_saving_kg_ha")] * Desired_table[6+(7*(j-1)),"Monsoon_area_ha"]))
  / Desired_table[7+(7*(j-1)),"Monsoon_area_ha"]),0)
)
}


# 12) total_Nsurplus_saving_kg

## Scenarios where there is range
for(j in 1:nrow(Scent)){
Desired_table[,paste0(Scent[j,"Abb"],".1_total_Nsurplus_saving_kg")] <- NA

for(i in 1:6){

Desired_table[i+(7*(j-1)),paste0(Scent[j,"Abb"],".1_total_Nsurplus_saving_kg")] <- round(
  mean(nib6[which(nib6$Region == Desired_table[i,"Region"]), paste0(Scent[j,"Abb"],"_seg_N_surplus_saving_kg_ha")]) *
    Desired_table[i+(7*(j-1)),"Monsoon_area_ha"]
  ,0)
Desired_table[i+(7*(j-1)),"total_Nsurplus_saving_kg"] <-
 paste0(Desired_table[i+(7*(j-1)),paste0(Scent[j,"Abb"],".1_total_Nsurplus_saving_kg")]
        )
}
Desired_table[7+(7*(j-1)),"total_Nsurplus_saving_kg"] <- paste0(
  round(
  Desired_table[1+(7*(j-1)),paste0(Scent[j,"Abb"],".1_total_Nsurplus_saving_kg")] +
  Desired_table[2+(7*(j-1)),paste0(Scent[j,"Abb"],".1_total_Nsurplus_saving_kg")] +
  Desired_table[3+(7*(j-1)),paste0(Scent[j,"Abb"],".1_total_Nsurplus_saving_kg")] +
  Desired_table[4+(7*(j-1)),paste0(Scent[j,"Abb"],".1_total_Nsurplus_saving_kg")] +
  Desired_table[5+(7*(j-1)),paste0(Scent[j,"Abb"],".1_total_Nsurplus_saving_kg")] +
  Desired_table[6+(7*(j-1)),paste0(Scent[j,"Abb"],".1_total_Nsurplus_saving_kg")]
  ,0)

)
}


# 13) Subsidy_USDperKGofN

Desired_table$Subsidy_USDperKGofN <- round(India_subsidy_USD_per_N_kg, 2)
Desired_table[which(Desired_table$Region == "Bangladesh"), "Subsidy_USDperKGofN"] <- round(Bangladesh_subsidy_USD_per_N_kg, 2)
Desired_table[which(Desired_table$Region == "Nepal"), "Subsidy_USDperKGofN"] <- round(Nepal_subsidy_USD_per_N_kg, 2)
Desired_table[which(Desired_table$Region == "Aggregated"), "Subsidy_USDperKGofN"] <- NA

# 14) N_subsidy_saving_millionUSD

## Scenarios where there is range
for(j in 1:nrow(Scent)){
Desired_table[,paste0(Scent[j,"Abb"],".1_N_subsidy_saving_millionUSD")] <- NA

for(i in 1:6){

Desired_table[i+(7*(j-1)),paste0(Scent[j,"Abb"],".1_N_subsidy_saving_millionUSD")] <- round(
  mean(nib6[which(nib6$Region == Desired_table[i,"Region"]), paste0(Scent[j,"Abb"],"_seg_N_saving_kg_ha")]) *
    Desired_table[i+(7*(j-1)),"Monsoon_area_ha"] * Desired_table[i+(7*(j-1)),"Subsidy_USDperKGofN"] /
    1000000
  ,0)
Desired_table[i+(7*(j-1)),"N_subsidy_saving_millionUSD"] <-
 paste0(Desired_table[i+(7*(j-1)),paste0(Scent[j,"Abb"],".1_N_subsidy_saving_millionUSD")]
 )
}

Desired_table[7+(7*(j-1)),"N_subsidy_saving_millionUSD"] <- paste0(
  round(
  Desired_table[1+(7*(j-1)),paste0(Scent[j,"Abb"],".1_N_subsidy_saving_millionUSD")] +
  Desired_table[2+(7*(j-1)),paste0(Scent[j,"Abb"],".1_N_subsidy_saving_millionUSD")] +
  Desired_table[3+(7*(j-1)),paste0(Scent[j,"Abb"],".1_N_subsidy_saving_millionUSD")] +
  Desired_table[4+(7*(j-1)),paste0(Scent[j,"Abb"],".1_N_subsidy_saving_millionUSD")] +
  Desired_table[5+(7*(j-1)),paste0(Scent[j,"Abb"],".1_N_subsidy_saving_millionUSD")] +
  Desired_table[6+(7*(j-1)),paste0(Scent[j,"Abb"],".1_N_subsidy_saving_millionUSD")]
  ,-1)
)

# 15) N_subsidy_saving_USDperha

for(j in 1:nrow(Scent)){
Desired_table[,paste0(Scent[j,"Abb"],".1_N_subsidy_saving_USDperha")] <- NA

for(i in 1:6){

Desired_table[i+(7*(j-1)),paste0(Scent[j,"Abb"],".1_N_subsidy_saving_USDperha")] <- round(
  mean(nib6[which(nib6$Region == Desired_table[i,"Region"]), paste0(Scent[j,"Abb"],"_seg_N_saving_kg_ha")]) *
    Desired_table[i+(7*(j-1)),"Subsidy_USDperKGofN"]
  ,0)

Desired_table[i+(7*(j-1)),"N_subsidy_saving_USDperha"] <-
 paste0(Desired_table[i+(7*(j-1)),paste0(Scent[j,"Abb"],".1_N_subsidy_saving_USDperha")]
        )
}

Desired_table[7+(7*(j-1)),"N_subsidy_saving_USDperha"] <- paste0(
  round(
  ((Desired_table[1+(7*(j-1)),paste0(Scent[j,"Abb"],".1_N_subsidy_saving_USDperha")] *
     Desired_table[1+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table[2+(7*(j-1)),paste0(Scent[j,"Abb"],".1_N_subsidy_saving_USDperha")] *
     Desired_table[2+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table[3+(7*(j-1)),paste0(Scent[j,"Abb"],".1_N_subsidy_saving_USDperha")] *
     Desired_table[3+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table[4+(7*(j-1)),paste0(Scent[j,"Abb"],".1_N_subsidy_saving_USDperha")] *
     Desired_table[4+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table[5+(7*(j-1)),paste0(Scent[j,"Abb"],".1_N_subsidy_saving_USDperha")] *
     Desired_table[5+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table[6+(7*(j-1)),paste0(Scent[j,"Abb"],".1_N_subsidy_saving_USDperha")] *
     Desired_table[6+(7*(j-1)),"Monsoon_area_ha"]))
  / Desired_table[7+(7*(j-1)),"Monsoon_area_ha"]
  ,0)
)
}

}


# 16) total_yield_increase_kg

for(j in 1:nrow(Scent)){
for(i in 1:6){

Desired_table[i+(7*(j-1)),"total_yield_increase_kg"] <- round(
  mean(nib6[which(nib6$Region == Desired_table[i,"Region"]), paste0(Scent[j,"Abb"],"_seg_yield_gain_kg_ha")]) *
    Desired_table[i+(7*(j-1)),"Monsoon_area_ha"]
  ,0)
}
Desired_table[7+(7*(j-1)),"total_yield_increase_kg"] <-
  round((
  as.numeric(Desired_table[1+(7*(j-1)),"total_yield_increase_kg"]) +
  as.numeric(Desired_table[2+(7*(j-1)),"total_yield_increase_kg"]) +
  as.numeric(Desired_table[3+(7*(j-1)),"total_yield_increase_kg"]) +
  as.numeric(Desired_table[4+(7*(j-1)),"total_yield_increase_kg"]) +
  as.numeric(Desired_table[5+(7*(j-1)),"total_yield_increase_kg"]) +
  as.numeric(Desired_table[6+(7*(j-1)),"total_yield_increase_kg"]))
  ,0)
}


# 17) total_yield_increase_perc
for(j in 1:nrow(Scent)){
for(i in 1:6){

Desired_table[i+(7*(j-1)),"total_yield_increase_perc"] <- round(
  mean(nib6[which(nib6$Region == Desired_table[i,"Region"]), paste0(Scent[j,"Abb"],"_seg_yield_gain_kg_ha")]) /
    mean(nib6[which(nib6$Region == Desired_table[i,"Region"]), "yield_kg_ha"]) *
    100
  ,0)
}
Desired_table[7+(7*(j-1)),"total_yield_increase_perc"] <-
  round((
  (as.numeric(Desired_table[1+(7*(j-1)),"total_yield_increase_perc"]) * Desired_table[1+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table[2+(7*(j-1)),"total_yield_increase_perc"]) * Desired_table[2+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table[3+(7*(j-1)),"total_yield_increase_perc"]) * Desired_table[3+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table[4+(7*(j-1)),"total_yield_increase_perc"]) * Desired_table[4+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table[5+(7*(j-1)),"total_yield_increase_perc"]) * Desired_table[5+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table[6+(7*(j-1)),"total_yield_increase_perc"]) * Desired_table[6+(7*(j-1)),"Monsoon_area_ha"]))
  / Desired_table[7+(7*(j-1)),"Monsoon_area_ha"],0)
}



# 18) million_people_fed

## Calculating based on current conusmption
yearly_milled_rice_needs_per_person <- 74.2
milled_rice_per_paddy_rice <- 0.633
yearly_paddy_rice_needs_per_person <- yearly_milled_rice_needs_per_person / milled_rice_per_paddy_rice
people_fed_per_kg_paddy <- 1/yearly_paddy_rice_needs_per_person

# Alternatively, we could calculate based on current rice consumption - 630 g of white rice per day
for(j in 1:nrow(Scent)){
for(i in 1:6){

Desired_table[i+(7*(j-1)),"million_people_fed"] <- round(
  Desired_table[i+(7*(j-1)),"total_yield_increase_kg"] * people_fed_per_kg_paddy / 1000000
  ,0)
}
Desired_table[7+(7*(j-1)),"million_people_fed"] <-
  round(
  as.numeric(Desired_table[1+(7*(j-1)),"million_people_fed"]) +
  as.numeric(Desired_table[2+(7*(j-1)),"million_people_fed"]) +
  as.numeric(Desired_table[3+(7*(j-1)),"million_people_fed"]) +
  as.numeric(Desired_table[4+(7*(j-1)),"million_people_fed"]) +
  as.numeric(Desired_table[5+(7*(j-1)),"million_people_fed"]) +
  as.numeric(Desired_table[6+(7*(j-1)),"million_people_fed"])
  ,0)
}



# 19) Total_crop_revenue_increase_perc
for(j in 1:nrow(Scent)){
for(i in 1:6){

Desired_table[i+(7*(j-1)),"Total_crop_revenue_increase_perc"] <- round(
  sum(nib6[which(nib6$Region == Desired_table[i,"Region"]), paste0(Scent[j,"Abb"],"_seg_yield_gain_kg_ha")])
    / sum(nib6[which(nib6$Region == Desired_table[i,"Region"]), "yield_kg_ha"]) * 100
  ,0)
}
Desired_table[7+(7*(j-1)),"Total_crop_revenue_increase_perc"] <-
  round((
  (as.numeric(Desired_table[1+(7*(j-1)),"Total_crop_revenue_increase_perc"]) * Desired_table[1+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table[2+(7*(j-1)),"Total_crop_revenue_increase_perc"]) * Desired_table[2+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table[3+(7*(j-1)),"Total_crop_revenue_increase_perc"]) * Desired_table[3+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table[4+(7*(j-1)),"Total_crop_revenue_increase_perc"]) * Desired_table[4+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table[5+(7*(j-1)),"Total_crop_revenue_increase_perc"]) * Desired_table[5+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table[6+(7*(j-1)),"Total_crop_revenue_increase_perc"]) * Desired_table[6+(7*(j-1)),"Monsoon_area_ha"]))
  / Desired_table[7+(7*(j-1)),"Monsoon_area_ha"],0)
}

# 20) Total_crop_cost_saving_perc
for(j in 1:nrow(Scent)){
Desired_table[,paste0(Scent[j,"Abb"],".1_Total_crop_cost_saving_perc")] <- NA

for(i in 1:6){

Desired_table[i+(7*(j-1)),paste0(Scent[j,"Abb"],".1_Total_crop_cost_saving_perc")] <- round(
  sum(nib6[which(nib6$Region == Desired_table[i,"Region"]), paste0(Scent[j,"Abb"],"_seg_N_saving_kg_ha")]) /
    sum(nib6[which(nib6$Region == Desired_table[i,"Region"]), "N_kg_ha"]) * 100 * 0.1
  ,0)

Desired_table[i+(7*(j-1)),"Total_crop_cost_saving_perc"] <-
 paste0(Desired_table[i+(7*(j-1)),paste0(Scent[j,"Abb"],".1_Total_crop_cost_saving_perc")]
        )
}
Desired_table[7+(7*(j-1)),"Total_crop_cost_saving_perc"] <- paste0(
  round((
  ((Desired_table[1+(7*(j-1)),paste0(Scent[j,"Abb"],".1_Total_crop_cost_saving_perc")] * Desired_table[1+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table[2+(7*(j-1)),paste0(Scent[j,"Abb"],".1_Total_crop_cost_saving_perc")] * Desired_table[2+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table[3+(7*(j-1)),paste0(Scent[j,"Abb"],".1_Total_crop_cost_saving_perc")] * Desired_table[3+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table[4+(7*(j-1)),paste0(Scent[j,"Abb"],".1_Total_crop_cost_saving_perc")] * Desired_table[4+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table[5+(7*(j-1)),paste0(Scent[j,"Abb"],".1_Total_crop_cost_saving_perc")] * Desired_table[5+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table[6+(7*(j-1)),paste0(Scent[j,"Abb"],".1_Total_crop_cost_saving_perc")] * Desired_table[6+(7*(j-1)),"Monsoon_area_ha"]))
  / Desired_table[7+(7*(j-1)),"Monsoon_area_ha"]),0)
)
}



# 21) mean_Nsurplus_saving_perc_AVERAGING_AGGREGATE

## Scenarios where there is range
for(j in 1:nrow(Scent)){
Desired_table[,paste0(Scent[j,"Abb"],".1_mean_Nsurplus_saving_perc_AVERAGING_AGGREGATE")] <- NA

for(i in 1:6){

Desired_table[i+(7*(j-1)),paste0(Scent[j,"Abb"],".1_mean_Nsurplus_saving_perc_AVERAGING_AGGREGATE")] <- round(
  mean(nib6[which(nib6$Region == Desired_table[i,"Region"]), paste0(Scent[j,"Abb"],"_seg_N_surplus_saving_kg_ha")])
  / mean(nib6[which(nib6$Region == Desired_table[i,"Region"]), "N_balance_ladha"]) * 100
  ,0)

Desired_table[i+(7*(j-1)),"mean_Nsurplus_saving_perc_AVERAGING_AGGREGATE"] <-
 paste0(Desired_table[i+(7*(j-1)),paste0(Scent[j,"Abb"],".1_mean_Nsurplus_saving_perc_AVERAGING_AGGREGATE")]
        )
}
Desired_table[7+(7*(j-1)),"mean_Nsurplus_saving_perc_AVERAGING_AGGREGATE"] <- paste0(
  round(
  ((Desired_table[1+(7*(j-1)),paste0(Scent[j,"Abb"],".1_mean_Nsurplus_saving_perc_AVERAGING_AGGREGATE")] * Desired_table[1+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table[2+(7*(j-1)),paste0(Scent[j,"Abb"],".1_mean_Nsurplus_saving_perc_AVERAGING_AGGREGATE")] * Desired_table[2+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table[3+(7*(j-1)),paste0(Scent[j,"Abb"],".1_mean_Nsurplus_saving_perc_AVERAGING_AGGREGATE")] * Desired_table[3+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table[4+(7*(j-1)),paste0(Scent[j,"Abb"],".1_mean_Nsurplus_saving_perc_AVERAGING_AGGREGATE")] * Desired_table[4+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table[5+(7*(j-1)),paste0(Scent[j,"Abb"],".1_mean_Nsurplus_saving_perc_AVERAGING_AGGREGATE")] * Desired_table[5+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table[6+(7*(j-1)),paste0(Scent[j,"Abb"],".1_mean_Nsurplus_saving_perc_AVERAGING_AGGREGATE")] * Desired_table[6+(7*(j-1)),"Monsoon_area_ha"]))
   / Desired_table[7+(7*(j-1)),"Monsoon_area_ha"]
  ,0)

)
}

# 22) Total_monsoon_subsidy_saving_perc
for(j in 1:nrow(Scent)){
Desired_table[,paste0(Scent[j,"Abb"],".1_Total_monsoon_subsidy_saving_perc")] <- NA

for(i in 1:6){

Desired_table[i+(7*(j-1)),paste0(Scent[j,"Abb"],".1_Total_monsoon_subsidy_saving_perc")] <- round(
  sum(nib6[which(nib6$Region == Desired_table[i,"Region"]), paste0(Scent[j,"Abb"],"_seg_N_saving_kg_ha")]) /
    sum(nib6[which(nib6$Region == Desired_table[i,"Region"]), "N_kg_ha"]) * 100
  ,0)
Desired_table[i+(7*(j-1)),"Total_monsoon_subsidy_saving_perc"] <-
 paste0(Desired_table[i+(7*(j-1)),paste0(Scent[j,"Abb"],".1_Total_monsoon_subsidy_saving_perc")]
        )
}
Desired_table[7+(7*(j-1)),"Total_monsoon_subsidy_saving_perc"] <- paste0(
  round((
  ((Desired_table[1+(7*(j-1)),paste0(Scent[j,"Abb"],".1_Total_monsoon_subsidy_saving_perc")] * Desired_table[1+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table[2+(7*(j-1)),paste0(Scent[j,"Abb"],".1_Total_monsoon_subsidy_saving_perc")] * Desired_table[2+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table[3+(7*(j-1)),paste0(Scent[j,"Abb"],".1_Total_monsoon_subsidy_saving_perc")] * Desired_table[3+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table[4+(7*(j-1)),paste0(Scent[j,"Abb"],".1_Total_monsoon_subsidy_saving_perc")] * Desired_table[4+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table[5+(7*(j-1)),paste0(Scent[j,"Abb"],".1_Total_monsoon_subsidy_saving_perc")] * Desired_table[5+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table[6+(7*(j-1)),paste0(Scent[j,"Abb"],".1_Total_monsoon_subsidy_saving_perc")] * Desired_table[6+(7*(j-1)),"Monsoon_area_ha"]))
  / Desired_table[7+(7*(j-1)),"Monsoon_area_ha"]),0)
)
}



```

3.15) Visualsing implications of potential NUE increases (Table 1)

```{r}
library('splitstackshape')
library("htmltools")
library("webshot")
library("formattable")


# Merge columns
Desired_table$mean_N_saving_perc_AND_kgha <- paste0(Desired_table$Total_monsoon_subsidy_saving_perc,
                                                    "% (",
                                                    Desired_table$mean_N_saving_kg_ha,
                                                    "kg/ha)")
Desired_table$mean_yield_increase_perc_AND_kgha <- paste0(Desired_table$total_yield_increase_perc,
                                                    "% (",
                                                    Desired_table$mean_yield_increase_kg_ha,
                                                    "kg/ha)")
Desired_table$mean_NUE_increase_perc_AND_kgha <- paste0(Desired_table$mean_NUE_change_perc,
                                                    "% (",
                                                    Desired_table$mean_NUE_change_absolute,
                                                    "kg/kg)")
Desired_table$mean_revenue_increase_perc_AND_kgha <- paste0(Desired_table$Total_crop_revenue_increase_perc,
                                                    "% ($",
                                                    Desired_table$mean_revenue_increase_USD_ha,
                                                    "/ha)")
Desired_table$mean_cropCost_saving_perc_AND_kgha <- paste0(Desired_table$Total_crop_cost_saving_perc,
                                                    "% ($",
                                                    Desired_table$mean_Nsaving_USD_ha,
                                                    "/ha)")
Desired_table$mean_Nsurplus_saving_perc_AND_kgha <- paste0(Desired_table$mean_Nsurplus_saving_perc_AVERAGING_AGGREGATE,
                                                    "% (",
                                                    Desired_table$mean_Nsurplus_saving_kg_ha,
                                                    "kg/ha)")
Desired_table$mean_Nsubsidy_saving_perc_AND_kgha <- paste0(Desired_table$Total_monsoon_subsidy_saving_perc,
                                                    "% ($",
                                                    Desired_table$N_subsidy_saving_USDperha,
                                                    "/ha)")


# Make comprehensive table
all_cols <- c(
  # Descriptive
  "Scenario"
  ,"Region"
  ,"Monsoon_area_ha"
  # Basic
  ,"percentage_Nsavers"
  ,"mean_N_saving_kg_ha"
  ,"mean_yield_increase_kg_ha"
  # NUE
  ,"mean_NUE_change_perc"
  ,"mean_NUE_change_absolute"
  # Food security
  ,"total_yield_increase_kg"
  ,"total_yield_increase_perc"
  ,"million_people_fed"
  # Livelihoods
  ,"FarmerCost_USDperKGofN"
  ,"FarmerRevenue_USDperKGofPaddy"
  ,"mean_Nsaving_USD_ha"
  ,"Total_crop_cost_saving_perc"
  ,"Total_crop_revenue_increase_perc"
  ,"mean_revenue_increase_USD_ha"
  # Environment
  ,"mean_Nsurplus_saving_kg_ha"
  ,"total_Nsurplus_saving_kg"
  ,"mean_Nsurplus_saving_perc_AVERAGING_AGGREGATE"
  # Government
  ,"Subsidy_USDperKGofN"
  ,"N_subsidy_saving_millionUSD"
  ,"Total_monsoon_subsidy_saving_perc"
  ,"N_subsidy_saving_USDperha"
)

Comprehensive_table <- Desired_table[,all_cols]

# Rename rows
Comprehensive_table[which(Comprehensive_table$Scenario == "Scenario_1"),"Scenario"] <- "Cut excess N"
Comprehensive_table[which(Comprehensive_table$Scenario == "Scenario_2"),"Scenario"] <- "Increase yield"
Comprehensive_table[which(Comprehensive_table$Scenario == "Scenario_3"),"Scenario"] <- "Cut excess N and increase yield"

Comprehensive_table[which(Comprehensive_table$Region == "AP"),"Region"] <- "Andhra Pradesh"
Comprehensive_table[which(Comprehensive_table$Region == "Bihar"),"Region"] <- "Bihar & eastern Uttar Pradesh"
Comprehensive_table[which(Comprehensive_table$Region == "Bangladesh"),"Region"] <- "Bangladesh Plains"
Comprehensive_table[which(Comprehensive_table$Region == "Nepal"),"Region"] <- "Nepal Terai"
Comprehensive_table[which(Comprehensive_table$Region == "Punjab_Haryana"),"Region"] <- "Punjab & Haryana"

# Rename columns
colnames(Comprehensive_table)[which(names(Comprehensive_table) == "Monsoon_area_ha")] <- "Monsoon_rice_area_ha"
colnames(Comprehensive_table)[which(names(Comprehensive_table) == "percentage_Nsavers")] <- "Percentage_of_crops_with_excess_N"
colnames(Comprehensive_table)[which(names(Comprehensive_table) == "total_yield_increase_perc")] <- "total_yield_increase_percent"
colnames(Comprehensive_table)[which(names(Comprehensive_table) == "million_people_fed")] <- "million_people_fed_through_increased_yield"
colnames(Comprehensive_table)[which(names(Comprehensive_table) == "Total_crop_cost_saving_perc")] <- "Total_crop_cost_saving_percent"
colnames(Comprehensive_table)[which(names(Comprehensive_table) == "Total_crop_revenue_increase_perc")] <- "Total_crop_revenue_increase_percent"
colnames(Comprehensive_table)[which(names(Comprehensive_table) == "mean_Nsurplus_saving_perc_AVERAGING_AGGREGATE")] <- "mean_Nsurplus_saving_percent"
colnames(Comprehensive_table)[which(names(Comprehensive_table) == "Total_monsoon_subsidy_saving_perc")] <- "Total_monsoon_subsidy_saving_percent"

# save table
setwd('[insert working directory]')
write.csv(Comprehensive_table, "ExtendedData.csv")

# Make detailed table

## Define columns
all_wanted_cols <- c(
  # Descriptive
  "Scenario"
  ,"Region"
  # ,"Monsoon_area_ha"
  # Basic
  # ,"percentage_Nsavers"
  ,"mean_N_saving_kg_ha"
  ,"mean_yield_increase_kg_ha"
  # Food security
  # ,"total_yield_increase_kg"
  ,"total_yield_increase_perc"
  # ,"million_people_fed"
  # Livelihoods
  # ,"FarmerCost_USDperKGofN"
  # ,"FarmerRevenue_USDperKGofPaddy"
  ,"mean_Nsaving_USD_ha"
  ,"Total_crop_cost_saving_perc"
  # ,"Total_crop_revenue_increase_perc"
  ,"mean_revenue_increase_USD_ha"
  # Environment
  ,"mean_Nsurplus_saving_kg_ha"
  # ,"total_Nsurplus_saving_kg"
  ,"mean_Nsurplus_saving_perc_AVERAGING_AGGREGATE"
  # Government
  # ,"Subsidy_USDperKGofN"
  # ,"N_subsidy_saving_millionUSD"
  ,"Total_monsoon_subsidy_saving_perc"
  ,"N_subsidy_saving_USDperha"
)
wanted_detailed_table <- Desired_table[,all_wanted_cols]


## Add percentages
for(i in 1:nrow(wanted_detailed_table)){
wanted_detailed_table[i,"total_yield_increase_perc"] <- paste0(wanted_detailed_table[i,"total_yield_increase_perc"], "%")
wanted_detailed_table[i,"Total_crop_cost_saving_perc"] <- paste0(wanted_detailed_table[i,"Total_crop_cost_saving_perc"], "%")
wanted_detailed_table[i,"mean_Nsurplus_saving_perc_AVERAGING_AGGREGATE"] <- paste0(wanted_detailed_table[i,"mean_Nsurplus_saving_perc_AVERAGING_AGGREGATE"], "%")
wanted_detailed_table[i,"Total_monsoon_subsidy_saving_perc"] <- paste0(wanted_detailed_table[i,"Total_monsoon_subsidy_saving_perc"], "%")
}

## Rename scenarios
wanted_detailed_table[which(wanted_detailed_table$Scenario == "Scenario_1"),"Scenario"] <- "CutNexcess"
wanted_detailed_table[which(wanted_detailed_table$Scenario == "Scenario_2"),"Scenario"] <- "Q50yieldgap"
wanted_detailed_table[which(wanted_detailed_table$Scenario == "Scenario_3"),"Scenario"] <- "Q50yieldgap_AND_CutNexcess"

## Present detailed table
aggregate_rows_format <- formatter("span", style = ~style("font.weight" = "bold", "font.size" = "8", 'color' = 'black'))

# Make nice summary table
summary_cols <- c("Scenario",
                             "total_yield_increase_perc", # Food security
                             "Total_crop_cost_saving_perc", # Rural livelihoods
                             "mean_Nsurplus_saving_perc_AVERAGING_AGGREGATE", # Environment
                             "Total_monsoon_subsidy_saving_perc")
summary_rows <- which(wanted_detailed_table$Region == "Aggregated" &
                        wanted_detailed_table$Scenario == "CutNexcess" |
                        wanted_detailed_table$Region == "Aggregated" &
                        wanted_detailed_table$Scenario == "Q50yieldgap" |
                        wanted_detailed_table$Region == "Aggregated" &
                        wanted_detailed_table$Scenario == "Q50yieldgap_AND_CutNexcess")
wanted_summary_table <- wanted_detailed_table[summary_rows, summary_cols]



## Make with perc and per ha numbers
merged_cols <- c(
  "mean_NUE_increase_perc_AND_kgha"
  ,"mean_N_saving_perc_AND_kgha"
  ,"mean_yield_increase_perc_AND_kgha"
  ,"mean_revenue_increase_perc_AND_kgha"
  ,"mean_cropCost_saving_perc_AND_kgha"
  ,"mean_Nsurplus_saving_perc_AND_kgha"
  ,"mean_Nsubsidy_saving_perc_AND_kgha"
)

## Seleect columns and rows
wellin_table <- Desired_table[summary_rows,c("Scenario",merged_cols)]

## Rename scenarios for summary
wellin_table[1,"Scenario"] <- "Pathway 1: Maintain yield, Cut excess N"
wellin_table[2,"Scenario"] <- "Pathway 2: Increase yield, Maintain N"
wellin_table[3,"Scenario"] <- "Pathway 1&2: Increase yield, Cut excess N"

## Custom formatting
Bespoke2 <- formatter(
                  "span",
                  style = x ~ style(
                    display = "inline-block",
                    color = "black",
                    "border-radius" = "4px",
                    "padding-right" = "4px",
                    width = "70px"))
#                     "background-color" = ifelse(as.character(x) == "0%", colorRampPalette(c("lemonchiffon", "forestgreen"))(40)[0],
#                                                          ifelse(as.character(x) == "22% (10kg/kg)", colorRampPalette(c("lemonchiffon", "forestgreen"))(40)[22],
#                                                          ifelse(as.character(x) == "7% (3kg/kg)", colorRampPalette(c("lemonchiffon", "forestgreen"))(40)[7],
#                                                          ifelse(as.character(x) == "32% (14kg/kg)", colorRampPalette(c("lemonchiffon", "forestgreen"))(40)[37],
#                                                          ifelse(as.character(x) == "17% (18kg/ha)", colorRampPalette(c("lemonchiffon", "forestgreen"))(40)[19],
#                                                          ifelse(as.character(x) == "0% (0kg/ha)", colorRampPalette(c("lemonchiffon", "forestgreen"))(40)[0],
#                                                          ifelse(as.character(x) == "0% ($0/ha)", colorRampPalette(c("lemonchiffon", "forestgreen"))(40)[0],
#                                                          ifelse(as.character(x) == "2% ($6/ha)", colorRampPalette(c("lemonchiffon", "forestgreen"))(40)[2],
#                                                          ifelse(as.character(x) == "27% (18kg/ha)", colorRampPalette(c("lemonchiffon", "forestgreen"))(40)[31],
#                                                          ifelse(as.character(x) == "17% ($14/ha)", colorRampPalette(c("lemonchiffon", "forestgreen"))(40)[19],
#                                                          ifelse(as.character(x) == "0% (0kg/ha)", colorRampPalette(c("lemonchiffon", "forestgreen"))(40)[0],
#                                                          ifelse(as.character(x) == "8% (369kg/ha)", colorRampPalette(c("lemonchiffon", "forestgreen"))(40)[8],
#                                                          ifelse(as.character(x) == "8% ($94/ha)", colorRampPalette(c("lemonchiffon", "forestgreen"))(40)[8],
#                                                          ifelse(as.character(x) == "0% ($0/ha)", colorRampPalette(c("lemonchiffon", "forestgreen"))(40)[0],
#                                                          ifelse(as.character(x) == "9% (6kg/ha)", colorRampPalette(c("lemonchiffon", "forestgreen"))(40)[9],
#                                                          ifelse(as.character(x) == "0% ($0/ha)", colorRampPalette(c("lemonchiffon", "forestgreen"))(40)[0],
#                                                          ifelse(as.character(x) == "17% (18kg/ha)",
# colorRampPalette(c("lemonchiffon", "forestgreen"))(40)[19],
#                                                          ifelse(as.character(x) == "8% (369kg/ha)", colorRampPalette(c("lemonchiffon", "forestgreen"))(40)[8],
#                                                          ifelse(as.character(x) == "8% ($94/ha)", colorRampPalette(c("lemonchiffon", "forestgreen"))(40)[8],
#                                                          ifelse(as.character(x) == "2% ($6/ha)",
# colorRampPalette(c("lemonchiffon", "forestgreen"))(40)[2],
#                                                          ifelse(as.character(x) == "36% (24kg/ha)", colorRampPalette(c("lemonchiffon", "forestgreen"))(40)[40],
#                                                          ifelse(as.character(x) == "17% ($14/ha)", colorRampPalette(c("lemonchiffon", "forestgreen"))(40)[19],
#                                               "red"

Scenario_format <- formatter(
                  "span",
                  style = x ~ style(
                    display = "inline-block",
                    color = "black",
                    "border-radius" = "4px",
                    "padding-right" = "4px",
                    width = "100px"))

## Display table
Table1 <- formattable(wellin_table,
            col.names = c("Scenario","NUE<br>increase","Nitrogen<br>fertilizer<br>saving","FOOD<br>SECURITY:<br>Yield<br>increase","FARMERS:<br>Revenue<br>increase", "FARMERS:<br>Crop cost<br>saving", "ENVIRONMENT:<br>Reduction in<br>excess<br>nitrogen", "GOVERNMENTS:<br>Monsoon<br>nitrogen subsidy<br>saving"),
            row.names = F,
            align = "c",
            list(
              Scenario = Scenario_format,
              mean_N_saving_perc_AND_kgha = Bespoke2,
              mean_yield_increase_perc_AND_kgha = Bespoke2,
              mean_NUE_increase_perc_AND_kgha = Bespoke2,
              mean_revenue_increase_perc_AND_kgha = Bespoke2,
              mean_cropCost_saving_perc_AND_kgha = Bespoke2,
              mean_Nsurplus_saving_perc_AND_kgha = Bespoke2,
              mean_Nsubsidy_saving_perc_AND_kgha = Bespoke2
            ))

# save table
setwd('[insert working directory]')

export_formattable <- function(f, file, width = "80%", height = 600, 
                               background = "white", delay = 0.2, zoom = 10)
    {
      w <- as.htmlwidget(f, width = width, height = height)
      path <- html_print(w, background = background, viewer = NULL)
      url <- paste0("file:///", gsub("\\\\", "/", normalizePath(path)))
      webshot(url,
              file = file,
              selector = ".formattable_widget",
              delay = delay,
              zoom = zoom)
    }

export_formattable(Table1,"Table1.png")

```

3.16) Robustness check for Table 1 (Table S8 in Supplementary Information 11)

```{r}
# PART 1) Calculating potential yiled increase and N saving

nib9 <- nib6 # replicating nib6 but testing results without key assumnption underpinning table 1
regs2 <- regs

# Calculating potential N saving
nib9$potential_N <- NA
nib9$seg_N_saving_kg_ha <- NA

for(i in 1:nrow(regs2)){
region <- regs2[i,"Region"]
nib9[which(nib9$Region == region), "potential_N"] <- regs2[i, "N_rate_breakpoint"]
nib9[which(nib9$Region == region), "seg_N_saving_kg_ha"] <- 
  nib9[which(nib9$Region == region), "N_kg_ha"] - 
  nib9[which(nib9$Region == region), "potential_N"]
}
nib9[which(nib9$seg_N_saving_kg_ha < 0), "seg_N_saving_kg_ha"] <- 0

# Calculating potential yield gain
nib9$x <- nib9$N_kg_ha
nib9[which(nib9$N_kg_ha > nib9$potential_N), "x"] <- 
  nib9[which(nib9$N_kg_ha > nib9$potential_N), "potential_N"]

nib9$predicted_yield_SHAP <- NA
nib9$seg_predicted_yield_kg_ha <- NA
nib9$seg_yield_gain_kg_ha <- NA

for(i in 1:nrow(regs2)){
region <- regs2[i,"Region"]
nib9[which(nib9$Region == region), "predicted_yield_SHAP"] <- predict(get(paste0("segmented.mod_",region)),
                                                                      nib9[which(nib9$Region == region),])
nib9[which(nib9$Region == region), "seg_predicted_yield_kg_ha"] <- 
  nib9[which(nib9$Region == region), "predicted_yield_SHAP"] +
  mean(get(paste0("RF_yieldALLN_", region))$predictions) # Average predicted yield for this region

nib9[which(nib9$Region == region), "seg_yield_gain_kg_ha"] <- 
  nib9[which(nib9$Region == region), "seg_predicted_yield_kg_ha"] -
  nib9[which(nib9$Region == region), "yield_kg_ha"]
}

## REMOVE KEY ASSUMPTION FOR SENSITIVITY ANALYSIS
# Prevent low N farmers from mining
# nib9[which(nib9$N_kg_ha < 50), "seg_yield_gain_kg_ha"] <- 0 # Assumption remove
# nib9[which(nib9$N_kg_ha < 100 & nib9$Region == "Punjab_Haryana"), "seg_yield_gain_kg_ha"] <- 0 

# Remove negative yield gains
nib9[which(nib9$seg_yield_gain_kg_ha < 0), "seg_yield_gain_kg_ha"] <- 0

# Calculate regional average
regs2$mean_potential_yield_gain_kg_ha <- "tbc"
for(i in 1:nrow(regs2)){
regs2[i,"mean_potential_yield_gain_kg_ha"] <- mean(nib9[which(nib9$Region == regs2[i, "Region"]), "seg_yield_gain_kg_ha"])
}


# Calculating implications for surplus
nib9$seg_yield_gain_kg_ha_GrainDM <- nib9$seg_yield_gain_kg_ha * DM_perc
nib9$seg_yield_gain_kg_ha_GrainN <- nib9$seg_yield_gain_kg_ha_GrainDM * Grain_N_perc
nib9$seg_yield_gain_kg_ha_StrawDM <- (nib9$seg_yield_gain_kg_ha_GrainDM / Harvest_index) - nib9$seg_yield_gain_kg_ha_GrainDM
nib9$seg_yield_gain_kg_ha_StrawN <- nib9$seg_yield_gain_kg_ha_StrawDM * Straw_N_perc
nib9$seg_yield_gain_kg_ha_NoutputGAIN <- nib9$seg_yield_gain_kg_ha_GrainN + nib9$seg_yield_gain_kg_ha_StrawN
nib9$seg_yield_gain_kg_ha_NbalanceCHANGE <- nib9$N_balance_ladha - nib9$seg_yield_gain_kg_ha_NoutputGAIN


# Fitting different scenarios
## Scenario 1 = N saving
## Scenario 2 = Q50 yield gain
## Scenario 3 = both

nib9$S1_seg_N_saving_kg_ha <- nib9$seg_N_saving_kg_ha
nib9$S2_seg_N_saving_kg_ha <- 0
nib9$S3_seg_N_saving_kg_ha <- nib9$seg_N_saving_kg_ha

nib9$S1_seg_yield_gain_kg_ha <- 0
nib9$S2_seg_yield_gain_kg_ha <- nib9$seg_yield_gain_kg_ha
nib9$S3_seg_yield_gain_kg_ha <- nib9$seg_yield_gain_kg_ha

nib9$S1_seg_N_surplus_saving_kg_ha <- nib9$seg_N_saving_kg_ha
nib9$S2_seg_N_surplus_saving_kg_ha <- nib9$seg_yield_gain_kg_ha_NoutputGAIN
nib9$S3_seg_N_surplus_saving_kg_ha <- nib9$seg_N_saving_kg_ha + nib9$seg_yield_gain_kg_ha_NoutputGAIN

# PART 2) Visualising potential NUE increases 

library(segmented)
library(ggplot2)

regs2$average_yield_kg_ha <- "tbc"

for(i in 1:nrow(regs2)){
# Find fitted model
region <- regs2[i,"Region"]
x = as.numeric(nib7[which(nib7$Region == region),"N_kg_ha"])
y = as.numeric(nib7[which(nib7$Region == region),"SHAP_N_kg_ha"])
yield_kg_ha <- as.numeric(nib7[which(nib7$Region == region),"yield_kg_ha"])
Region <- nib7[which(nib7$Region == region),"Region"]

fit <- numeric(length(x)) * NA
fit[complete.cases(rowSums(cbind(y, x)))] <- broken.line(get(paste0("segmented.mod_",region)))$fit
data1 <- data.frame(x = x, y = y, fit = fit, yield_kg_ha = yield_kg_ha, Region = Region)
# Convert relative difference to actual difference
regs2[i,"average_yield_kg_ha"] <- mean(get(paste0("RF_yieldALLN_",region))$predictions)
data1$fit <- as.numeric(regs2[i,"average_yield_kg_ha"]) + data1$fit
# Fit production function to raw data
plot <- ggplot() +
  geom_point(data = data1, aes(x = x, y = yield_kg_ha), color = 'grey', alpha = 0.3) +
  geom_line(data = data1, aes(x = x, y = fit), color = 'black') +
  theme_bw()
print(plot)
# Assign dataset data
assign(paste("prodfunc_",region,sep = ""),data1)
}

prodfunc_Punjab_Haryana <- prodfunc_Punjab_Haryana[-which(prodfunc_Punjab_Haryana$x < 100),]
prodfunc_Odisha <- prodfunc_Odisha[-which(prodfunc_Odisha$x > 150),]

ggplot() +
  geom_line(data = get(paste0("prodfunc_", "AP")), aes(x = x, y = fit, color = 'Andhra Pradesh')) +
  geom_line(data = get(paste0("prodfunc_", "Bangladesh")), aes(x = x, y = fit, color = 'Bangladesh')) +
  geom_line(data = get(paste0("prodfunc_", "Bihar")), aes(x = x, y = fit, color = 'Bihar & E.U.P.')) +
  geom_line(data = get(paste0("prodfunc_", "Nepal")), aes(x = x, y = fit, color = 'Nepal')) +
  geom_line(data = get(paste0("prodfunc_", "Odisha")), aes(x = x, y = fit, color = 'Odisha')) +
  geom_line(data = get(paste0("prodfunc_", "Punjab_Haryana")), aes(x = x, y = fit, color = 'Punjab & Haryana')) +
  ggtitle("") +
  scale_color_manual(name='Region',
                     breaks=c('Andhra Pradesh', 'Bangladesh', 'Bihar & E.U.P.', 'Nepal', 'Odisha', 'Punjab & Haryana'),
                     values=c('Andhra Pradesh' = 'dark grey', 'Bangladesh' = 'dark green', 'Bihar & E.U.P.' = 'black', 'Nepal' = 'dark red', 'Odisha' = 'blue', 'Punjab & Haryana' = 'orange')) +
  theme_bw() +
  ylim(c(0,7000)) +
  labs(x = "N rate (kg/ha)", y = "Predicted yield (kg/ha)") +
  theme(legend.position="none") +
  theme(axis.text=element_text(size=10), axis.title=element_text(size=13))

# Showcasing 
nib9$Pathway <- "No pathway"
nib9[which(nib9$seg_N_saving_kg_ha > 0), "Pathway"] <- "Pathway 1"
nib9[which(nib9$seg_yield_gain_kg_ha > 0), "Pathway"] <- "Pathway 2"
nib9[which(nib9$seg_N_saving_kg_ha > 0 & nib9$seg_yield_gain_kg_ha > 0), "Pathway"] <- "Pathway 1&2"

for(i in 1:nrow(regs2)){
print(
ggplot() +
  ggtitle(regs2[i,"Region_figurename"]) +
  geom_point(data = nib9[which(nib9$Region == regs2[i,"Region"]),], aes (N_kg_ha,yield_kg_ha, colour = Pathway)) +
  scale_color_manual(name='Pathway',
                     values=c('Pathway 1' = 'yellow3', 'Pathway 2' = ' dark blue', 'Pathway 1&2' = 'dark green', 'No pathway' = 'grey')) +
  geom_line(data = get(paste0("prodfunc_", regs2[i,"Region"])), aes(x = x, y = fit), colour = 'red', size = 1.5) +
  theme_bw() +
  ylim(c(0,10000)) +
  labs(x = "N rate (kg/ha)", y = "Predicted yield (kg/ha)") +
  theme(axis.text=element_text(size=10), axis.title=element_text(size=13)) +
  theme(legend.position=c(0.92,0.15))
)
}

# PART 3) Calculating practicval implications

# Design table
Desired_table2 <- data.frame(c(regs2$Region,"Aggregated",
                              regs2$Region,"Aggregated",
                              regs2$Region,"Aggregated"))
colnames(Desired_table2)[1] <- "Region"
Desired_table2$Scenario <- "tbc"
Desired_table2[1:7,"Scenario"] <- "Scenario_1"
Desired_table2[8:14,"Scenario"] <- "Scenario_2"
Desired_table2[15:21,"Scenario"] <- "Scenario_3"

Scen <- c("Scenario_1",
          "Scenario_2",
          "Scenario_3")
Scent2 <- data.frame(Scen)
Scent2$Abb <- c("S1","S2","S3")

# Input price and subsidy assumptions defined in Table S4 Supplementary information 5

## Bangladesh

### Gov N subsidy
Bangladesh_subsidy_Tk_per_urea_kg <- 21 
Bangladesh_subsidy_Tk_per_N_kg <- Bangladesh_subsidy_Tk_per_urea_kg / 0.46
Bangladesh_subsidy_USD_per_N_kg <- Bangladesh_subsidy_Tk_per_N_kg / 106.0933

### Farmer N cost
Bangladesh_farmercost_Tk_per_urea_kg <- 27 
Bangladesh_farmercost_Tk_per_N_kg <- Bangladesh_farmercost_Tk_per_urea_kg / 0.46
Bangladesh_farmercost_USD_per_N_kg <- Bangladesh_farmercost_Tk_per_N_kg / 106.0933

### Farmer paddy price
Bangladesh_paddy_price_Tk_per_kg <- 30 
Bangladesh_paddy_price_USD_per_kg <- Bangladesh_paddy_price_Tk_per_kg / 106.0933

## Nepal

### Gov N subsidy
Nepal_subsidy_NepalRupees_per_urea_kg <- (25 / (100-64.49)) * 64.49 
Nepal_subsidy_NepalRupees_per_N_kg <- Nepal_subsidy_NepalRupees_per_urea_kg / 0.46
Nepal_subsidy_USD_per_N_kg <- Nepal_subsidy_NepalRupees_per_N_kg / 131.38 

### Farmer N cost
Nepal_farmercost_NepalRs_per_urea_kg <- 25 
Nepal_farmercost_NepalRs_per_N_kg <- Nepal_farmercost_NepalRs_per_urea_kg / 0.46
Nepal_farmercost_USD_per_N_kg <- Nepal_farmercost_NepalRs_per_N_kg / 131.38

### Farmer paddy price
Nepal_paddy_price_Rs_per_quintal <- 2752 
Nepal_paddy_price_Rs_per_kg <- Nepal_paddy_price_Rs_per_quintal / 100
Nepal_paddy_price_USD_per_kg <- Nepal_paddy_price_Rs_per_kg / 131.38

## India 

### Gov N subsidy
India_subsidy_Rs_per_N_kg <- 76 
India_subsidy_USD_per_N_kg <- India_subsidy_Rs_per_N_kg / 82.726

### Farmer N cost
India_farmercost_IndiaRs_per_urea_kg <- 276 / 45 
India_farmercost_IndiaRs_per_N_kg <- India_farmercost_IndiaRs_per_urea_kg / 0.46
India_farmercost_USD_per_N_kg <- India_farmercost_IndiaRs_per_N_kg / 82.726

### Farmer paddy price 
India_paddy_price_Rs_per_quintal <- 2040
India_paddy_price_Rs_per_kg <- India_paddy_price_Rs_per_quintal / 100
India_paddy_price_USD_per_kg <- India_paddy_price_Rs_per_kg / 82.726

# 1) Monsoon_area_ha
Desired_table2[which(Desired_table2$Region == "Bihar"),"Monsoon_area_ha"] <- regs2[which(regs2$Region == "Bihar"), "Monsoon_area_ha"]
Desired_table2[which(Desired_table2$Region == "Odisha"),"Monsoon_area_ha"] <- regs2[which(regs2$Region == "Odisha"), "Monsoon_area_ha"] 
Desired_table2[which(Desired_table2$Region == "AP"),"Monsoon_area_ha"] <-  regs2[which(regs2$Region == "AP"), "Monsoon_area_ha"]
Desired_table2[which(Desired_table2$Region == "Nepal"),"Monsoon_area_ha"] <- regs2[which(regs2$Region == "Nepal"), "Monsoon_area_ha"]
Desired_table2[which(Desired_table2$Region == "Bangladesh"),"Monsoon_area_ha"] <- regs2[which(regs2$Region == "Bangladesh"), "Monsoon_area_ha"]
Desired_table2[which(Desired_table2$Region == "Punjab_Haryana"),"Monsoon_area_ha"] <- regs2[which(regs2$Region == "Punjab_Haryana"), "Monsoon_area_ha"]
Desired_table2[which(Desired_table2$Region == "Aggregated"),"Monsoon_area_ha"] <- 
  (Desired_table2[1,"Monsoon_area_ha"] +
  Desired_table2[2,"Monsoon_area_ha"] +
  Desired_table2[3,"Monsoon_area_ha"] +
  Desired_table2[4,"Monsoon_area_ha"] +
  Desired_table2[5,"Monsoon_area_ha"] +
  Desired_table2[6,"Monsoon_area_ha"])
  

# 2) percentage_Nsavers

## Range involved
for(j in 1:nrow(Scent2)){
Desired_table2[,paste0(Scent2[j,"Abb"],".1_percentage_Nsavers")] <- NA

for(i in 1:6){

Desired_table2[i+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_percentage_Nsavers")] <- round(
  length(which(nib9$Region == Desired_table2[i,"Region"] & nib9[,paste0(Scent2[j,"Abb"],"_seg_N_saving_kg_ha")] > 0)) / 
  length(which(nib9$Region == Desired_table2[i,"Region"])) * 100
  ,0)
Desired_table2[i+(7*(j-1)),"percentage_Nsavers"] <- 
 paste0(Desired_table2[i+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_percentage_Nsavers")], 
        "%")
}
Desired_table2[7+(7*(j-1)),"percentage_Nsavers"] <- paste0(
  round((
  ((Desired_table2[1+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_percentage_Nsavers")] * Desired_table2[1+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table2[2+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_percentage_Nsavers")] * Desired_table2[2+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table2[3+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_percentage_Nsavers")] * Desired_table2[3+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table2[4+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_percentage_Nsavers")] * Desired_table2[4+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table2[5+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_percentage_Nsavers")] * Desired_table2[5+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table2[6+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_percentage_Nsavers")] * Desired_table2[6+(7*(j-1)),"Monsoon_area_ha"]))
  / Desired_table2[7+(7*(j-1)),"Monsoon_area_ha"]),0),
  "%"
)
}

# 3) mean_N_saving_kg_ha
for(j in 1:nrow(Scent2)){
Desired_table2[,paste0(Scent2[j,"Abb"],".1_mean_N_saving_kg_ha")] <- NA

for(i in 1:6){

Desired_table2[i+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_mean_N_saving_kg_ha")] <- round(
  mean(nib9[which(nib9$Region == Desired_table2[i,"Region"]), paste0(Scent2[j,"Abb"],"_seg_N_saving_kg_ha")])
  ,0)
Desired_table2[i+(7*(j-1)),"mean_N_saving_kg_ha"] <- 
 paste0(Desired_table2[i+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_mean_N_saving_kg_ha")] 
        )
}
Desired_table2[7+(7*(j-1)),"mean_N_saving_kg_ha"] <- paste0(
  round((
  ((Desired_table2[1+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_mean_N_saving_kg_ha")] * Desired_table2[1+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table2[2+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_mean_N_saving_kg_ha")] * Desired_table2[2+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table2[3+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_mean_N_saving_kg_ha")] * Desired_table2[3+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table2[4+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_mean_N_saving_kg_ha")] * Desired_table2[4+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table2[5+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_mean_N_saving_kg_ha")] * Desired_table2[5+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table2[6+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_mean_N_saving_kg_ha")] * Desired_table2[6+(7*(j-1)),"Monsoon_area_ha"]))
  / Desired_table2[7+(7*(j-1)),"Monsoon_area_ha"]),0)
)
}

# 4) mean_yield_increase_kg_ha
for(j in 1:nrow(Scent2)){
for(i in 1:6){

Desired_table2[i+(7*(j-1)),"mean_yield_increase_kg_ha"] <- round(
  mean(nib9[which(nib9$Region == Desired_table2[i,"Region"]), paste0(Scent2[j,"Abb"],"_seg_yield_gain_kg_ha")])
  ,0)
}
Desired_table2[7+(7*(j-1)),"mean_yield_increase_kg_ha"] <- 
  round((
  (as.numeric(Desired_table2[1+(7*(j-1)),"mean_yield_increase_kg_ha"]) * Desired_table2[1+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table2[2+(7*(j-1)),"mean_yield_increase_kg_ha"]) * Desired_table2[2+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table2[3+(7*(j-1)),"mean_yield_increase_kg_ha"]) * Desired_table2[3+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table2[4+(7*(j-1)),"mean_yield_increase_kg_ha"]) * Desired_table2[4+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table2[5+(7*(j-1)),"mean_yield_increase_kg_ha"]) * Desired_table2[5+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table2[6+(7*(j-1)),"mean_yield_increase_kg_ha"]) * Desired_table2[6+(7*(j-1)),"Monsoon_area_ha"]))
  / Desired_table2[7+(7*(j-1)),"Monsoon_area_ha"],0)
}



# 5) mean_Nsaving_USD_ha
Desired_table2$FarmerCost_USDperKGofN <- round(India_farmercost_USD_per_N_kg, 2)
Desired_table2[which(Desired_table2$Region == "Bangladesh"), "FarmerCost_USDperKGofN"] <- 
  round(Bangladesh_farmercost_USD_per_N_kg, 2)
Desired_table2[which(Desired_table2$Region == "Nepal"), "FarmerCost_USDperKGofN"] <- 
  round(Nepal_farmercost_USD_per_N_kg, 2)
Desired_table2[which(Desired_table2$Region == "Aggregated"), "FarmerCost_USDperKGofN"] <- NA



for(j in 1:nrow(Scent2)){
Desired_table2[,paste0(Scent2[j,"Abb"],".1_mean_Nsaving_USD_ha")] <- NA

for(i in 1:6){

Desired_table2[i+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_mean_Nsaving_USD_ha")] <- round(
  mean(nib9[which(nib9$Region == Desired_table2[i,"Region"]), paste0(Scent2[j,"Abb"],"_seg_N_saving_kg_ha")]) *
    Desired_table2[i+(7*(j-1)),"FarmerCost_USDperKGofN"]
  ,0)
Desired_table2[i+(7*(j-1)),"mean_Nsaving_USD_ha"] <- 
 Desired_table2[i+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_mean_Nsaving_USD_ha")] 
}
Desired_table2[7+(7*(j-1)),"mean_Nsaving_USD_ha"] <- paste0(
  round((
  ((Desired_table2[1+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_mean_Nsaving_USD_ha")] * Desired_table2[1+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table2[2+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_mean_Nsaving_USD_ha")] * Desired_table2[2+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table2[3+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_mean_Nsaving_USD_ha")] * Desired_table2[3+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table2[4+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_mean_Nsaving_USD_ha")] * Desired_table2[4+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table2[5+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_mean_Nsaving_USD_ha")] * Desired_table2[5+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table2[6+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_mean_Nsaving_USD_ha")] * Desired_table2[6+(7*(j-1)),"Monsoon_area_ha"]))
  / Desired_table2[7+(7*(j-1)),"Monsoon_area_ha"]),0)
)
}


# 6) mean_N
for(j in 1:nrow(Scent2)){
for(i in 1:6){
Desired_table2[i+(7*(j-1)),"mean_N"] <- 
  round(mean(nib9[which(nib9$Region == Desired_table2[i,"Region"]),"N_kg_ha"]),0)
}
Desired_table2[7+(7*(j-1)),"mean_N"] <- 
  round((
  (as.numeric(Desired_table2[1+(7*(j-1)),"mean_N"]) * Desired_table2[1+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table2[2+(7*(j-1)),"mean_N"]) * Desired_table2[2+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table2[3+(7*(j-1)),"mean_N"]) * Desired_table2[3+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table2[4+(7*(j-1)),"mean_N"]) * Desired_table2[4+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table2[5+(7*(j-1)),"mean_N"]) * Desired_table2[5+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table2[6+(7*(j-1)),"mean_N"]) * Desired_table2[6+(7*(j-1)),"Monsoon_area_ha"]))
  / Desired_table2[7+(7*(j-1)),"Monsoon_area_ha"],0)
}

# 7) mean_yield
for(j in 1:nrow(Scent2)){
for(i in 1:6){
Desired_table2[i+(7*(j-1)),"mean_yield"] <- 
  round(mean(nib9[which(nib9$Region == Desired_table2[i,"Region"]),"yield_kg_ha"]),0)
}
Desired_table2[7+(7*(j-1)),"mean_yield"] <- 
  round((
  (as.numeric(Desired_table2[1+(7*(j-1)),"mean_yield"]) * Desired_table2[1+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table2[2+(7*(j-1)),"mean_yield"]) * Desired_table2[2+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table2[3+(7*(j-1)),"mean_yield"]) * Desired_table2[3+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table2[4+(7*(j-1)),"mean_yield"]) * Desired_table2[4+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table2[5+(7*(j-1)),"mean_yield"]) * Desired_table2[5+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table2[6+(7*(j-1)),"mean_yield"]) * Desired_table2[6+(7*(j-1)),"Monsoon_area_ha"]))
  / Desired_table2[7+(7*(j-1)),"Monsoon_area_ha"],0)
}

# 8) mean_NUE_change_absolute
for(j in 1:nrow(Scent2)){
for(i in 1:6){

Desired_table2[i+(7*(j-1)),"mean_NUE_change_absolute"] <- 
round(
  (as.numeric(Desired_table2[i+(7*(j-1)),"mean_yield_increase_kg_ha"] + 
                as.numeric(Desired_table2[i+(7*(j-1)),"mean_yield"])) / 
  as.numeric(Desired_table2[i+(7*(j-1)),"mean_N"] -
               as.numeric(Desired_table2[i+(7*(j-1)),"mean_N_saving_kg_ha"]))) -
  (as.numeric(Desired_table2[i+(7*(j-1)),"mean_yield"]) /
  as.numeric(Desired_table2[i+(7*(j-1)),"mean_N"])),0)
  
}
Desired_table2[7+(7*(j-1)),"mean_NUE_change_absolute"] <- 
  round((
  (as.numeric(Desired_table2[1+(7*(j-1)),"mean_NUE_change_absolute"]) * Desired_table2[1+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table2[2+(7*(j-1)),"mean_NUE_change_absolute"]) * Desired_table2[2+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table2[3+(7*(j-1)),"mean_NUE_change_absolute"]) * Desired_table2[3+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table2[4+(7*(j-1)),"mean_NUE_change_absolute"]) * Desired_table2[4+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table2[5+(7*(j-1)),"mean_NUE_change_absolute"]) * Desired_table2[5+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table2[6+(7*(j-1)),"mean_NUE_change_absolute"]) * Desired_table2[6+(7*(j-1)),"Monsoon_area_ha"]))
  / Desired_table2[7+(7*(j-1)),"Monsoon_area_ha"],0)
}

# 9) mean_NUE_change_perc
for(j in 1:nrow(Scent2)){
for(i in 1:6){

Desired_table2[i+(7*(j-1)),"mean_NUE_change_perc"] <- 
round(
  as.numeric(Desired_table2[i+(7*(j-1)),"mean_NUE_change_absolute"]) /
  ((as.numeric(Desired_table2[i+(7*(j-1)),"mean_yield"]) /
  as.numeric(Desired_table2[i+(7*(j-1)),"mean_N"]))) *  100
  ,0)

}
Desired_table2[7+(7*(j-1)),"mean_NUE_change_perc"] <- 
  round((
  (as.numeric(Desired_table2[1+(7*(j-1)),"mean_NUE_change_perc"]) * Desired_table2[1+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table2[2+(7*(j-1)),"mean_NUE_change_perc"]) * Desired_table2[2+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table2[3+(7*(j-1)),"mean_NUE_change_perc"]) * Desired_table2[3+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table2[4+(7*(j-1)),"mean_NUE_change_perc"]) * Desired_table2[4+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table2[5+(7*(j-1)),"mean_NUE_change_perc"]) * Desired_table2[5+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table2[6+(7*(j-1)),"mean_NUE_change_perc"]) * Desired_table2[6+(7*(j-1)),"Monsoon_area_ha"]))
  / Desired_table2[7+(7*(j-1)),"Monsoon_area_ha"],0)
}

# 10) mean_revenue_increase_USD_ha
Desired_table2$FarmerRevenue_USDperKGofPaddy <- round(India_paddy_price_USD_per_kg, 2)
Desired_table2[which(Desired_table2$Region == "Bangladesh"), "FarmerRevenue_USDperKGofPaddy"] <- 
  round(Bangladesh_paddy_price_USD_per_kg, 2)
Desired_table2[which(Desired_table2$Region == "Nepal"), "FarmerRevenue_USDperKGofPaddy"] <- 
  round(Nepal_paddy_price_USD_per_kg, 2)
Desired_table2[which(Desired_table2$Region == "Aggregated"), "FarmerRevenue_USDperKGofPaddy"] <- NA

for(j in 1:nrow(Scent2)){
for(i in 1:6){

Desired_table2[i+(7*(j-1)),"mean_revenue_increase_USD_ha"] <- round(
  mean(nib9[which(nib9$Region == Desired_table2[i,"Region"]), paste0(Scent2[j,"Abb"],"_seg_yield_gain_kg_ha")]) *
    Desired_table2[i+(7*(j-1)),"FarmerRevenue_USDperKGofPaddy"]
  ,0)
}
Desired_table2[7+(7*(j-1)),"mean_revenue_increase_USD_ha"] <- 
  round((
  (as.numeric(Desired_table2[1+(7*(j-1)),"mean_revenue_increase_USD_ha"]) * Desired_table2[1+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table2[2+(7*(j-1)),"mean_revenue_increase_USD_ha"]) * Desired_table2[2+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table2[3+(7*(j-1)),"mean_revenue_increase_USD_ha"]) * Desired_table2[3+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table2[4+(7*(j-1)),"mean_revenue_increase_USD_ha"]) * Desired_table2[4+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table2[5+(7*(j-1)),"mean_revenue_increase_USD_ha"]) * Desired_table2[5+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table2[6+(7*(j-1)),"mean_revenue_increase_USD_ha"]) * Desired_table2[6+(7*(j-1)),"Monsoon_area_ha"]))
  / Desired_table2[7+(7*(j-1)),"Monsoon_area_ha"],0)
}

# 11) mean_Nsurplus_saving_kg_ha

## Scenarios where there is range
for(j in 1:nrow(Scent2)){
Desired_table2[,paste0(Scent2[j,"Abb"],".1_mean_Nsurplus_saving_kg_ha")] <- NA

for(i in 1:6){

Desired_table2[i+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_mean_Nsurplus_saving_kg_ha")] <- round(
  mean(nib9[which(nib9$Region == Desired_table2[i,"Region"]), paste0(Scent2[j,"Abb"],"_seg_N_surplus_saving_kg_ha")])
  ,0)
Desired_table2[i+(7*(j-1)),"mean_Nsurplus_saving_kg_ha"] <- 
 paste0(Desired_table2[i+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_mean_Nsurplus_saving_kg_ha")] 
        )
}
Desired_table2[7+(7*(j-1)),"mean_Nsurplus_saving_kg_ha"] <- paste0(
  round((
  ((Desired_table2[1+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_mean_Nsurplus_saving_kg_ha")] * Desired_table2[1+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table2[2+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_mean_Nsurplus_saving_kg_ha")] * Desired_table2[2+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table2[3+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_mean_Nsurplus_saving_kg_ha")] * Desired_table2[3+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table2[4+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_mean_Nsurplus_saving_kg_ha")] * Desired_table2[4+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table2[5+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_mean_Nsurplus_saving_kg_ha")] * Desired_table2[5+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table2[6+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_mean_Nsurplus_saving_kg_ha")] * Desired_table2[6+(7*(j-1)),"Monsoon_area_ha"]))
  / Desired_table2[7+(7*(j-1)),"Monsoon_area_ha"]),0)
)
}


# 12) total_Nsurplus_saving_kg

## Scenarios where there is range
for(j in 1:nrow(Scent2)){
Desired_table2[,paste0(Scent2[j,"Abb"],".1_total_Nsurplus_saving_kg")] <- NA

for(i in 1:6){

Desired_table2[i+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_total_Nsurplus_saving_kg")] <- round(
  mean(nib9[which(nib9$Region == Desired_table2[i,"Region"]), paste0(Scent2[j,"Abb"],"_seg_N_surplus_saving_kg_ha")]) *
    Desired_table2[i+(7*(j-1)),"Monsoon_area_ha"]
  ,0)
Desired_table2[i+(7*(j-1)),"total_Nsurplus_saving_kg"] <- 
 paste0(Desired_table2[i+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_total_Nsurplus_saving_kg")] 
        )
}
Desired_table2[7+(7*(j-1)),"total_Nsurplus_saving_kg"] <- paste0(
  round(
  Desired_table2[1+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_total_Nsurplus_saving_kg")] +
  Desired_table2[2+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_total_Nsurplus_saving_kg")] +
  Desired_table2[3+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_total_Nsurplus_saving_kg")] +
  Desired_table2[4+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_total_Nsurplus_saving_kg")] +
  Desired_table2[5+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_total_Nsurplus_saving_kg")] +
  Desired_table2[6+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_total_Nsurplus_saving_kg")]
  ,0)

)
}


# 13) Subsidy_USDperKGofN

Desired_table2$Subsidy_USDperKGofN <- round(India_subsidy_USD_per_N_kg, 2)
Desired_table2[which(Desired_table2$Region == "Bangladesh"), "Subsidy_USDperKGofN"] <- round(Bangladesh_subsidy_USD_per_N_kg, 2)
Desired_table2[which(Desired_table2$Region == "Nepal"), "Subsidy_USDperKGofN"] <- round(Nepal_subsidy_USD_per_N_kg, 2)
Desired_table2[which(Desired_table2$Region == "Aggregated"), "Subsidy_USDperKGofN"] <- NA

# 14) N_subsidy_saving_millionUSD

## Scenarios where there is range
for(j in 1:nrow(Scent2)){
Desired_table2[,paste0(Scent2[j,"Abb"],".1_N_subsidy_saving_millionUSD")] <- NA

for(i in 1:6){

Desired_table2[i+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_N_subsidy_saving_millionUSD")] <- round(
  mean(nib9[which(nib9$Region == Desired_table2[i,"Region"]), paste0(Scent2[j,"Abb"],"_seg_N_saving_kg_ha")]) *
    Desired_table2[i+(7*(j-1)),"Monsoon_area_ha"] * Desired_table2[i+(7*(j-1)),"Subsidy_USDperKGofN"] /
    1000000
  ,0)
Desired_table2[i+(7*(j-1)),"N_subsidy_saving_millionUSD"] <- 
 paste0(Desired_table2[i+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_N_subsidy_saving_millionUSD")] 
 )
}

Desired_table2[7+(7*(j-1)),"N_subsidy_saving_millionUSD"] <- paste0(
  round(
  Desired_table2[1+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_N_subsidy_saving_millionUSD")] +
  Desired_table2[2+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_N_subsidy_saving_millionUSD")] +
  Desired_table2[3+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_N_subsidy_saving_millionUSD")] +
  Desired_table2[4+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_N_subsidy_saving_millionUSD")] +
  Desired_table2[5+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_N_subsidy_saving_millionUSD")] +
  Desired_table2[6+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_N_subsidy_saving_millionUSD")]
  ,-1)
)

# 15) N_subsidy_saving_USDperha

for(j in 1:nrow(Scent2)){
Desired_table2[,paste0(Scent2[j,"Abb"],".1_N_subsidy_saving_USDperha")] <- NA

for(i in 1:6){

Desired_table2[i+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_N_subsidy_saving_USDperha")] <- round(
  mean(nib9[which(nib9$Region == Desired_table2[i,"Region"]), paste0(Scent2[j,"Abb"],"_seg_N_saving_kg_ha")]) *
    Desired_table2[i+(7*(j-1)),"Subsidy_USDperKGofN"]
  ,0)

Desired_table2[i+(7*(j-1)),"N_subsidy_saving_USDperha"] <- 
 paste0(Desired_table2[i+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_N_subsidy_saving_USDperha")] 
        )
}

Desired_table2[7+(7*(j-1)),"N_subsidy_saving_USDperha"] <- paste0(
  round(
  ((Desired_table2[1+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_N_subsidy_saving_USDperha")] *
     Desired_table2[1+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table2[2+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_N_subsidy_saving_USDperha")] *
     Desired_table2[2+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table2[3+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_N_subsidy_saving_USDperha")] *
     Desired_table2[3+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table2[4+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_N_subsidy_saving_USDperha")] *
     Desired_table2[4+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table2[5+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_N_subsidy_saving_USDperha")] *
     Desired_table2[5+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table2[6+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_N_subsidy_saving_USDperha")] *
     Desired_table2[6+(7*(j-1)),"Monsoon_area_ha"]))
  / Desired_table2[7+(7*(j-1)),"Monsoon_area_ha"]
  ,0)
)
}

}


# 16) total_yield_increase_kg

for(j in 1:nrow(Scent2)){
for(i in 1:6){

Desired_table2[i+(7*(j-1)),"total_yield_increase_kg"] <- round(
  mean(nib9[which(nib9$Region == Desired_table2[i,"Region"]), paste0(Scent2[j,"Abb"],"_seg_yield_gain_kg_ha")]) *
    Desired_table2[i+(7*(j-1)),"Monsoon_area_ha"]
  ,0)
}
Desired_table2[7+(7*(j-1)),"total_yield_increase_kg"] <- 
  round((
  as.numeric(Desired_table2[1+(7*(j-1)),"total_yield_increase_kg"]) +
  as.numeric(Desired_table2[2+(7*(j-1)),"total_yield_increase_kg"]) +
  as.numeric(Desired_table2[3+(7*(j-1)),"total_yield_increase_kg"]) +
  as.numeric(Desired_table2[4+(7*(j-1)),"total_yield_increase_kg"]) +
  as.numeric(Desired_table2[5+(7*(j-1)),"total_yield_increase_kg"]) +
  as.numeric(Desired_table2[6+(7*(j-1)),"total_yield_increase_kg"]))
  ,0)
}


# 17) total_yield_increase_perc
for(j in 1:nrow(Scent2)){
for(i in 1:6){

Desired_table2[i+(7*(j-1)),"total_yield_increase_perc"] <- round(
  mean(nib9[which(nib9$Region == Desired_table2[i,"Region"]), paste0(Scent2[j,"Abb"],"_seg_yield_gain_kg_ha")]) /
    mean(nib9[which(nib9$Region == Desired_table2[i,"Region"]), "yield_kg_ha"]) * 
    100
  ,0)
}
Desired_table2[7+(7*(j-1)),"total_yield_increase_perc"] <- 
  round((
  (as.numeric(Desired_table2[1+(7*(j-1)),"total_yield_increase_perc"]) * Desired_table2[1+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table2[2+(7*(j-1)),"total_yield_increase_perc"]) * Desired_table2[2+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table2[3+(7*(j-1)),"total_yield_increase_perc"]) * Desired_table2[3+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table2[4+(7*(j-1)),"total_yield_increase_perc"]) * Desired_table2[4+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table2[5+(7*(j-1)),"total_yield_increase_perc"]) * Desired_table2[5+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table2[6+(7*(j-1)),"total_yield_increase_perc"]) * Desired_table2[6+(7*(j-1)),"Monsoon_area_ha"]))
  / Desired_table2[7+(7*(j-1)),"Monsoon_area_ha"],0)
}



# 18) million_people_fed

## Calculating based on current conusmption
yearly_milled_rice_needs_per_person <- 74.2 
milled_rice_per_paddy_rice <- 0.633 
yearly_paddy_rice_needs_per_person <- yearly_milled_rice_needs_per_person / milled_rice_per_paddy_rice
people_fed_per_kg_paddy <- 1/yearly_paddy_rice_needs_per_person

# Alternatively, we could calculate based on current rice consumption - 630 g of white rice per day 
for(j in 1:nrow(Scent2)){
for(i in 1:6){

Desired_table2[i+(7*(j-1)),"million_people_fed"] <- round(
  Desired_table2[i+(7*(j-1)),"total_yield_increase_kg"] * people_fed_per_kg_paddy / 1000000
  ,0)
}
Desired_table2[7+(7*(j-1)),"million_people_fed"] <- 
  round(
  as.numeric(Desired_table2[1+(7*(j-1)),"million_people_fed"]) +
  as.numeric(Desired_table2[2+(7*(j-1)),"million_people_fed"]) +
  as.numeric(Desired_table2[3+(7*(j-1)),"million_people_fed"]) +
  as.numeric(Desired_table2[4+(7*(j-1)),"million_people_fed"]) +
  as.numeric(Desired_table2[5+(7*(j-1)),"million_people_fed"]) +
  as.numeric(Desired_table2[6+(7*(j-1)),"million_people_fed"])
  ,0)
}



# 19) Total_crop_revenue_increase_perc
for(j in 1:nrow(Scent2)){
for(i in 1:6){

Desired_table2[i+(7*(j-1)),"Total_crop_revenue_increase_perc"] <- round(
  sum(nib9[which(nib9$Region == Desired_table2[i,"Region"]), paste0(Scent2[j,"Abb"],"_seg_yield_gain_kg_ha")])
    / sum(nib9[which(nib9$Region == Desired_table2[i,"Region"]), "yield_kg_ha"]) * 100
  ,0)
}
Desired_table2[7+(7*(j-1)),"Total_crop_revenue_increase_perc"] <- 
  round((
  (as.numeric(Desired_table2[1+(7*(j-1)),"Total_crop_revenue_increase_perc"]) * Desired_table2[1+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table2[2+(7*(j-1)),"Total_crop_revenue_increase_perc"]) * Desired_table2[2+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table2[3+(7*(j-1)),"Total_crop_revenue_increase_perc"]) * Desired_table2[3+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table2[4+(7*(j-1)),"Total_crop_revenue_increase_perc"]) * Desired_table2[4+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table2[5+(7*(j-1)),"Total_crop_revenue_increase_perc"]) * Desired_table2[5+(7*(j-1)),"Monsoon_area_ha"]) +
  (as.numeric(Desired_table2[6+(7*(j-1)),"Total_crop_revenue_increase_perc"]) * Desired_table2[6+(7*(j-1)),"Monsoon_area_ha"]))
  / Desired_table2[7+(7*(j-1)),"Monsoon_area_ha"],0)
}

# 20) Total_crop_cost_saving_perc
for(j in 1:nrow(Scent2)){
Desired_table2[,paste0(Scent2[j,"Abb"],".1_Total_crop_cost_saving_perc")] <- NA

for(i in 1:6){

Desired_table2[i+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_Total_crop_cost_saving_perc")] <- round(
  sum(nib9[which(nib9$Region == Desired_table2[i,"Region"]), paste0(Scent2[j,"Abb"],"_seg_N_saving_kg_ha")]) /
    sum(nib9[which(nib9$Region == Desired_table2[i,"Region"]), "N_kg_ha"]) * 100 * 0.1
  ,0)

Desired_table2[i+(7*(j-1)),"Total_crop_cost_saving_perc"] <- 
 paste0(Desired_table2[i+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_Total_crop_cost_saving_perc")]
        )
}
Desired_table2[7+(7*(j-1)),"Total_crop_cost_saving_perc"] <- paste0(
  round((
  ((Desired_table2[1+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_Total_crop_cost_saving_perc")] * Desired_table2[1+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table2[2+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_Total_crop_cost_saving_perc")] * Desired_table2[2+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table2[3+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_Total_crop_cost_saving_perc")] * Desired_table2[3+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table2[4+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_Total_crop_cost_saving_perc")] * Desired_table2[4+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table2[5+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_Total_crop_cost_saving_perc")] * Desired_table2[5+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table2[6+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_Total_crop_cost_saving_perc")] * Desired_table2[6+(7*(j-1)),"Monsoon_area_ha"]))
  / Desired_table2[7+(7*(j-1)),"Monsoon_area_ha"]),0)
)
}



# 21) mean_Nsurplus_saving_perc_AVERAGING_AGGREGATE

## Scenarios where there is range
for(j in 1:nrow(Scent2)){
Desired_table2[,paste0(Scent2[j,"Abb"],".1_mean_Nsurplus_saving_perc_AVERAGING_AGGREGATE")] <- NA

for(i in 1:6){

Desired_table2[i+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_mean_Nsurplus_saving_perc_AVERAGING_AGGREGATE")] <- round(
  mean(nib9[which(nib9$Region == Desired_table2[i,"Region"]), paste0(Scent2[j,"Abb"],"_seg_N_surplus_saving_kg_ha")])
  / mean(nib9[which(nib9$Region == Desired_table2[i,"Region"]), "N_balance_ladha"]) * 100
  ,0)

Desired_table2[i+(7*(j-1)),"mean_Nsurplus_saving_perc_AVERAGING_AGGREGATE"] <- 
 paste0(Desired_table2[i+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_mean_Nsurplus_saving_perc_AVERAGING_AGGREGATE")] 
        )
}
Desired_table2[7+(7*(j-1)),"mean_Nsurplus_saving_perc_AVERAGING_AGGREGATE"] <- paste0(
  round(
  ((Desired_table2[1+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_mean_Nsurplus_saving_perc_AVERAGING_AGGREGATE")] * Desired_table2[1+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table2[2+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_mean_Nsurplus_saving_perc_AVERAGING_AGGREGATE")] * Desired_table2[2+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table2[3+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_mean_Nsurplus_saving_perc_AVERAGING_AGGREGATE")] * Desired_table2[3+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table2[4+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_mean_Nsurplus_saving_perc_AVERAGING_AGGREGATE")] * Desired_table2[4+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table2[5+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_mean_Nsurplus_saving_perc_AVERAGING_AGGREGATE")] * Desired_table2[5+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table2[6+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_mean_Nsurplus_saving_perc_AVERAGING_AGGREGATE")] * Desired_table2[6+(7*(j-1)),"Monsoon_area_ha"]))
   / Desired_table2[7+(7*(j-1)),"Monsoon_area_ha"] 
  ,0)

)
}

# 22) Total_monsoon_subsidy_saving_perc
for(j in 1:nrow(Scent2)){
Desired_table2[,paste0(Scent2[j,"Abb"],".1_Total_monsoon_subsidy_saving_perc")] <- NA

for(i in 1:6){

Desired_table2[i+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_Total_monsoon_subsidy_saving_perc")] <- round(
  sum(nib9[which(nib9$Region == Desired_table2[i,"Region"]), paste0(Scent2[j,"Abb"],"_seg_N_saving_kg_ha")]) /
    sum(nib9[which(nib9$Region == Desired_table2[i,"Region"]), "N_kg_ha"]) * 100
  ,0)
Desired_table2[i+(7*(j-1)),"Total_monsoon_subsidy_saving_perc"] <- 
 paste0(Desired_table2[i+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_Total_monsoon_subsidy_saving_perc")] 
        )
}
Desired_table2[7+(7*(j-1)),"Total_monsoon_subsidy_saving_perc"] <- paste0(
  round((
  ((Desired_table2[1+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_Total_monsoon_subsidy_saving_perc")] * Desired_table2[1+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table2[2+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_Total_monsoon_subsidy_saving_perc")] * Desired_table2[2+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table2[3+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_Total_monsoon_subsidy_saving_perc")] * Desired_table2[3+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table2[4+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_Total_monsoon_subsidy_saving_perc")] * Desired_table2[4+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table2[5+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_Total_monsoon_subsidy_saving_perc")] * Desired_table2[5+(7*(j-1)),"Monsoon_area_ha"]) +
  (Desired_table2[6+(7*(j-1)),paste0(Scent2[j,"Abb"],".1_Total_monsoon_subsidy_saving_perc")] * Desired_table2[6+(7*(j-1)),"Monsoon_area_ha"]))
  / Desired_table2[7+(7*(j-1)),"Monsoon_area_ha"]),0)
)
}

# PART 4) Visualsing implications of potential NUE increases (Table 1 sensitivity)

library('splitstackshape')

# Merge columns
Desired_table2$mean_N_saving_perc_AND_kgha <- paste0(Desired_table2$Total_monsoon_subsidy_saving_perc, 
                                                    "% (",
                                                    Desired_table2$mean_N_saving_kg_ha,
                                                    "kg/ha)")
Desired_table2$mean_yield_increase_perc_AND_kgha <- paste0(Desired_table2$total_yield_increase_perc, 
                                                    "% (",
                                                    Desired_table2$mean_yield_increase_kg_ha,
                                                    "kg/ha)")
Desired_table2$mean_NUE_increase_perc_AND_kgha <- paste0(Desired_table2$mean_NUE_change_perc, 
                                                    "% (",
                                                    Desired_table2$mean_NUE_change_absolute,
                                                    "kg/kg)")
Desired_table2$mean_revenue_increase_perc_AND_kgha <- paste0(Desired_table2$Total_crop_revenue_increase_perc, 
                                                    "% ($",
                                                    Desired_table2$mean_revenue_increase_USD_ha,
                                                    "/ha)")
Desired_table2$mean_cropCost_saving_perc_AND_kgha <- paste0(Desired_table2$Total_crop_cost_saving_perc, 
                                                    "% ($",
                                                    Desired_table2$mean_Nsaving_USD_ha,
                                                    "/ha)")
Desired_table2$mean_Nsurplus_saving_perc_AND_kgha <- paste0(Desired_table2$mean_Nsurplus_saving_perc_AVERAGING_AGGREGATE, 
                                                    "% (",
                                                    Desired_table2$mean_Nsurplus_saving_kg_ha,
                                                    "kg/ha)")
Desired_table2$mean_Nsubsidy_saving_perc_AND_kgha <- paste0(Desired_table2$Total_monsoon_subsidy_saving_perc, 
                                                    "% ($",
                                                    Desired_table2$N_subsidy_saving_USDperha,
                                                    "/ha)")


# Make comprehensive table
all_cols <- c(
  # Descriptive
  "Scenario"
  ,"Region"                                             
  ,"Monsoon_area_ha"
  # Basic
  ,"percentage_Nsavers"                                 
  ,"mean_N_saving_kg_ha"                                
  ,"mean_yield_increase_kg_ha"
  # NUE
  ,"mean_NUE_change_perc"
  ,"mean_NUE_change_absolute"
  # Food security
  ,"total_yield_increase_kg"                            
  ,"total_yield_increase_perc"                         
  ,"million_people_fed"                                 
  # Livelihoods
  ,"FarmerCost_USDperKGofN"                             
  ,"FarmerRevenue_USDperKGofPaddy"                      
  ,"mean_Nsaving_USD_ha"
  ,"Total_crop_cost_saving_perc"                        
  ,"Total_crop_revenue_increase_perc"
  ,"mean_revenue_increase_USD_ha"                       
  # Environment
  ,"mean_Nsurplus_saving_kg_ha"                         
  ,"total_Nsurplus_saving_kg"                           
  ,"mean_Nsurplus_saving_perc_AVERAGING_AGGREGATE"      
  # Government 
  ,"Subsidy_USDperKGofN"
  ,"N_subsidy_saving_millionUSD"                        
  ,"Total_monsoon_subsidy_saving_perc"
  ,"N_subsidy_saving_USDperha"
)

Comprehensive_table2 <- Desired_table2[,all_cols]

# Rename rows
Comprehensive_table2[which(Comprehensive_table2$Scenario == "Scenario_1"),"Scenario"] <- "Cut excess N"
Comprehensive_table2[which(Comprehensive_table2$Scenario == "Scenario_2"),"Scenario"] <- "Increase yield"
Comprehensive_table2[which(Comprehensive_table2$Scenario == "Scenario_3"),"Scenario"] <- "Cut excess N and increase yield"

Comprehensive_table2[which(Comprehensive_table2$Region == "AP"),"Region"] <- "Andhra Pradesh"
Comprehensive_table2[which(Comprehensive_table2$Region == "Bihar"),"Region"] <- "Bihar & eastern Uttar Pradesh"
Comprehensive_table2[which(Comprehensive_table2$Region == "Bangladesh"),"Region"] <- "Bangladesh Plains"
Comprehensive_table2[which(Comprehensive_table2$Region == "Nepal"),"Region"] <- "Nepal Terai"
Comprehensive_table2[which(Comprehensive_table2$Region == "Punjab_Haryana"),"Region"] <- "Punjab & Haryana"

# Rename columns
colnames(Comprehensive_table2)[which(names(Comprehensive_table2) == "Monsoon_area_ha")] <- "Monsoon_rice_area_ha"
colnames(Comprehensive_table2)[which(names(Comprehensive_table2) == "percentage_Nsavers")] <- "Percentage_of_crops_with_excess_N"
colnames(Comprehensive_table2)[which(names(Comprehensive_table2) == "total_yield_increase_perc")] <- "total_yield_increase_percent"
colnames(Comprehensive_table2)[which(names(Comprehensive_table2) == "million_people_fed")] <- "million_people_fed_through_increased_yield"
colnames(Comprehensive_table2)[which(names(Comprehensive_table2) == "Total_crop_cost_saving_perc")] <- "Total_crop_cost_saving_percent"
colnames(Comprehensive_table2)[which(names(Comprehensive_table2) == "Total_crop_revenue_increase_perc")] <- "Total_crop_revenue_increase_percent"
colnames(Comprehensive_table2)[which(names(Comprehensive_table2) == "mean_Nsurplus_saving_perc_AVERAGING_AGGREGATE")] <- "mean_Nsurplus_saving_percent"
colnames(Comprehensive_table2)[which(names(Comprehensive_table2) == "Total_monsoon_subsidy_saving_perc")] <- "Total_monsoon_subsidy_saving_percent"

# Make detailed table 

## Define columns
all_wanted_cols <- c(
  # Descriptive
  "Scenario"
  ,"Region"                                             
  # ,"Monsoon_area_ha"
  # Basic
  # ,"percentage_Nsavers"                                 
  ,"mean_N_saving_kg_ha"
  ,"mean_yield_increase_kg_ha"
  # Food security
  # ,"total_yield_increase_kg"                            
  ,"total_yield_increase_perc"                         
  # ,"million_people_fed"                                 
  # Livelihoods
  # ,"FarmerCost_USDperKGofN"                             
  # ,"FarmerRevenue_USDperKGofPaddy"                      
  ,"mean_Nsaving_USD_ha"
  ,"Total_crop_cost_saving_perc"                        
  # ,"Total_crop_revenue_increase_perc"
  ,"mean_revenue_increase_USD_ha"
  # Environment
  ,"mean_Nsurplus_saving_kg_ha"
  # ,"total_Nsurplus_saving_kg"                           
  ,"mean_Nsurplus_saving_perc_AVERAGING_AGGREGATE"      
  # Government 
  # ,"Subsidy_USDperKGofN"
  # ,"N_subsidy_saving_millionUSD"                        
  ,"Total_monsoon_subsidy_saving_perc"
  ,"N_subsidy_saving_USDperha"
)
wanted_detailed_table2 <- Desired_table2[,all_wanted_cols]


## Add percentages
for(i in 1:nrow(wanted_detailed_table2)){
wanted_detailed_table2[i,"total_yield_increase_perc"] <- paste0(wanted_detailed_table2[i,"total_yield_increase_perc"], "%")
wanted_detailed_table2[i,"Total_crop_cost_saving_perc"] <- paste0(wanted_detailed_table2[i,"Total_crop_cost_saving_perc"], "%")
wanted_detailed_table2[i,"mean_Nsurplus_saving_perc_AVERAGING_AGGREGATE"] <- paste0(wanted_detailed_table2[i,"mean_Nsurplus_saving_perc_AVERAGING_AGGREGATE"], "%")
wanted_detailed_table2[i,"Total_monsoon_subsidy_saving_perc"] <- paste0(wanted_detailed_table2[i,"Total_monsoon_subsidy_saving_perc"], "%")
}

## Rename scenarios
wanted_detailed_table2[which(wanted_detailed_table2$Scenario == "Scenario_1"),"Scenario"] <- "CutNexcess"
wanted_detailed_table2[which(wanted_detailed_table2$Scenario == "Scenario_2"),"Scenario"] <- "Q50yieldgap"
wanted_detailed_table2[which(wanted_detailed_table2$Scenario == "Scenario_3"),"Scenario"] <- "Q50yieldgap_AND_CutNexcess"

## Present detailed table
aggregate_rows_format <- formatter("span", style = ~style("font.weight" = "bold", "font.size" = "8", 'color' = 'black'))

# Make nice summary table
summary_cols2 <- c("Scenario",
                             "total_yield_increase_perc", # Food security
                             "Total_crop_cost_saving_perc", # Rural livelihoods
                             "mean_Nsurplus_saving_perc_AVERAGING_AGGREGATE", # Environment
                             "Total_monsoon_subsidy_saving_perc")
summary_rows2 <- which(wanted_detailed_table2$Region == "Aggregated" & 
                        wanted_detailed_table2$Scenario == "CutNexcess" |
                        wanted_detailed_table2$Region == "Aggregated" & 
                        wanted_detailed_table2$Scenario == "Q50yieldgap" |
                        wanted_detailed_table2$Region == "Aggregated" & 
                        wanted_detailed_table2$Scenario == "Q50yieldgap_AND_CutNexcess")
wanted_summary_table2 <- wanted_detailed_table2[summary_rows2, summary_cols2]
   


## Make with perc and per ha numbers
merged_cols <- c(
  "mean_NUE_increase_perc_AND_kgha"
  ,"mean_N_saving_perc_AND_kgha"
  ,"mean_yield_increase_perc_AND_kgha"
  ,"mean_revenue_increase_perc_AND_kgha"
  ,"mean_cropCost_saving_perc_AND_kgha"
  ,"mean_Nsurplus_saving_perc_AND_kgha"
  ,"mean_Nsubsidy_saving_perc_AND_kgha"
)

## Seleect columns and rows
wellin_table2 <- Desired_table2[summary_rows2,c("Scenario",merged_cols)]

## Rename scenarios for summary
wellin_table2[1,"Scenario"] <- "Pathway 1: Maintain yield, Cut excess N"
wellin_table2[2,"Scenario"] <- "Pathway 2: Increase yield, Maintain N"
wellin_table2[3,"Scenario"] <- "Pathway 1&2: Increase yield, Cut excess N"

## Custom formatting
Bespoke2 <- formatter(
                  "span",
                  style = x ~ style(
                    display = "inline-block",
                    color = "black",
                    "border-radius" = "4px",
                    "padding-right" = "4px",
                    width = "70px"))
#                     "background-color" = ifelse(as.character(x) == "0%", colorRampPalette(c("lemonchiffon", "forestgreen"))(40)[0],
#                                                          ifelse(as.character(x) == "22% (10kg/kg)", colorRampPalette(c("lemonchiffon", "forestgreen"))(40)[22],
#                                                          ifelse(as.character(x) == "7% (3kg/kg)", colorRampPalette(c("lemonchiffon", "forestgreen"))(40)[7],
#                                                          ifelse(as.character(x) == "32% (14kg/kg)", colorRampPalette(c("lemonchiffon", "forestgreen"))(40)[37],
#                                                          ifelse(as.character(x) == "17% (18kg/ha)", colorRampPalette(c("lemonchiffon", "forestgreen"))(40)[19],
#                                                          ifelse(as.character(x) == "0% (0kg/ha)", colorRampPalette(c("lemonchiffon", "forestgreen"))(40)[0],
#                                                          ifelse(as.character(x) == "0% ($0/ha)", colorRampPalette(c("lemonchiffon", "forestgreen"))(40)[0],
#                                                          ifelse(as.character(x) == "2% ($6/ha)", colorRampPalette(c("lemonchiffon", "forestgreen"))(40)[2],
#                                                          ifelse(as.character(x) == "27% (18kg/ha)", colorRampPalette(c("lemonchiffon", "forestgreen"))(40)[31],
#                                                          ifelse(as.character(x) == "17% ($14/ha)", colorRampPalette(c("lemonchiffon", "forestgreen"))(40)[19],
#                                                          ifelse(as.character(x) == "0% (0kg/ha)", colorRampPalette(c("lemonchiffon", "forestgreen"))(40)[0],
#                                                          ifelse(as.character(x) == "8% (369kg/ha)", colorRampPalette(c("lemonchiffon", "forestgreen"))(40)[8],
#                                                          ifelse(as.character(x) == "8% ($94/ha)", colorRampPalette(c("lemonchiffon", "forestgreen"))(40)[8],
#                                                          ifelse(as.character(x) == "0% ($0/ha)", colorRampPalette(c("lemonchiffon", "forestgreen"))(40)[0],
#                                                          ifelse(as.character(x) == "9% (6kg/ha)", colorRampPalette(c("lemonchiffon", "forestgreen"))(40)[9],
#                                                          ifelse(as.character(x) == "0% ($0/ha)", colorRampPalette(c("lemonchiffon", "forestgreen"))(40)[0],
#                                                          ifelse(as.character(x) == "17% (18kg/ha)",
# colorRampPalette(c("lemonchiffon", "forestgreen"))(40)[19],
#                                                          ifelse(as.character(x) == "8% (369kg/ha)", colorRampPalette(c("lemonchiffon", "forestgreen"))(40)[8],
#                                                          ifelse(as.character(x) == "8% ($94/ha)", colorRampPalette(c("lemonchiffon", "forestgreen"))(40)[8],
#                                                          ifelse(as.character(x) == "2% ($6/ha)",
# colorRampPalette(c("lemonchiffon", "forestgreen"))(40)[2],
#                                                          ifelse(as.character(x) == "36% (24kg/ha)", colorRampPalette(c("lemonchiffon", "forestgreen"))(40)[40],
#                                                          ifelse(as.character(x) == "17% ($14/ha)", colorRampPalette(c("lemonchiffon", "forestgreen"))(40)[19],
#                                               "red"
#                 ))))))))))))))))))))))))

Scenario_format <- formatter(
                  "span",
                  style = x ~ style(
                    display = "inline-block",
                    color = "black",
                    "border-radius" = "4px",
                    "padding-right" = "4px",
                    width = "100px"))

## Display table
formattable(wellin_table2,
            col.names = c("Scenario","NUE increase","Nitrogen fertilizer saving","FOOD SECURITY: Yield increase","FARMERS: Revenue increase", "FARMERS: Crop cost saving", "ENVIRONMENT: Reduction in excess nitrogen", "GOVERNMENTS: Monsoon nitrogen subsidy saving"), 
            row.names = F,
            align = "c",
            list(
              Scenario = Scenario_format,
              mean_N_saving_perc_AND_kgha = Bespoke2,
              mean_yield_increase_perc_AND_kgha = Bespoke2,
              mean_NUE_increase_perc_AND_kgha = Bespoke2,
              mean_revenue_increase_perc_AND_kgha = Bespoke2,
              mean_cropCost_saving_perc_AND_kgha = Bespoke2,
              mean_Nsurplus_saving_perc_AND_kgha = Bespoke2,
              mean_Nsubsidy_saving_perc_AND_kgha = Bespoke2
            ))

```

SECTION 4) Agronomic mechanisms for realizing potential NUE (see section 4.4 of methods)

4.1) Applying data exclusion criteria for NUE mechanisms analysis

```{r}

nib8 <- nib6
pred_dashboard_4 <- pred_dashboard_0

# Applying same data exclusion criteria defined in section 4.2 (as stipulated in section 4.4 of methods) 
nib8 <- nib8[which(nib8$N_kg_ha >= min_Nrate_50 &
                           nib8$N_kg_ha <= max_Nrate_tight &
                           nib8$yield_kg_ha >= min_yield_tight &
                           nib8$yield_kg_ha <= max_yield_tight),]
```

4.2) Addressing predictor variables with missing data for NUE mechanisms analysis

```{r}
# Cutting rows with missing predictor data

## Look for missing data in nib5
pred_dashboard_4_missingTOTAL_nib8 <- pred_dashboard_4
pred_dashboard_4_missingPERC_nib8 <- pred_dashboard_4

for(i in 1:nrow(regs)){
working_data <- nib8[which(nib8$Region == regs[i,"Region"]),]
for(w in 1:nrow(pred_dashboard_4_missingTOTAL_nib8)){
predictor <- pred_dashboard_4_missingTOTAL_nib8[w,"potpreds"]
NA_total <- sum(is.na(working_data[,predictor])) + length(which(working_data[,predictor] == ""))
NA_perc <- round(NA_total / nrow(working_data) * 100,0)
pred_dashboard_4_missingTOTAL_nib8[w, regs[i,"Region"]] <- as.numeric(NA_total)
pred_dashboard_4_missingPERC_nib8[w, regs[i,"Region"]] <- as.numeric(NA_perc)
}}

## Cut rows where there is <15% missing data for a given predictor (as stipulated in section 4.4 of methods)

for(i in 1:nrow(regs)){
preds_to_save <- pred_dashboard_4_missingPERC_nib8[which(as.numeric(pred_dashboard_4_missingPERC_nib8[,regs[i,"Region"]]) < 15), "potpreds"]
for(w in 1:length(preds_to_save)){
specific_pred <- preds_to_save[w]
nib8 <- nib8[which(nib8$Region != regs[i,"Region"] | nib8$Region == regs[i,"Region"] & is.na(nib8[,specific_pred]) == F),]
nib8 <- nib8[which(nib8$Region != regs[i,"Region"] | nib8$Region == regs[i,"Region"] & nib8[,specific_pred] != ""),]
}}

# ## Cut rows where there is missing data for field duration or cropduraiton in Bangladesh
nib8 <- nib8[which(nib8$Region != "Bangladesh" | nib8$Region == "Bangladesh" & is.na(nib8[,"Crop_duration"]) == F),]
nib8 <- nib8[which(nib8$Region != "Bangladesh" | nib8$Region == "Bangladesh" & nib8[,"Crop_duration"] != ""),]
nib8 <- nib8[which(nib8$Region != "Bangladesh" | nib8$Region == "Bangladesh" & is.na(nib8[,"Field_duration"]) == F),]
nib8 <- nib8[which(nib8$Region != "Bangladesh" | nib8$Region == "Bangladesh" & nib8[,"Field_duration"] != ""),]


# Look for more missing data 
pred_dashboard_4_missingTOTAL_nib8 <- pred_dashboard_4
pred_dashboard_4_missingPERC_nib8 <- pred_dashboard_4

for(i in 1:nrow(regs)){
working_data <- nib8[which(nib8$Region == regs[i,"Region"]),]
for(w in 1:nrow(pred_dashboard_4_missingTOTAL_nib8)){
predictor <- pred_dashboard_4_missingTOTAL_nib8[w,"potpreds"]
NA_total <- sum(is.na(working_data[,predictor])) + length(which(working_data[,predictor] == ""))
NA_perc <- round(NA_total / nrow(working_data) * 100,0)
pred_dashboard_4_missingTOTAL_nib8[w, regs[i,"Region"]] <- NA_total
pred_dashboard_4_missingPERC_nib8[w, regs[i,"Region"]] <- NA_perc
}}

## Cut predictors where there is >15% missing data for a given predictor (as stipulated in section 4.4 of methods)
for(i in 1:nrow(regs)){
specific_pred_missingPERC <- pred_dashboard_4_missingPERC_nib8[,regs[i,"Region"]]
pred_dashboard_4[which(as.numeric(specific_pred_missingPERC) > 0), regs[i,"Region"]] <- "Missing_data"
pred_dashboard_4[,"Aggregated"] <- paste0(pred_dashboard_4[,"Aggregated"]," | ",pred_dashboard_4[,regs[i,"Region"]])
}
pred_dashboard_4[grep("Missing_data", pred_dashboard_4$Aggregated),"Aggregated"] <- "Missing_data"
pred_dashboard_4[-grep("Missing_data", pred_dashboard_4$Aggregated),"Aggregated"] <- "tbc"

```

4.3) Calculating NUE of each field relative to the average for their N rate and region 

```{r}
require('ggplot2')

# Deviation against regional trend
nib8$PFPvsN_pred_region <- NA # Create variable
for (i in 1:nrow(regs)){
spline <- get(paste0("CTspline_","PFPvsN_",regs[i,"Region"])) # Retrieve splint for relevant region
working_data <- nib8[which(nib8$Region == regs[i,"Region"]),] # Get data for relevant region
ct_predict <- as.data.frame(predict(spline, working_data$N_kg_ha)) # Predict NUE for rach region
nib8[which(nib8$Region == regs[i,"Region"]), "PFPvsN_pred_region"] <- ct_predict$y # Plug into nib8
nib8$PFPvsN_deviation_region <- nib8$PFPn - nib8$PFPvsN_pred_region # Calculate difference between predicted and actual
}

for(i in 1:nrow(regs)){
plot(nib8[which(nib8$Region == regs[i,"Region"]), "PFPvsN_pred_region"] ~
       nib8[which(nib8$Region == regs[i,"Region"]), "N_kg_ha"], ylim=c(0,100),xlim=c(50,200),
     main = paste0(regs[i,"Region"],": Predicted PFPn vs N rate (kg/ha)")) # Plot predicted NUE values (across N rates)
plot(nib8[which(nib8$Region == regs[i,"Region"]), "PFPvsN_deviation_region"] ~
       nib8[which(nib8$Region == regs[i,"Region"]), "N_kg_ha"], ylim=c(-100,100),xlim=c(50,200),
     main = paste0(regs[i,"Region"],": NUE deviation vs N rate (kg/ha)")) # Visualize difference between predicted and actual ((across N rates))
}

nib8$above_or_below_spline <- NA
nib8[which(nib8$PFPvsN_deviation_region > 0),"above_or_below_spline"] <- "Above"
nib8[which(nib8$PFPvsN_deviation_region <= 0),"above_or_below_spline"] <- "Below"
nib8$above_or_below_spline <- as.factor(nib8$above_or_below_spline)



```

4.4) Addressing predictor variables with low inference space for random forest models predicting relative NUE

```{r}
library(summarytools)

pred_dashboard_5 <- pred_dashboard_4

# Exclude predictors with low inference space, i.e. >90% of points with the same value (as stipulated in section 4.4 of methods)

# Extract highest frequency value for each predictor*region combination
pred_HighestFreqPerc <- pred_dashboard_5

## Each region individually
for(i in 1:nrow(regs)){
for(y in 1:nrow(pred_dashboard_5)){

region <- regs[i,"Region"]
if(pred_dashboard_5[y,region] != "tbc") next # don't care if predictor already excluded for given region

frequency_table <- NA # blank slate
highest_freq <- NA # blank slate

working_data <- nib8[which(nib8$Region == region),]
highest_freq <- max(table(working_data[,pred_dashboard_5[y, "potpreds"]])) / nrow(working_data) * 100
pred_HighestFreqPerc[y,region] <- highest_freq

if(highest_freq < 90) next
pred_dashboard_5[y,region] <- paste("Low inference (", round(highest_freq,0), "%)", sep = "")
}}

## Aggregated
for(y in 1:nrow(pred_dashboard_5)){

if(pred_dashboard_5[y,"Aggregated"] != "tbc") next # don't care if predictor already excluded for given region

frequency_table <- NA # blank slate
highest_freq <- NA # blank slate
  
working_data <- nib8
highest_freq <- max(table(working_data[,pred_dashboard_5[y, "potpreds"]])) / nrow(working_data) * 100
pred_HighestFreqPerc[y,"Aggregated"] <- highest_freq

if(highest_freq < 90) next
pred_dashboard_5[y,"Aggregated"] <- paste("Low inference (", round(highest_freq,0), "%)", sep = "")
}

```

4.5) Addressing correalted predictor variables for random forest models predicting relative NUE

```{r}
library(gridExtra)
library(ggplot2)
library (tidyverse)

pred_dashboard_6 <- pred_dashboard_5

## Isolating numeric predictors
pred_cor <- pred_dashboard_6[which(pred_dashboard_6$class == "numeric" | pred_dashboard_6$class == "integer"),]

## Getting rid of "tbc"
for(i in 1:ncol(pred_cor)){
pred_cor[which(pred_cor[,i] == "tbc"),i] <- ""
}

## Making framework
for(i in 1:nrow(regs)){
for(j in 2:nrow(Nbins)){
  pred_cor[,paste0(regs[i,"Region"],"_",Nbins[j,"Nbins"])] <- pred_cor[,regs[i,"Region"]]
}}
pred_cor[,"Aggregated_50to100"] <- pred_cor[,"Aggregated"]
pred_cor[,"Aggregated_100to150"] <- pred_cor[,"Aggregated"]
pred_cor[,"Aggregated_150to200"] <- pred_cor[,"Aggregated"]

# Look for correlations without N bins and with region bins
for(i in 1:nrow(regs)){
working_data <- nib8[which(nib8$Region == regs[i,"Region"]),]
cors <- as.data.frame(as.table(
    round(cor(
        subset(working_data, select = pred_cor[which(pred_cor[,regs[i,"Region"]] == ""),"potpreds"])
         ),2)))
bad_cors <- cors[-which(cors$Freq > -0.6 & cors$Freq < 0.6),]
bad_cors <- bad_cors[-which(bad_cors$Freq == 1),]
for(w in 1:nrow(bad_cors)){
pred_cor[which(pred_cor[,"potpreds"] == bad_cors[w,1]), regs[i,"Region"]] <- paste0(
  pred_cor[which(pred_cor[,"potpreds"] == bad_cors[w,1]), regs[i,"Region"]],
  bad_cors[w,1], " & ", bad_cors[w,2], " (", bad_cors[w,3], ") | ")
}
pred_cor[which(pred_cor[,regs[i,"Region"]] == ""), regs[i,"Region"]] <- "TICK"
}

## Look for correlations with N bins and with regions bins
for(i in 1:nrow(regs)){
for(j in 2:nrow(Nbins)){
working_data <- nib8[which(nib8$Region == regs[i,"Region"] &
                             nib8$N_kg_ha >= Nbins[j,"Nmin"] & nib8$N_kg_ha <= Nbins[j,"Nmax"]),]
subset_name <- paste0(regs[i,"Region"],"_",Nbins[j,"Nbins"])
cors <- as.data.frame(as.table(
    round(cor(
        subset(working_data, select = pred_cor[which(pred_cor[,subset_name] == ""),"potpreds"])
         ),2)))
bad_cors <- cors[-which(cors$Freq > -0.6 & cors$Freq < 0.6),]
bad_cors <- bad_cors[-which(bad_cors$Freq == 1),]
for(w in 1:nrow(bad_cors)){
pred_cor[which(pred_cor[,"potpreds"] == bad_cors[w,1]), subset_name] <- paste0(
  pred_cor[which(pred_cor[,"potpreds"] == bad_cors[w,1]), subset_name],
  bad_cors[w,1], " & ", bad_cors[w,2], " (", bad_cors[w,3], ") | ")
}
pred_cor[which(pred_cor[,subset_name] == ""), subset_name] <- "TICK"
}}

# Excluding predictors with correlations >0.6 (as stipulated in section 4.4 of methods) 

## AP
pred_dashboard_6[which(pred_dashboard_6$potpreds == "SoilGrids_phh2o"), "AP"] <- pred_cor[which(pred_cor$potpreds == "SoilGrids_phh2o"), "AP"] # correlated with total_precip and worse predictoor (2.77 vs 1.77)

## Bangladesh
pred_dashboard_6[which(pred_dashboard_6$potpreds == "SoilGrids_sand"), "Bangladesh"] <- pred_cor[which(pred_cor$potpreds == "SoilGrids_sand"), "Bangladesh"] # correlated with total precip
pred_dashboard_6[which(pred_dashboard_6$potpreds == "Field_duration"), "Bangladesh"] <- pred_cor[which(pred_cor$potpreds == "Field_duration"), "Bangladesh"] # correlated with TDATE_rel and worse predictor (1.73 vs 1,32)

## Bihar
# No correlated predictors

## Nepal
# No correlated predictors

## Odisha
pred_dashboard_6[which(pred_dashboard_6$potpreds == "SoilGrids_bdod"), "Odisha"] <- pred_cor[which(pred_cor$potpreds == "SoilGrids_bdod"), "Odisha"] # correlated with soil carbon and worse predictor (1.55 vs 0.24)
pred_dashboard_6[which(pred_dashboard_6$potpreds == "SoilGrids_phh2o"), "Odisha"] <- pred_cor[which(pred_cor$potpreds == "SoilGrids_phh2o"), "Odisha"] # correlated with soil sandniess and worse predictor (2.45 vs 1.34)

## Punjab_Haryana
pred_dashboard_6[which(pred_dashboard_6$potpreds == "SoilGrids_soc"), "Punjab_Haryana"] <- pred_cor[which(pred_cor$potpreds == "SoilGrids_soc"), "Punjab_Haryana"] # correlated with four vars and not good predictor
pred_dashboard_6[which(pred_dashboard_6$potpreds == "total_precip"), "Punjab_Haryana"] <- pred_cor[which(pred_cor$potpreds == "total_precip"), "Punjab_Haryana"] # correlated with four vars
pred_dashboard_6[which(pred_dashboard_6$potpreds == "SoilGrids_bdod"), "Punjab_Haryana"] <- pred_cor[which(pred_cor$potpreds == "SoilGrids_bdod"), "Punjab_Haryana"] # correlated with three vars (soc and rain already excluded) but worse predictor than soil sandiness (2.45 vs 1.66)
pred_dashboard_6[which(pred_dashboard_6$potpreds == "Nperc_7to30_DAT"), "Punjab_Haryana"] <- pred_cor[which(pred_cor$potpreds == "Nperc_7to30_DAT"), "Punjab_Haryana"] # correlated with early N and slightly worse predictor (1.25 vs 1.19)

# Clearing the other predictors 
for(k in 3:ncol(pred_dashboard_6)){
  pred_dashboard_6[which(pred_dashboard_6[,k] == "tbc"),k] <- "Included"
}

```

4.6) Identifying optimal paramteters for random forest models predicting relative NUE

```{r}
library('caret')
library('dplyr')


# Each region individually

for(i in 1:nrow(regs)){
for(j in 1:nrow(Nbins)){

if (i == 5 & j == 4) {next} # Skip 150-200 kg/ha in Odisha (low sample size)

response_name <- "above_or_below_spline"
predictor_names <- pred_dashboard_6[which(pred_dashboard_6[,regs[i,"Region"]] == "Included"), "potpreds"]
rf_formula <- as.formula(paste0(response_name, " ~ ", paste(predictor_names, collapse = " + ")))

working_data <- nib8[which(nib8$Region == regs[i,"Region"] &
                             nib8$N_kg_ha >= Nbins[j,"Nmin"] & nib8$N_kg_ha <= Nbins[j,"Nmax"]), c(response_name,predictor_names)]

(mtry.default <- floor(sqrt(dim(working_data)[2])))
getModelInfo("ranger")$ranger$parameters
system.time(
  ranger.tune <- train(
                    rf_formula,
                    data = working_data,
                    method="ranger",
                    tuneGrid = expand.grid(.mtry = (mtry.default-1):(mtry.default+3),
                    .splitrule = "gini",
                    .min.node.size = 2:6),
                    trControl = trainControl(method = 'cv')))
print(plot.train(ranger.tune, metric="Accuracy", main = paste0(regs[i,"Region"],"_",Nbins[j,"Nbins"])))
print(plot.train(ranger.tune, metric="Kappa", main = paste0(regs[i,"Region"],"_",Nbins[j,"Nbins"])))
}}



  
```

4.7) Defining optimal paramteters for random forest models predicting relative NUE

```{r}
# Make tables collating mtry (number of variables to possibly split at in each node) and min.node.size for each model
mtry_table <- data.frame(matrix(ncol = nrow(Nbins), nrow = nrow(regs) + 2))
colnames(mtry_table) <- Nbins[,"Nbins"]
rownames(mtry_table) <- c(regs[,"Region"], "Aggregated_aggSpline", "Aggregated_regSpline")

min_node_size_table <- data.frame(matrix(ncol = nrow(Nbins), nrow = nrow(regs) + 2))
colnames(min_node_size_table) <- Nbins[,"Nbins"]
rownames(min_node_size_table) <- c(regs[,"Region"], "Aggregated_aggSpline", "Aggregated_regSpline")

## AP
mtry_table["AP","50to200"] <- 6
min_node_size_table["AP","50to200"] <- 5
mtry_table["AP","50to100"] <- 6
min_node_size_table["AP","50to100"] <- 3
mtry_table["AP","100to150"] <- 7
min_node_size_table["AP","100to150"] <- 2
mtry_table["AP","150to200"] <- 7
min_node_size_table["AP","150to200"] <- 4

## Bangladesh
mtry_table["Bangladesh","50to200"] <- 7
min_node_size_table["Bangladesh","50to200"] <- 3
mtry_table["Bangladesh","50to100"] <- 4
min_node_size_table["Bangladesh","50to100"] <- 2
mtry_table["Bangladesh","100to150"] <- 3
min_node_size_table["Bangladesh","100to150"] <- 5
mtry_table["Bangladesh","150to200"] <- 3
min_node_size_table["Bangladesh","150to200"] <- 2

## Bihar
mtry_table["Bihar","50to200"] <- 9
min_node_size_table["Bihar","50to200"] <- 3
mtry_table["Bihar","50to100"] <- 6
min_node_size_table["Bihar","50to100"] <- 4
mtry_table["Bihar","100to150"] <- 8
min_node_size_table["Bihar","100to150"] <- 6
mtry_table["Bihar","150to200"] <- 6
min_node_size_table["Bihar","150to200"] <- 5

## Nepal
mtry_table["Nepal","50to200"] <- 7
min_node_size_table["Nepal","50to200"] <- 4
mtry_table["Nepal","50to100"] <- 8
min_node_size_table["Nepal","50to100"] <- 2
mtry_table["Nepal","100to150"] <- 4
min_node_size_table["Nepal","100to150"] <- 2
mtry_table["Nepal","150to200"] <- 4
min_node_size_table["Nepal","150to200"] <- 6

## Odisha
mtry_table["Odisha","50to200"] <- 8
min_node_size_table["Odisha","50to200"] <- 2
mtry_table["Odisha","50to100"] <- 6
min_node_size_table["Odisha","50to100"] <- 6
mtry_table["Odisha","100to150"] <- 5
min_node_size_table["Odisha","100to150"] <- 4
# mtry_table["Odisha","150to200"] <- 14
# min_node_size_table["Odisha","150to200"] <- 4

## Punjab_Haryana
mtry_table["Punjab_Haryana","50to200"] <- 6
min_node_size_table["Punjab_Haryana","50to200"] <- 5
mtry_table["Punjab_Haryana","50to100"] <- 7
min_node_size_table["Punjab_Haryana","50to100"] <- 6
mtry_table["Punjab_Haryana","100to150"] <- 3
min_node_size_table["Punjab_Haryana","100to150"] <- 6
mtry_table["Punjab_Haryana","150to200"] <- 4
min_node_size_table["Punjab_Haryana","150to200"] <- 4


```

4.8) Fitting random forest models predicting relative NUE

```{r}

require('ranger')

## Modeling each region individually
for(i in 1:nrow(regs)){
for(j in 1:nrow(Nbins)){

if (i == 5 & j == 4) {next} # Skip 150-200 kg/ha in Odisha (low sample size)

response_name <- "above_or_below_spline"
predictor_names <- pred_dashboard_6[which(pred_dashboard_6[,regs[i,"Region"]] == "Included"), "potpreds"]
rf_formula <- as.formula(paste0(response_name, " ~ ", paste(predictor_names, collapse = " + ")))
working_data <- nib8[which(nib8$Region == regs[i,"Region"] &
                             nib8$N_kg_ha >= Nbins[j,"Nmin"] & nib8$N_kg_ha <= Nbins[j,"Nmax"]),]

rf_model <- ranger(formula = rf_formula, data = working_data,importance = "permutation"
                   , probability = T
    , mtry = mtry_table[regs[i,"Region"],Nbins[j,"Nbins"]]
    , min.node.size = min_node_size_table[regs[i,"Region"],Nbins[j,"Nbins"]]
)
summary(model_fit <- predict(rf_model, data = working_data)$predictions)
assign(paste0("RF_CTclass_PFPvsN_",regs[i,"Region"], "_", Nbins[j,"Nbins"]), rf_model)
}}

## Make table collating error for each model
PredictionAccuracyOOB  <- data.frame(matrix(ncol = nrow(Nbins), nrow = nrow(regs)
                                            # + 2
                                            ))
colnames(PredictionAccuracyOOB) <- Nbins[,"Nbins"]
rownames(PredictionAccuracyOOB) <- c(regs[,"Region"]
                               # , "Aggregated_aggSpline", "Aggregated_regSpline"
                               )

for (i in 1:nrow(regs)){
for(j in 1:nrow(Nbins)){

if (i == 5 & j == 4) {next} # Skip 150-200 kg/ha in Odisha (low sample size)

PAoob <- 100*(1 - get(paste("RF_CTclass_PFPvsN_", regs[i,"Region"], "_", Nbins[j,"Nbins"],sep = ""))$prediction.error)
Sample_size <- get(paste0("RF_CTclass_PFPvsN_",regs[i,"Region"], "_", Nbins[j,"Nbins"]))$num.samples
PredictionAccuracyOOB[i,j] <- paste0(round(PAoob,0),"% (n=", Sample_size, ")"
                        )
}}

## Make table collating confusion matric for each model
PredictionAccuracy_confusion  <- data.frame(matrix(ncol = 4, nrow = nrow(regs)
                                            # + 2
                                            ))
colnames(PredictionAccuracy_confusion) <- c("Above_correct","Below_correct","Overestimated","Underestimated")
rownames(PredictionAccuracy_confusion) <- c(regs[,"Region"]
                               # , "Aggregated_aggSpline", "Aggregated_regSpline"
                               )

for (i in 1:nrow(regs)){
PredictionAccuracy_confusion[i,"Above_correct"] <- paste0(round(get(paste("RF_CTclass_PFPvsN_", regs[i,"Region"], "_50to200",sep = ""))$confusion.matrix[1,1] / nrow(nib8[which(nib8$Region == regs[i,"Region"]),])*100,0),"%")
PredictionAccuracy_confusion[i,"Below_correct"] <- paste0(round(get(paste("RF_CTclass_PFPvsN_", regs[i,"Region"], "_50to200",sep = ""))$confusion.matrix[2,2] / nrow(nib8[which(nib8$Region == regs[i,"Region"]),])*100,0),"%")
PredictionAccuracy_confusion[i,"Overestimated"] <- paste0(round(get(paste("RF_CTclass_PFPvsN_", regs[i,"Region"], "_50to200",sep = ""))$confusion.matrix[2,1] / nrow(nib8[which(nib8$Region == regs[i,"Region"]),])*100,0),"%")
PredictionAccuracy_confusion[i,"Underestimated"] <- paste0(round(get(paste("RF_CTclass_PFPvsN_", regs[i,"Region"], "_50to200",sep = ""))$confusion.matrix[1,2] / nrow(nib8[which(nib8$Region == regs[i,"Region"]),])*100,0),"%")
  }

# Make nice table
PredictionAccuracyOOB_nice <- PredictionAccuracyOOB
colnames(PredictionAccuracyOOB_nice)[1] <- "RF_50to200"
colnames(PredictionAccuracyOOB_nice)[2] <- "RF_50to100"
colnames(PredictionAccuracyOOB_nice)[3] <- "RF_100to150"
colnames(PredictionAccuracyOOB_nice)[4] <- "RF_150to200"


Test_green_simples <- formatter("span",
                  style = x ~ style(display = "inline-block", color = "black","border-radius" = "4px",
                                    "padding-right" = "4px", width = "75px",
                                    "background-color" = csscolor(gradient(as.numeric(x), "transparent", "forestgreen"))))
formattable(PredictionAccuracyOOB_nice,
            row.names = T,
            align = "c",
            list(
              RF_50to200 = Test_green_simples,
              RF_50to100  = Test_green_simples,
              RF_100to150 = Test_green_simples,
              RF_150to200 = Test_green_simples
            ))

```

4.9) Defining predictor assessment framework for random forest models predicting relative NUE

```{r}

pred_comparison2 <- pred_dashboard_6

# Importance
for(j in 1:nrow(Nbins)){ 

pred_comparison2[,paste0("Importance_mean","_", Nbins[j,"Nbins"])] <- NA
pred_comparison2[,paste0("Importance_median","_", Nbins[j,"Nbins"])] <- NA
}

# Setting up framework for each model
pred_comparison_PFPvsN <- pred_comparison2
pred_comparison_NUEvsN_regression <- pred_comparison2



```

4.10) Estimating Shapley values for random forest models predicing relative NUE

```{r}
set.seed(42)
pfun <- function(object, newdata) predict(object, data = newdata)$predictions[,"Above"]



varImportance_start <- Sys.time()

# Each region

for(i in 1:nrow(regs)){
for(j in 1:nrow(Nbins)){

if (i == 5 & j == 4) {next} # Skip 150-200 kg/ha in Odisha (low sample size)

region <- regs[i,"Region"]

## Identify predictor data
predictor_names <- pred_dashboard_6[which(pred_dashboard_6[,region] == "Included"), "potpreds"]
predictor_data <- nib8[which(nib8$Region == region &
                             nib8$N_kg_ha >= Nbins[j,"Nmin"] & nib8$N_kg_ha <= Nbins[j,"Nmax"]), predictor_names]

## Identify model
model_name <- paste0("RF_CTclass_PFPvsN_",region, "_", Nbins[j,"Nbins"])

# Calculate local shap (i.e. average predictor importance for EACH row)
shap <- fastshap::explain(get(model_name),
                          X = predictor_data,
                          pred_wrapper = pfun,
                          adjust = T, # This asks SHAP to say how much each predictor pushed prediction away from average prediction
                          nsim = 10)

# Calculate global shap (i.e. average predictor importance for ALL rows)
shap_imp <- data.frame(
  Variable = names(shap),
  Importance = apply(shap, MARGIN = 2, FUN = function(x) mean(abs(x)))
)


    
## Plug values into dashboard
for(y in 1:nrow(pred_comparison_PFPvsN)){
name_of_predictor <- pred_comparison_PFPvsN[y,"potpreds"]
if(pred_comparison_PFPvsN[y,region] != "Included") next
pred_comparison_PFPvsN[y, paste("Importance_",region,"_",Nbins[j,"Nbins"], sep="")] <- round((shap_imp[which(shap_imp$Variable == name_of_predictor),"Importance"]),4)
}

## Create shap importance plot
print(ggplot(shap_imp, aes(reorder(Variable, Importance), Importance)) +
  geom_col() +
  coord_flip() +
  xlab("") +
  # xlim(c(0,0.08)) +
  ylab(paste0("Mean shap value in ",region)))

## Store variable importance results and plot
assign(paste("shap_imp_","CTclass","_",region,"_",Nbins[j,"Nbins"], sep = ""),shap_imp)
assign(paste("shap_","CTclass","_",region,"_",Nbins[j,"Nbins"], sep = ""),shap)
# assign(paste("var_importance_plot_","CTclass","_",region,"_",Nbins[j,"Nbins"], sep = ""),var_importance_plot)
}}

# Calculate averages across regions

## 50to200
pred_comparison_PFPvsN$Importance_mean_50to200 <- rowMeans(pred_comparison_PFPvsN[,c(
  "Importance_AP_50to200",
  "Importance_Bangladesh_50to200",
  "Importance_Bihar_50to200",
  "Importance_Nepal_50to200",
  "Importance_Odisha_50to200",
  "Importance_Punjab_Haryana_50to200")],
  na.rm = TRUE)

## 50to100
pred_comparison_PFPvsN$Importance_mean_50to100 <- rowMeans(pred_comparison_PFPvsN[,c(
  "Importance_AP_50to100",
  "Importance_Bangladesh_50to100",
  "Importance_Bihar_50to100",
  "Importance_Nepal_50to100",
  "Importance_Odisha_50to100",
  "Importance_Punjab_Haryana_50to100")],
  na.rm = TRUE)

## 100to150
pred_comparison_PFPvsN$Importance_mean_100to150 <- rowMeans(pred_comparison_PFPvsN[,c(
  "Importance_AP_100to150",
  "Importance_Bangladesh_100to150",
  "Importance_Bihar_100to150",
  "Importance_Nepal_100to150",
  "Importance_Odisha_100to150",
  "Importance_Punjab_Haryana_100to150")],
  na.rm = TRUE)

## 150to200
pred_comparison_PFPvsN$Importance_mean_150to200 <- rowMeans(pred_comparison_PFPvsN[,c(
  "Importance_AP_150to200",
  "Importance_Bangladesh_150to200",
  "Importance_Bihar_150to200",
  "Importance_Nepal_150to200",
  # "Importance_Odisha_150to200", # Doesn't exist
  "Importance_Punjab_Haryana_150to200")],
  na.rm = TRUE)

# Work out computational time
varImportance_end <- Sys.time()
print(round(varImportance_end - varImportance_start),0)
```

4.11) Visualising predictor importance for random forest models predicing relative NUE for different regions (Figure 3) and different nitrogen application rates (Figure S4 in Supplementary Information 7)

```{r}

library("formattable")
library("htmltools")
library("webshot")   

# Prep data
## Get columns of interest
simples1 <- pred_comparison_PFPvsN[,c("potpreds",
                                     "Importance_AP_50to200",
                                     "Importance_Bangladesh_50to200",
                                     "Importance_Bihar_50to200",
                                     "Importance_Nepal_50to200",
                                     "Importance_Odisha_50to200",
                                     "Importance_Punjab_Haryana_50to200",
                                     "Importance_mean_50to200",
                                     "Importance_mean_50to100",
                                     "Importance_mean_100to150",
                                     "Importance_mean_150to200"
                                  ),]

## Put mean at front
simples1 <- simples1[,c(
  "potpreds",
  "Importance_mean_50to200",
  "Importance_AP_50to200",
  "Importance_Bangladesh_50to200",
  "Importance_Bihar_50to200",
  "Importance_Nepal_50to200",
  "Importance_Odisha_50to200",
  "Importance_Punjab_Haryana_50to200",
  "Importance_mean_50to100",
  "Importance_mean_100to150",
  "Importance_mean_150to200"
)]


## Order rows from highest median or median  importance to lowest
simples1 <- simples1[order(simples1$Importance_mean_50to200, decreasing = T),]

## Cut rows with all NAs
simples1 <- simples1[is.na(simples1$Importance_mean_50to200) == F,]

## Convert to percentage AND round
for(i in 2:ncol(simples1)){
for(w in 1:nrow(simples1)){
simples1[w,i] <- as.numeric(simples1[w,i]) * 100
simples1[w,i] <- round(as.numeric(simples1[w,i]), 2)
}}

## Make NA invisble
fnc = function(var, decimal.places) {
  var = sprintf(paste0("%1.",decimal.places,"f"), var)
  var[var=="NA"] = ""
  var
}
vars <- c(
  "Importance_mean_50to200",
  "Importance_AP_50to200",
  "Importance_Bangladesh_50to200",
  "Importance_Bihar_50to200",
  "Importance_Nepal_50to200",
  "Importance_Odisha_50to200",
  "Importance_Punjab_Haryana_50to200",
  "Importance_mean_50to100",
  "Importance_mean_100to150",
  "Importance_mean_150to200"
                         )
simples1[,vars] <- mapply(fnc,simples1[,vars],2)




# Categorize predictors
simples1$Category <- "Unallocated"
simples1[which(simples1$potpreds == "total_precip"),"Category"] <- "Rainfall" 
simples1[which(simples1$potpreds == "monsoon_onset"),"Category"] <- "Rainfall"
simples1[which(simples1$potpreds == "SPRODMR"),"Category"] <- "Socio-economic"
simples1[which(simples1$potpreds == "Field_duration"),"Category"] <- "Crop timing"
simples1[which(simples1$potpreds == "IRRINU"),"Category"] <- "Irrigation"
simples1[which(simples1$potpreds == "TDATE_rel"),"Category"] <- "Crop timing"
simples1[which(simples1$potpreds == "monsoon_retreat"),"Category"] <- "Rainfall"
simples1[which(simples1$potpreds == "avg_dspell_length"),"Category"] <- "Rainfall"
simples1[which(simples1$potpreds == "DCLASS"),"Category"] <- "Soil and landscape"
simples1[which(simples1$potpreds == "DISEV"),"Category"] <- "Other management"
simples1[which(simples1$potpreds == "DISMR"),"Category"] <- "Socio-economic"
simples1[which(simples1$potpreds == "DRSEV"),"Category"] <- "Rainfall"
simples1[which(simples1$potpreds == "EDU"),"Category"] <- "Socio-economic" 
simples1[which(simples1$potpreds == "EST_line"),"Category"] <- "Other management" # Unclear
simples1[which(simples1$potpreds == "FLSEV"),"Category"] <- "Rainfall" 
simples1[which(simples1$potpreds == "GEN"),"Category"] <- "Socio-economic"
simples1[which(simples1$potpreds == "GYP_ha"),"Category"] <- "Nutrient management"
simples1[which(simples1$potpreds == "HHMEM"),"Category"] <- "Socio-economic" 
simples1[which(simples1$potpreds == "HIFAG"),"Category"] <- "Socio-economic"
simples1[which(simples1$potpreds == "K2O_ha"),"Category"] <- "Nutrient management"
simples1[which(simples1$potpreds == "LOD"),"Category"] <- "Other management" # Unclear
simples1[which(simples1$potpreds == "MaxUnsplit_Nperc_within_1_days"),"Category"] <- "Nutrient management"
simples1[which(simples1$potpreds == "Nperc_7to30_DAT"),"Category"] <- "Nutrient management"
simples1[which(simples1$potpreds == "Nperc_pre_7_DAT"),"Category"] <- "Nutrient management"
simples1[which(simples1$potpreds == "Nursery_duration"),"Category"] <- "Crop timing"
simples1[which(simples1$potpreds == "Organic_ha"),"Category"] <- "Nutrient management"
simples1[which(simples1$potpreds == "P2O5_ha"),"Category"] <- "Nutrient management"
simples1[which(simples1$potpreds == "PCRR"),"Category"] <- "Nutrient management"
simples1[which(simples1$potpreds == "SOCCAT"),"Category"] <- "Socio-economic"
simples1[which(simples1$potpreds == "SoilGrids_bdod"),"Category"] <- "Soil and landscape"
simples1[which(simples1$potpreds == "SoilGrids_phh2o"),"Category"] <- "Soil and landscape"
simples1[which(simples1$potpreds == "SoilGrids_sand"),"Category"] <- "Soil and landscape"
simples1[which(simples1$potpreds == "SoilGrids_soc"),"Category"] <- "Soil and landscape"
simples1[which(simples1$potpreds == "SOILTEX"),"Category"] <- "Soil and landscape"
simples1[which(simples1$potpreds == "SOPER"),"Category"] <- "Soil and landscape"
simples1[which(simples1$potpreds == "SRATEHA"),"Category"] <- "Other management"
simples1[which(simples1$potpreds == "VARTYPE"),"Category"] <- "Other management"
simples1[which(simples1$potpreds == "WSEV"),"Category"] <- "Other management"
simples1[which(simples1$potpreds == "Zn_ha"),"Category"] <- "Nutrient management"

# Rename potpredss
simples1[which(simples1$potpreds == "total_precip"),"potpreds"] <- "Total rainfall" 
simples1[which(simples1$potpreds == "monsoon_onset"),"potpreds"] <- "Monsoon onset date"
simples1[which(simples1$potpreds == "SPRODMR"),"potpreds"] <- "Market engagement"
simples1[which(simples1$potpreds == "Field_duration"),"potpreds"] <- "Field duration"
simples1[which(simples1$potpreds == "IRRINU"),"potpreds"] <- "Number of irrigations"
simples1[which(simples1$potpreds == "TDATE_rel"),"potpreds"] <- "Transplanting date"
simples1[which(simples1$potpreds == "monsoon_retreat"),"potpreds"] <- "Monsoon retreat date"
simples1[which(simples1$potpreds == "avg_dspell_length"),"potpreds"] <- "Average dry spell length"
simples1[which(simples1$potpreds == "DCLASS"),"potpreds"] <- "Landscape position"
simples1[which(simples1$potpreds == "DISEV"),"potpreds"] <- "Disease severity"
simples1[which(simples1$potpreds == "DISMR"),"potpreds"] <- "Market distance"
simples1[which(simples1$potpreds == "DRSEV"),"potpreds"] <- "Drought severity"
simples1[which(simples1$potpreds == "EDU"),"potpreds"] <- "Farmer education" 
simples1[which(simples1$potpreds == "EST_line"),"potpreds"] <- "Transplanting method" # Unclear
simples1[which(simples1$potpreds == "FLSEV"),"potpreds"] <- "Flood severity" 
simples1[which(simples1$potpreds == "GEN"),"potpreds"] <- "Farmer gender"
simples1[which(simples1$potpreds == "GYP_ha"),"potpreds"] <- "Gypsum fertilizer"
simples1[which(simples1$potpreds == "HHMEM"),"potpreds"] <- "Household members" 
simples1[which(simples1$potpreds == "HIFAG"),"potpreds"] <- "Farm income dependence"
simples1[which(simples1$potpreds == "K2O_ha"),"potpreds"] <- "Potassium fertilizer"
simples1[which(simples1$potpreds == "LOD"),"potpreds"] <- "Lodging" # Unclear
simples1[which(simples1$potpreds == "MaxUnsplit_Nperc_within_1_days"),"potpreds"] <- "Nitrogen splitting"
simples1[which(simples1$potpreds == "Nperc_7to30_DAT"),"potpreds"] <- "Nitrogen applied at tillering"
simples1[which(simples1$potpreds == "Nperc_pre_7_DAT"),"potpreds"] <- "Nitrogen applied at planting"
simples1[which(simples1$potpreds == "Nursery_duration"),"potpreds"] <- "Nursery duration"
simples1[which(simples1$potpreds == "Organic_ha"),"potpreds"] <- "Organic fertilizer"
simples1[which(simples1$potpreds == "P2O5_ha"),"potpreds"] <- "Phosphorous fertilizer"
simples1[which(simples1$potpreds == "PCRR"),"potpreds"] <- "Previous crop residue"
simples1[which(simples1$potpreds == "SOCCAT"),"potpreds"] <- "Farmer social category"
simples1[which(simples1$potpreds == "SoilGrids_bdod"),"potpreds"] <- "Soil density"
simples1[which(simples1$potpreds == "SoilGrids_phh2o"),"potpreds"] <- "Soil pH"
simples1[which(simples1$potpreds == "SoilGrids_sand"),"potpreds"] <- "Soil sandiness"
simples1[which(simples1$potpreds == "SoilGrids_soc"),"potpreds"] <- "Soil carbon"
simples1[which(simples1$potpreds == "SOILTEX"),"potpreds"] <- "Farmer-judged soil texture"
simples1[which(simples1$potpreds == "SOPER"),"potpreds"] <- "Farmer soil perception"
simples1[which(simples1$potpreds == "SRATEHA"),"potpreds"] <- "Seed rate"
simples1[which(simples1$potpreds == "VARTYPE"),"potpreds"] <- "Variety type"
simples1[which(simples1$potpreds == "WSEV"),"potpreds"] <- "Weed severity"
simples1[which(simples1$potpreds == "Zn_ha"),"potpreds"] <- "Zinc fertilizer"


# Make some nice table formatting

Test4 <- formatter("span",
                  style = x ~ style(display = "inline-block", color = "black","border-radius" = "4px",
                                    "padding-right" = "4px", width = "75px",
                                    "background-color" = ifelse(as.numeric(x) <= .2, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[5],
                                                         ifelse(as.numeric(x) <= .4, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[10],
                                                         ifelse(as.numeric(x) <= .6, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[15],
                                                         ifelse(as.numeric(x) <= .8, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[20],
                                                         ifelse(as.numeric(x) <= 1, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[25],
                                                         ifelse(as.numeric(x) <= 1.2, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[30],
                                                         ifelse(as.numeric(x) <= 1.4, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[35],
                                                         ifelse(as.numeric(x) <= 1.6, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[40],
                                                         ifelse(as.numeric(x) <= 1.8, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[45],
                                                         ifelse(as.numeric(x) <= 2, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[50],
                                                         ifelse(as.numeric(x) <= 2.2, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[55],
                                                         ifelse(as.numeric(x) <= 2.4, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[60],
                                                         ifelse(as.numeric(x) <= 2.6, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[65],
                                                         ifelse(as.numeric(x) <= 2.8, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[70],
                                                         ifelse(as.numeric(x) <= 3, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[75],
                                                         ifelse(as.numeric(x) <= 3.2, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[80],
                                                         ifelse(as.numeric(x) <= 3.4, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[85],
                                                         ifelse(as.numeric(x) <= 3.6, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[90],
                                                         ifelse(as.numeric(x) <= 3.8, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[95],
                                                         ifelse(as.numeric(x) <= 4, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[100],
                                                         ifelse(as.numeric(x) <= 4.2, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[105],
                                                         ifelse(as.numeric(x) <= 4.4, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[110],
                                                         ifelse(as.numeric(x) <= 4.6, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[115],
                                                         ifelse(as.numeric(x) <= 4.8, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[120],
                                                         ifelse(as.numeric(x) <= 5, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[125],
                                                         ifelse(as.numeric(x) <= 5.2, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[130],
                                                         ifelse(as.numeric(x) <= 5.4, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[135],
                                                         ifelse(as.numeric(x) <= 5.6, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[140],
                                                         ifelse(as.numeric(x) <= 5.8, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[145],
                                                         ifelse(as.numeric(x) <= 6, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[150],
                                                         ifelse(as.numeric(x) <= 6.2, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[155],
                                                         ifelse(as.numeric(x) <= 6.4, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[160],
                                                         ifelse(as.numeric(x) <= 6.6, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[165],
                                                         ifelse(as.numeric(x) <= 6.8, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[170],
                                                         ifelse(as.numeric(x) <= 7, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[175],
                                                         "green"))))))))))))))))))))))))))))))))))))) 

Test5 <- formatter("span",
                  style = x ~ style(display = "inline-block",
                                    font.weight = "bold", # here the change
                                    color = "black","border-radius" = "4px",
                                    "padding-right" = "4px", width = "75px",
                                    "background-color" = ifelse(as.numeric(x) <= .2, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[5],
                                                         ifelse(as.numeric(x) <= .4, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[10],
                                                         ifelse(as.numeric(x) <= .6, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[15],
                                                         ifelse(as.numeric(x) <= .8, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[20],
                                                         ifelse(as.numeric(x) <= 1, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[25],
                                                         ifelse(as.numeric(x) <= 1.2, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[30],
                                                         ifelse(as.numeric(x) <= 1.4, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[35],
                                                         ifelse(as.numeric(x) <= 1.6, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[40],
                                                         ifelse(as.numeric(x) <= 1.8, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[45],
                                                         ifelse(as.numeric(x) <= 2, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[50],
                                                         ifelse(as.numeric(x) <= 2.2, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[55],
                                                         ifelse(as.numeric(x) <= 2.4, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[60],
                                                         ifelse(as.numeric(x) <= 2.6, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[65],
                                                         ifelse(as.numeric(x) <= 2.8, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[70],
                                                         ifelse(as.numeric(x) <= 3, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[75],
                                                         ifelse(as.numeric(x) <= 3.2, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[80],
                                                         ifelse(as.numeric(x) <= 3.4, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[85],
                                                         ifelse(as.numeric(x) <= 3.6, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[90],
                                                         ifelse(as.numeric(x) <= 3.8, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[95],
                                                         ifelse(as.numeric(x) <= 4, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[100],
                                                         ifelse(as.numeric(x) <= 4.2, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[105],
                                                         ifelse(as.numeric(x) <= 4.4, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[110],
                                                         ifelse(as.numeric(x) <= 4.6, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[115],
                                                         ifelse(as.numeric(x) <= 4.8, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[120],
                                                         ifelse(as.numeric(x) <= 5, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[125],
                                                         ifelse(as.numeric(x) <= 5.2, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[130],
                                                         ifelse(as.numeric(x) <= 5.4, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[135],
                                                         ifelse(as.numeric(x) <= 5.6, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[140],
                                                         ifelse(as.numeric(x) <= 5.8, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[145],
                                                         ifelse(as.numeric(x) <= 6, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[150],
                                                         ifelse(as.numeric(x) <= 6.2, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[155],
                                                         ifelse(as.numeric(x) <= 6.4, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[160],
                                                         ifelse(as.numeric(x) <= 6.6, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[165],
                                                         ifelse(as.numeric(x) <= 6.8, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[170],
                                                         ifelse(as.numeric(x) <= 7, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[175],
                                                         "green")))))))))))))))))))))))))))))))))))))                  

Predictor_column <- formatter("span",
                            style = x ~ style(display = "inline-block", color = "black","border-radius" = "4px",                  
                            "padding-right" = "4px", width = "200px"))


Category_colour <- formatter("span",
                            style = x ~ style(display = "inline-block", font.style = "italic", color = "black","border-radius" = "4px",                  
                            "padding-right" = "4px", width = "150px",
                            "background-color" = ifelse(x == "Other management", "darkgoldenrod",
                                                        ifelse(x == "Nutrient management", "mediumseagreen",
                                                        ifelse(x == "Soil and landscape", "chocolate",
                                                        ifelse(x == "Socio-economic", "lightgrey",
                                                        ifelse(x == "Rainfall", "cornflowerblue",
                                                        ifelse(x == "Crop timing", "indianred",
                                                        ifelse(x == "Irrigation", "skyblue",
                                                               "white"
                                                        )))))))))


# Make nice table disaggregating by region

## Getting relevant data
simples1_region <- simples1[,c(
  "potpreds",
  "Category",
  "Importance_mean_50to200",
  "Importance_AP_50to200",
  "Importance_Bangladesh_50to200",
  "Importance_Bihar_50to200",
  "Importance_Nepal_50to200",
  "Importance_Odisha_50to200",
  "Importance_Punjab_Haryana_50to200"
)]

# Add R2 and sample size
Model_detail <- as.data.frame(c("Model accuracy (OOB)", "Sample size"))
colnames(Model_detail)[1] <- "potpreds"
Model_detail$Category <- c("","")
Model_detail$Importance_mean_50to200 <- c("","")
for(i in 1:nrow(regs)){
Model_detail[,paste0("Importance_",regs[i,"Region"],"_50to200")] <- c(
  paste0(round(100*(1 - get(paste0("RF_CTclass_PFPvsN_", regs[i,"Region"], "_50to200"))$prediction.error),0),"%"),
  paste0("n=",round(get(paste0("RF_CTclass_PFPvsN_",regs[i,"Region"], "_50to200"))$num.samples
,0)))
}

simples1_region2 <- rbind(Model_detail, simples1_region)

# Reorder regions
simples1_region3 <- simples1_region2[,c(1,2,3,4,6,8,9,5,7)]

## Present table disaggregating by region (Figure 3)
Figure3 <- formattable(simples1_region3,
            row.names = F,
            col.names = c(
              "Predictor",
              "Category",
              "Mean",
              "Andhra Pradesh",
              "Bihar and E.U.P.",
              "Odisha",
              "Punjab & Haryana",
              "Bangladesh floodplains",
              "Terai of Nepal"),
            align = "c",
            list(
              potpreds = Predictor_column,
              Category = Category_colour,
              Importance_mean_50to200 = Test5,
              Importance_AP_50to200 = Test4,
              Importance_Bangladesh_50to200 = Test4,
              Importance_Bihar_50to200 = Test4,
              Importance_Nepal_50to200 = Test4,
              Importance_Odisha_50to200 = Test4,
              Importance_Punjab_Haryana_50to200 = Test4
            ))

# Make nice table disaggregating by N rate bin

## Getting relevant data
simples1_region <- simples1[,c(
  "potpreds",
  "Category",
  "Importance_mean_50to200",
  "Importance_mean_50to100",
  "Importance_mean_100to150",
  "Importance_mean_150to200"
)]

## Make table
FigureS4 <- formattable(simples1_region,
            row.names = F,
            col.names = c(
              "Predictor",
              "Category",
              "50-200 kg/ha",
              "50-100 kg/ha",
              "100-150 kg/ha",
              "150-200 kg/ha"),
            align = "c",
            list(
              potpreds = Predictor_column,
              Category = Category_colour,
              Importance_mean_50to200 = Test5,
              Importance_mean_50to100 = Test4,
              Importance_mean_100to150 = Test4,
              Importance_mean_150to200 = Test4))

# save table
setwd('[insert working directory]')

export_formattable <- function(f, file, width = 1000, height = 1500, 
                               background = "white", delay = 0.2, zoom = 5)
    {
      w <- as.htmlwidget(f, width = width, height = height)
      path <- html_print(w, background = background, viewer = NULL)
      url <- paste0("file:///", gsub("\\\\", "/", normalizePath(path)))
      webshot(url,
              file = file,
              selector = ".formattable_widget",
              delay = delay,
              zoom = zoom)
    }

export_formattable(Figure3,"Figure3.png")
export_formattable(FigureS4,"FigureS4.png")

```

4.12) Dependence plots for most importance predictors of relative NUE (Figure 4 & Figure S8 in Supplementary Information 8) 

```{r}
library(ggplot2)
library(gridtext)
library(gridExtra)
library(grid)

regs$Region_figurename3 <- regs$Region_figurename
regs[which(regs$Region == "Bangladesh"),"Region_figurename3"] <- "Bangladesh's floodplains"

# Setting parameters for each variable

## Making framework
pdp_vars <- as.data.frame(c(
  "IRRINU"
  ,"total_precip"
  ,"TDATE_rel"
  ,"Field_duration"
  ,"monsoon_onset"
  ))
colnames(pdp_vars)[1] <- "Variable"
pdp_vars$Variable_figurename <- NA

## IRRINU
pdp_vars[which(pdp_vars$Variable == "IRRINU"), "Variable_figurename"] <- "Number of irrigations" 

pdp_vars[which(pdp_vars$Variable == "IRRINU"), "xmin_IRRINU_AP"] <- -1
pdp_vars[which(pdp_vars$Variable == "IRRINU"), "xmax_IRRINU_AP"] <- 15.9
pdp_vars[which(pdp_vars$Variable == "IRRINU"), "xmin_IRRINU_Bangladesh"] <- NA
pdp_vars[which(pdp_vars$Variable == "IRRINU"), "xmax_IRRINU_Bangladesh"] <- NA
pdp_vars[which(pdp_vars$Variable == "IRRINU"), "xmin_IRRINU_Bihar"] <- -1
pdp_vars[which(pdp_vars$Variable == "IRRINU"), "xmax_IRRINU_Bihar"] <- 15.9
pdp_vars[which(pdp_vars$Variable == "IRRINU"), "xmin_IRRINU_Nepal"] <- -1
pdp_vars[which(pdp_vars$Variable == "IRRINU"), "xmax_IRRINU_Nepal"] <- 15.9
pdp_vars[which(pdp_vars$Variable == "IRRINU"), "xmin_IRRINU_Odisha"] <- -1
pdp_vars[which(pdp_vars$Variable == "IRRINU"), "xmax_IRRINU_Odisha"] <- 15.9
pdp_vars[which(pdp_vars$Variable == "IRRINU"), "xmin_IRRINU_Punjab_Haryana"] <- -1
pdp_vars[which(pdp_vars$Variable == "IRRINU"), "xmax_IRRINU_Punjab_Haryana"] <- 60.9

## total_precip
pdp_vars[which(pdp_vars$Variable == "total_precip"), "Variable_figurename"] <- "Total precipitation for the year (mm)" 

pdp_vars[which(pdp_vars$Variable == "total_precip"), "xmin_total_precip_AP"] <- -1
pdp_vars[which(pdp_vars$Variable == "total_precip"), "xmax_total_precip_AP"] <- 3500
pdp_vars[which(pdp_vars$Variable == "total_precip"), "xmin_total_precip_Bangladesh"] <- -1
pdp_vars[which(pdp_vars$Variable == "total_precip"), "xmax_total_precip_Bangladesh"] <- 3500
pdp_vars[which(pdp_vars$Variable == "total_precip"), "xmin_total_precip_Bihar"] <- -1
pdp_vars[which(pdp_vars$Variable == "total_precip"), "xmax_total_precip_Bihar"] <- 3500
pdp_vars[which(pdp_vars$Variable == "total_precip"), "xmin_total_precip_Nepal"] <- -1
pdp_vars[which(pdp_vars$Variable == "total_precip"), "xmax_total_precip_Nepal"] <- 3500
pdp_vars[which(pdp_vars$Variable == "total_precip"), "xmin_total_precip_Odisha"] <- -1
pdp_vars[which(pdp_vars$Variable == "total_precip"), "xmax_total_precip_Odisha"] <- 3500
pdp_vars[which(pdp_vars$Variable == "total_precip"), "xmin_total_precip_Punjab_Haryana"] <- NA
pdp_vars[which(pdp_vars$Variable == "total_precip"), "xmax_total_precip_Punjab_Haryana"] <- NA

## TDATE_rel
pdp_vars[which(pdp_vars$Variable == "TDATE_rel"), "Variable_figurename"] <- "Transplanting date relative to regional median (days)" 

pdp_vars[which(pdp_vars$Variable == "TDATE_rel"), "xmin_TDATE_rel_AP"] <- -26
pdp_vars[which(pdp_vars$Variable == "TDATE_rel"), "xmax_TDATE_rel_AP"] <- 26
pdp_vars[which(pdp_vars$Variable == "TDATE_rel"), "xmin_TDATE_rel_Bangladesh"] <- -26
pdp_vars[which(pdp_vars$Variable == "TDATE_rel"), "xmax_TDATE_rel_Bangladesh"] <- 26
pdp_vars[which(pdp_vars$Variable == "TDATE_rel"), "xmin_TDATE_rel_Bihar"] <- -26
pdp_vars[which(pdp_vars$Variable == "TDATE_rel"), "xmax_TDATE_rel_Bihar"] <- 26
pdp_vars[which(pdp_vars$Variable == "TDATE_rel"), "xmin_TDATE_rel_Nepal"] <- -26
pdp_vars[which(pdp_vars$Variable == "TDATE_rel"), "xmax_TDATE_rel_Nepal"] <- 26
pdp_vars[which(pdp_vars$Variable == "TDATE_rel"), "xmin_TDATE_rel_Odisha"] <- -26
pdp_vars[which(pdp_vars$Variable == "TDATE_rel"), "xmax_TDATE_rel_Odisha"] <- 26
pdp_vars[which(pdp_vars$Variable == "TDATE_rel"), "xmin_TDATE_rel_Punjab_Haryana"] <- -26
pdp_vars[which(pdp_vars$Variable == "TDATE_rel"), "xmax_TDATE_rel_Punjab_Haryana"] <- 26

## Field_duration
pdp_vars[which(pdp_vars$Variable == "Field_duration"), "Variable_figurename"] <- "Field duration (days)" 

pdp_vars[which(pdp_vars$Variable == "Field_duration"), "xmin_Field_duration_AP"] <- 59
pdp_vars[which(pdp_vars$Variable == "Field_duration"), "xmax_Field_duration_AP"] <- 200
pdp_vars[which(pdp_vars$Variable == "Field_duration"), "xmin_Field_duration_Bangladesh"] <- 59
pdp_vars[which(pdp_vars$Variable == "Field_duration"), "xmax_Field_duration_Bangladesh"] <- 200
pdp_vars[which(pdp_vars$Variable == "Field_duration"), "xmin_Field_duration_Bihar"] <- 59
pdp_vars[which(pdp_vars$Variable == "Field_duration"), "xmax_Field_duration_Bihar"] <- 200
pdp_vars[which(pdp_vars$Variable == "Field_duration"), "xmin_Field_duration_Nepal"] <- 59
pdp_vars[which(pdp_vars$Variable == "Field_duration"), "xmax_Field_duration_Nepal"] <- 200
pdp_vars[which(pdp_vars$Variable == "Field_duration"), "xmin_Field_duration_Odisha"] <- 59
pdp_vars[which(pdp_vars$Variable == "Field_duration"), "xmax_Field_duration_Odisha"] <- 200
pdp_vars[which(pdp_vars$Variable == "Field_duration"), "xmin_Field_duration_Punjab_Haryana"] <- 59
pdp_vars[which(pdp_vars$Variable == "Field_duration"), "xmax_Field_duration_Punjab_Haryana"] <- 200

## monsoon_onset
pdp_vars[which(pdp_vars$Variable == "monsoon_onset"), "Variable_figurename"] <- "Monsoon onset date (days)" 

pdp_vars[which(pdp_vars$Variable == "monsoon_onset"), "xmin_monsoon_onset_AP"] <- 74
pdp_vars[which(pdp_vars$Variable == "monsoon_onset"), "xmax_monsoon_onset_AP"] <- 225
pdp_vars[which(pdp_vars$Variable == "monsoon_onset"), "xmin_monsoon_onset_Bangladesh"] <- 74
pdp_vars[which(pdp_vars$Variable == "monsoon_onset"), "xmax_monsoon_onset_Bangladesh"] <- 225
pdp_vars[which(pdp_vars$Variable == "monsoon_onset"), "xmin_monsoon_onset_Bihar"] <- 74
pdp_vars[which(pdp_vars$Variable == "monsoon_onset"), "xmax_monsoon_onset_Bihar"] <- 225
pdp_vars[which(pdp_vars$Variable == "monsoon_onset"), "xmin_monsoon_onset_Nepal"] <- 74
pdp_vars[which(pdp_vars$Variable == "monsoon_onset"), "xmax_monsoon_onset_Nepal"] <- 225
pdp_vars[which(pdp_vars$Variable == "monsoon_onset"), "xmin_monsoon_onset_Odisha"] <- 74
pdp_vars[which(pdp_vars$Variable == "monsoon_onset"), "xmax_monsoon_onset_Odisha"] <- 225
pdp_vars[which(pdp_vars$Variable == "monsoon_onset"), "xmin_monsoon_onset_Punjab_Haryana"] <- 74
pdp_vars[which(pdp_vars$Variable == "monsoon_onset"), "xmax_monsoon_onset_Punjab_Haryana"] <- 225

# Making PDP for each predictor in each region
for(j in 1:5){
pred_name <- pdp_vars[j,"Variable"]
  
for(i in 1:nrow(regs)){

region <- regs[i,"Region"]
if (pred_dashboard_6[which(pred_dashboard_6$potpreds == pred_name), region] != "Included") next

predictor_names <- pred_dashboard_6[which(pred_dashboard_6[,region] == "Included"), "potpreds"]

relevant_data <- nib8[which(nib8$Region == region &
                             nib8$N_kg_ha >= 50 & nib8$N_kg_ha <= 200),
                       c(predictor_names,"above_or_below_spline")]

plot <- autoplot(get(paste0("shap_","CTclass","_",region,"_50to200")), 
         type = "dependence",
         rug = TRUE,
         feature = pred_name, 
         X = relevant_data,
         smooth = T,
         smooth_color = "black"
         , color_by = "above_or_below_spline", # this colours points by their actual NUE being above or below
         color = "grey" # This overrides the above
         ) +
        scale_fill_manual(values = c("grey")) +
        scale_x_continuous(limits = c(
           pdp_vars[which(pdp_vars$Variable == pred_name), paste0("xmin_",pred_name,"_",region)],
           pdp_vars[which(pdp_vars$Variable == pred_name), paste0("xmax_",pred_name,"_",region)]
          ), expand = c(0, 0)) + # The expand c(0,0) removes the space between the xlim and the plot boundary
        scale_y_continuous(limits = c(-0.2,0.2), expand = c(0, 0)) +

         geom_rug(color = "black", sides = "b", position = "jitter", alpha = 0.1) +
         ggtitle(regs[i,"Region_figurename3"]) +
         labs(y= "", x = "") + 
         theme(axis.text = element_text(size = 11)) +
         annotate("rect", ymin = 0, ymax = 0.2,
                  xmin = pdp_vars[which(pdp_vars$Variable == pred_name), paste0("xmin_",pred_name,"_",region)], 
                  xmax = pdp_vars[which(pdp_vars$Variable == pred_name), paste0("xmax_",pred_name,"_",region)],
                  fill = "chartreuse4", alpha = 0.1) +
         annotate("rect", ymin = -0.2, ymax = 0,
                  xmin = pdp_vars[which(pdp_vars$Variable == pred_name), paste0("xmin_",pred_name,"_",region)], 
                  xmax = pdp_vars[which(pdp_vars$Variable == pred_name), paste0("xmax_",pred_name,"_",region)],
                  fill = "red", alpha = 0.1)

print(plot)

assign(paste0("depPLOT_", region, "_", pred_name), plot)

print(paste0("completed for ", pred_name, " in ", region))

}

depPLOT_Bangladesh_IRRINU <- blank_plot <- ggplot() +
  theme_void() +
  geom_text(aes(0,0,label=paste0("Bangladesh's floodplains", " NA"))) +
  xlab(NULL)
depPLOT_Punjab_Haryana_total_precip <- blank_plot <- ggplot() +
  theme_void() +
  geom_text(aes(0,0,label=paste0("Punjab & Haryana", " NA"))) +
  xlab(NULL)
depPLOT_Bangladesh_Field_duration <- blank_plot <- ggplot() +
  theme_void() +
  geom_text(aes(0,0,label=paste0("Bangladesh's floodplains", " NA"))) +
  xlab(NULL)

gridy <- grid.arrange(get(paste0("depPLOT_", "AP", "_", pred_name)),
             get(paste0("depPLOT_", "Bihar", "_", pred_name)),
             get(paste0("depPLOT_", "Odisha", "_", pred_name)),
             get(paste0("depPLOT_", "Punjab_Haryana", "_", pred_name)),
             get(paste0("depPLOT_", "Bangladesh", "_", pred_name)),
             get(paste0("depPLOT_", "Nepal", "_", pred_name)),
             ncol=3,
             left = textGrob("Influence on NUE (Shapley value)", # \u0394 is the triangle delta symbol
                             vjust = 1.5, # textGrob enables vjust, which makes closer to plot
                             rot = 90), # rotates 90 degrees
             bottom = textGrob(pdp_vars[which(pdp_vars$Variable == pred_name), "Variable_figurename"],
                               vjust = -1)
             )
assign(paste0("gridy_", pred_name), gridy)
}

# Save Figure 4
setwd('[insert working directory]')
ggsave(filename = "Figure4a.png", plot = gridy_IRRINU, width = 10, height = 6, units = "in", dpi = 700)
ggsave(filename = "Figure4b.png", plot = gridy_TDATE_rel, width = 10, height = 6, units = "in", dpi = 700)


```

4.13) Checking robustness of Figure 3 results across seasons: fitting random forest models

```{r}

regy <- as.data.frame(c("Bihar17", "Bihar18","Bangladesh19","Bangladesh20"))
colnames(regy)[1] <- "Season"
regy$Region <- c("Bihar","Bihar","Bangladesh","Bangladesh")
regy$Year <- c(2017,2018,2019,2020)

require('ranger')

## Modeling each region individually
for(i in 1:nrow(regy)){

response_name <- "above_or_below_spline"
predictor_names <- pred_dashboard_6[which(pred_dashboard_6[,regy[i,"Region"]] == "Included"), "potpreds"]
rf_formula <- as.formula(paste0(response_name, " ~ ", paste(predictor_names, collapse = " + ")))
working_data <- nib8[which(nib8$Region == regy[i,"Region"] &
                             nib8$N_kg_ha >= 50 & nib8$N_kg_ha <= 200 &
                             nib8$year == regy[i,"Year"]
                           ),]

rf_model <- ranger(formula = rf_formula, data = working_data,importance = "permutation"
                   , probability = T
)
# print(paste("Below is model output for: ", regs[i,"Region"], "_", Nbins[j,"Nbins"], sep = ""))
summary(model_fit <- predict(rf_model, data = working_data)$predictions)
assign(paste0("RF_CTclass_PFPvsN_",regy[i,"Season"], "_", "50to200"), rf_model)
}

```

4.14) Checking robustness of Figure 3 results across seasons: estimating Shapley values

```{r}
set.seed(42)
pfun <- function(object, newdata) predict(object, data = newdata)$predictions[,"Above"]

varImportance_start <- Sys.time()

# Each region

for(i in 1:nrow(regy)){

region <- regy[i,"Region"]

## Identify predictor data
predictor_names <- pred_dashboard_6[which(pred_dashboard_6[,region] == "Included"), "potpreds"]
predictor_data <- nib8[which(nib8$Region == region &
                             nib8$N_kg_ha >= 50 & nib8$N_kg_ha <= 200 &
                             nib8$year == regy[i,"Year"]
                             ), predictor_names]

## Identify model
model_name <- paste0("RF_CTclass_PFPvsN_",regy[i,"Season"], "_", "50to200")

# Calculate local shap (i.e. average predictor importance for EACH row)
shap <- fastshap::explain(get(model_name),
                          X = predictor_data,
                          pred_wrapper = pfun,
                          adjust = T, # This asks SHAP to say how much each predictor pushed prediction away from average prediction
                          nsim = 10)

# Calculate global shap (i.e. average predictor importance for ALL rows)
shap_imp <- data.frame(
  Variable = names(shap),
  Importance = apply(shap, MARGIN = 2, FUN = function(x) mean(abs(x)))
)


    
## Plug values into dashboard

for(y in 1:nrow(pred_comparison_PFPvsN)){
name_of_predictor <- pred_comparison_PFPvsN[y,"potpreds"]
if(pred_comparison_PFPvsN[y,region] != "Included") next
pred_comparison_PFPvsN[y, paste("Importance_",regy[i,"Season"],"_","50to200", sep="")] <- round((shap_imp[which(shap_imp$Variable == name_of_predictor),"Importance"]),4)
}

## Create shap importance plot
print(ggplot(shap_imp, aes(reorder(Variable, Importance), Importance)) +
  geom_col() +
  coord_flip() +
  xlab("") +
  # xlim(c(0,0.08)) +
  ylab(paste0("Mean shap value in ",region)))

## Store variable importance results and plot
assign(paste("shap_imp_","CTclass","_",regy[i,"Season"],"_","50to200", sep = ""),shap_imp)
assign(paste("shap_","CTclass","_",regy[i,"Season"],"_","50to200", sep = ""),shap)
}


# Work out computational time
varImportance_end <- Sys.time()
print(round(varImportance_end - varImportance_start),0)
```

4.15) Checking robustness of Figure 3 results across seasons: visualising Shapley values (Figure S5 in Supplementary Information 7)

```{r}

library(formattable)

# Prep data

## Get columns of interest
simples2 <- pred_comparison_PFPvsN[,c("potpreds",
                                     "Importance_mean_50to200",
                                     "Importance_Bihar17_50to200",
                                     "Importance_Bihar18_50to200",
                                     "Importance_Bangladesh19_50to200",
                                     "Importance_Bangladesh20_50to200"
                                  ),]




## Order rows from highest median or median  importance to lowest
simples2 <- simples2[order(simples2$Importance_mean_50to200, decreasing = T),]

## Cut rows with all NAs
simples2 <- simples2[is.na(simples2$Importance_mean_50to200) == F,]

## Convert to percentage
for(i in 2:ncol(simples2)){
for(w in 1:nrow(simples2)){
simples2[w,i] <- as.numeric(simples2[w,i]) * 100
}}

## Make NA invisble
fnc = function(var, decimal.places) {
  var = sprintf(paste0("%1.",decimal.places,"f"), var)
  var[var=="NA"] = ""
  var
}
vars <- c(
                                     "Importance_mean_50to200",
                                     "Importance_Bihar17_50to200",
                                     "Importance_Bihar18_50to200",
                                     "Importance_Bangladesh19_50to200",
                                     "Importance_Bangladesh20_50to200"
                         )
simples2[,vars] <- mapply(fnc,simples2[,vars],2:3)

## Round the numbers
simples2$Importance_mean_50to200 <- round(as.numeric(simples2$Importance_mean_50to200), 2)
simples2$Importance_Bihar17_50to200 <- round(as.numeric(simples2$Importance_Bihar17_50to200), 2)
simples2$Importance_Bihar18_50to200 <- round(as.numeric(simples2$Importance_Bihar18_50to200), 2)
simples2$Importance_Bangladesh19_50to200 <- round(as.numeric(simples2$Importance_Bangladesh19_50to200), 2)
simples2$Importance_Bangladesh20_50to200 <- round(as.numeric(simples2$Importance_Bangladesh20_50to200), 2)

# Categorize predictors
simples2$Category <- "Unallocated"
simples2[which(simples2$potpreds == "total_precip"),"Category"] <- "Rainfall" 
simples2[which(simples2$potpreds == "monsoon_onset"),"Category"] <- "Rainfall"
simples2[which(simples2$potpreds == "SPRODMR"),"Category"] <- "Socio-economic"
simples2[which(simples2$potpreds == "Field_duration"),"Category"] <- "Crop timing"
simples2[which(simples2$potpreds == "IRRINU"),"Category"] <- "Irrigation"
simples2[which(simples2$potpreds == "TDATE_rel"),"Category"] <- "Crop timing"
simples2[which(simples2$potpreds == "monsoon_retreat"),"Category"] <- "Rainfall"
simples2[which(simples2$potpreds == "avg_dspell_length"),"Category"] <- "Rainfall"
simples2[which(simples2$potpreds == "DCLASS"),"Category"] <- "Soil and landscape"
simples2[which(simples2$potpreds == "DISEV"),"Category"] <- "Other management"
simples2[which(simples2$potpreds == "DISMR"),"Category"] <- "Socio-economic"
simples2[which(simples2$potpreds == "DRSEV"),"Category"] <- "Rainfall"
simples2[which(simples2$potpreds == "EDU"),"Category"] <- "Socio-economic" 
simples2[which(simples2$potpreds == "EST_line"),"Category"] <- "Other management" # Unclear
simples2[which(simples2$potpreds == "FLSEV"),"Category"] <- "Rainfall" 
simples2[which(simples2$potpreds == "GEN"),"Category"] <- "Socio-economic"
simples2[which(simples2$potpreds == "GYP_ha"),"Category"] <- "Nutrient management"
simples2[which(simples2$potpreds == "HHMEM"),"Category"] <- "Socio-economic" 
simples2[which(simples2$potpreds == "HIFAG"),"Category"] <- "Socio-economic"
simples2[which(simples2$potpreds == "K2O_ha"),"Category"] <- "Nutrient management"
simples2[which(simples2$potpreds == "LOD"),"Category"] <- "Other management" # Unclear
simples2[which(simples2$potpreds == "MaxUnsplit_Nperc_within_1_days"),"Category"] <- "Nutrient management"
simples2[which(simples2$potpreds == "Nperc_7to30_DAT"),"Category"] <- "Nutrient management"
simples2[which(simples2$potpreds == "Nperc_pre_7_DAT"),"Category"] <- "Nutrient management"
simples2[which(simples2$potpreds == "Nursery_duration"),"Category"] <- "Crop timing"
simples2[which(simples2$potpreds == "Organic_ha"),"Category"] <- "Nutrient management"
simples2[which(simples2$potpreds == "P2O5_ha"),"Category"] <- "Nutrient management"
simples2[which(simples2$potpreds == "PCRR"),"Category"] <- "Nutrient management"
simples2[which(simples2$potpreds == "SOCCAT"),"Category"] <- "Socio-economic"
simples2[which(simples2$potpreds == "SoilGrids_bdod"),"Category"] <- "Soil and landscape"
simples2[which(simples2$potpreds == "SoilGrids_phh2o"),"Category"] <- "Soil and landscape"
simples2[which(simples2$potpreds == "SoilGrids_sand"),"Category"] <- "Soil and landscape"
simples2[which(simples2$potpreds == "SoilGrids_soc"),"Category"] <- "Soil and landscape"
simples2[which(simples2$potpreds == "SOILTEX"),"Category"] <- "Soil and landscape"
simples2[which(simples2$potpreds == "SOPER"),"Category"] <- "Soil and landscape"
simples2[which(simples2$potpreds == "SRATEHA"),"Category"] <- "Other management"
simples2[which(simples2$potpreds == "VARTYPE"),"Category"] <- "Other management"
simples2[which(simples2$potpreds == "WSEV"),"Category"] <- "Other management"
simples2[which(simples2$potpreds == "Zn_ha"),"Category"] <- "Nutrient management"

# Rename potpredss
simples2[which(simples2$potpreds == "total_precip"),"potpreds"] <- "Total rainfall" 
simples2[which(simples2$potpreds == "monsoon_onset"),"potpreds"] <- "Monsoon onset date"
simples2[which(simples2$potpreds == "SPRODMR"),"potpreds"] <- "Market engagement"
simples2[which(simples2$potpreds == "Field_duration"),"potpreds"] <- "Field duration"
simples2[which(simples2$potpreds == "IRRINU"),"potpreds"] <- "Number of irrigations"
simples2[which(simples2$potpreds == "TDATE_rel"),"potpreds"] <- "Transplanting date"
simples2[which(simples2$potpreds == "monsoon_retreat"),"potpreds"] <- "Monsoon retreat date"
simples2[which(simples2$potpreds == "avg_dspell_length"),"potpreds"] <- "Average dry spell length"
simples2[which(simples2$potpreds == "DCLASS"),"potpreds"] <- "Landscape position"
simples2[which(simples2$potpreds == "DISEV"),"potpreds"] <- "Disease severity"
simples2[which(simples2$potpreds == "DISMR"),"potpreds"] <- "Market distance"
simples2[which(simples2$potpreds == "DRSEV"),"potpreds"] <- "Drought severity"
simples2[which(simples2$potpreds == "EDU"),"potpreds"] <- "Farmer education" 
simples2[which(simples2$potpreds == "EST_line"),"potpreds"] <- "Transplanting method" # Unclear
simples2[which(simples2$potpreds == "FLSEV"),"potpreds"] <- "Flood severity" 
simples2[which(simples2$potpreds == "GEN"),"potpreds"] <- "Farmer gender"
simples2[which(simples2$potpreds == "GYP_ha"),"potpreds"] <- "Gypsum fertilizer"
simples2[which(simples2$potpreds == "HHMEM"),"potpreds"] <- "Household members" 
simples2[which(simples2$potpreds == "HIFAG"),"potpreds"] <- "Farm income dependence"
simples2[which(simples2$potpreds == "K2O_ha"),"potpreds"] <- "Potassium fertilizer"
simples2[which(simples2$potpreds == "LOD"),"potpreds"] <- "Lodging" # Unclear
simples2[which(simples2$potpreds == "MaxUnsplit_Nperc_within_1_days"),"potpreds"] <- "Nitrogen splitting"
simples2[which(simples2$potpreds == "Nperc_7to30_DAT"),"potpreds"] <- "Nitrogen applied at tillering"
simples2[which(simples2$potpreds == "Nperc_pre_7_DAT"),"potpreds"] <- "Nitrogen applied at planting"
simples2[which(simples2$potpreds == "Nursery_duration"),"potpreds"] <- "Nursery duration"
simples2[which(simples2$potpreds == "Organic_ha"),"potpreds"] <- "Organic fertilizer"
simples2[which(simples2$potpreds == "P2O5_ha"),"potpreds"] <- "Phosphorous fertilizer"
simples2[which(simples2$potpreds == "PCRR"),"potpreds"] <- "Previous crop residue"
simples2[which(simples2$potpreds == "SOCCAT"),"potpreds"] <- "Farmer social category"
simples2[which(simples2$potpreds == "SoilGrids_bdod"),"potpreds"] <- "Soil density"
simples2[which(simples2$potpreds == "SoilGrids_phh2o"),"potpreds"] <- "Soil pH"
simples2[which(simples2$potpreds == "SoilGrids_sand"),"potpreds"] <- "Soil sandiness"
simples2[which(simples2$potpreds == "SoilGrids_soc"),"potpreds"] <- "Soil carbon"
simples2[which(simples2$potpreds == "SOILTEX"),"potpreds"] <- "Farmer-judged soil texture"
simples2[which(simples2$potpreds == "SOPER"),"potpreds"] <- "Farmer soil perception"
simples2[which(simples2$potpreds == "SRATEHA"),"potpreds"] <- "Seed rate"
simples2[which(simples2$potpreds == "VARTYPE"),"potpreds"] <- "Variety type"
simples2[which(simples2$potpreds == "WSEV"),"potpreds"] <- "Weed severity"
simples2[which(simples2$potpreds == "Zn_ha"),"potpreds"] <- "Zinc fertilizer"


# Make some nice table formatting

   

Test4 <- formatter("span",
                  style = x ~ style(display = "inline-block", color = "black","border-radius" = "4px",
                                    "padding-right" = "4px", width = "75px",
                                    "background-color" = ifelse(as.numeric(x) <= .2, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[5],
                                                         ifelse(as.numeric(x) <= .4, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[10],
                                                         ifelse(as.numeric(x) <= .6, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[15],
                                                         ifelse(as.numeric(x) <= .8, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[20],
                                                         ifelse(as.numeric(x) <= 1, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[25],
                                                         ifelse(as.numeric(x) <= 1.2, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[30],
                                                         ifelse(as.numeric(x) <= 1.4, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[35],
                                                         ifelse(as.numeric(x) <= 1.6, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[40],
                                                         ifelse(as.numeric(x) <= 1.8, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[45],
                                                         ifelse(as.numeric(x) <= 2, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[50],
                                                         ifelse(as.numeric(x) <= 2.2, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[55],
                                                         ifelse(as.numeric(x) <= 2.4, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[60],
                                                         ifelse(as.numeric(x) <= 2.6, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[65],
                                                         ifelse(as.numeric(x) <= 2.8, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[70],
                                                         ifelse(as.numeric(x) <= 3, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[75],
                                                         ifelse(as.numeric(x) <= 3.2, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[80],
                                                         ifelse(as.numeric(x) <= 3.4, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[85],
                                                         ifelse(as.numeric(x) <= 3.6, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[90],
                                                         ifelse(as.numeric(x) <= 3.8, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[95],
                                                         ifelse(as.numeric(x) <= 4, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[100],
                                                         ifelse(as.numeric(x) <= 4.2, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[105],
                                                         ifelse(as.numeric(x) <= 4.4, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[110],
                                                         ifelse(as.numeric(x) <= 4.6, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[115],
                                                         ifelse(as.numeric(x) <= 4.8, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[120],
                                                         ifelse(as.numeric(x) <= 5, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[125],
                                                         ifelse(as.numeric(x) <= 5.2, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[130],
                                                         ifelse(as.numeric(x) <= 5.4, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[135],
                                                         ifelse(as.numeric(x) <= 5.6, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[140],
                                                         ifelse(as.numeric(x) <= 5.8, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[145],
                                                         ifelse(as.numeric(x) <= 6, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[150],
                                                         ifelse(as.numeric(x) <= 6.2, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[155],
                                                         ifelse(as.numeric(x) <= 6.4, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[160],
                                                         ifelse(as.numeric(x) <= 6.6, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[165],
                                                         ifelse(as.numeric(x) <= 6.8, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[170],
                                                         ifelse(as.numeric(x) <= 7, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[175],
                                                         "green"))))))))))))))))))))))))))))))))))))) 

Test5 <- formatter("span",
                  style = x ~ style(display = "inline-block",
                                    font.weight = "bold", # here the change
                                    color = "black","border-radius" = "4px",
                                    "padding-right" = "4px", width = "75px",
                                    "background-color" = ifelse(as.numeric(x) <= .2, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[5],
                                                         ifelse(as.numeric(x) <= .4, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[10],
                                                         ifelse(as.numeric(x) <= .6, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[15],
                                                         ifelse(as.numeric(x) <= .8, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[20],
                                                         ifelse(as.numeric(x) <= 1, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[25],
                                                         ifelse(as.numeric(x) <= 1.2, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[30],
                                                         ifelse(as.numeric(x) <= 1.4, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[35],
                                                         ifelse(as.numeric(x) <= 1.6, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[40],
                                                         ifelse(as.numeric(x) <= 1.8, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[45],
                                                         ifelse(as.numeric(x) <= 2, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[50],
                                                         ifelse(as.numeric(x) <= 2.2, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[55],
                                                         ifelse(as.numeric(x) <= 2.4, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[60],
                                                         ifelse(as.numeric(x) <= 2.6, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[65],
                                                         ifelse(as.numeric(x) <= 2.8, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[70],
                                                         ifelse(as.numeric(x) <= 3, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[75],
                                                         ifelse(as.numeric(x) <= 3.2, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[80],
                                                         ifelse(as.numeric(x) <= 3.4, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[85],
                                                         ifelse(as.numeric(x) <= 3.6, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[90],
                                                         ifelse(as.numeric(x) <= 3.8, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[95],
                                                         ifelse(as.numeric(x) <= 4, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[100],
                                                         ifelse(as.numeric(x) <= 4.2, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[105],
                                                         ifelse(as.numeric(x) <= 4.4, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[110],
                                                         ifelse(as.numeric(x) <= 4.6, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[115],
                                                         ifelse(as.numeric(x) <= 4.8, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[120],
                                                         ifelse(as.numeric(x) <= 5, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[125],
                                                         ifelse(as.numeric(x) <= 5.2, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[130],
                                                         ifelse(as.numeric(x) <= 5.4, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[135],
                                                         ifelse(as.numeric(x) <= 5.6, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[140],
                                                         ifelse(as.numeric(x) <= 5.8, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[145],
                                                         ifelse(as.numeric(x) <= 6, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[150],
                                                         ifelse(as.numeric(x) <= 6.2, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[155],
                                                         ifelse(as.numeric(x) <= 6.4, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[160],
                                                         ifelse(as.numeric(x) <= 6.6, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[165],
                                                         ifelse(as.numeric(x) <= 6.8, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[170],
                                                         ifelse(as.numeric(x) <= 7, colorRampPalette(c("lemonchiffon", "forestgreen"))(175)[175],
                                                         "green")))))))))))))))))))))))))))))))))))))


Predictor_column <- formatter("span",
                            style = x ~ style(display = "inline-block", color = "black","border-radius" = "4px",                  
                            "padding-right" = "4px", width = "200px"))


Category_colour <- formatter("span",
                            style = x ~ style(display = "inline-block", font.style = "italic", color = "black","border-radius" = "4px",                  
                            "padding-right" = "4px", width = "150px",
                            "background-color" = ifelse(x == "Other management", "darkgoldenrod",
                                                        ifelse(x == "Nutrient management", "mediumseagreen",
                                                        ifelse(x == "Soil and landscape", "chocolate",
                                                        ifelse(x == "Socio-economic", "lightgrey",
                                                        ifelse(x == "Rainfall", "cornflowerblue",
                                                        ifelse(x == "Crop timing", "indianred",
                                                        ifelse(x == "Irrigation", "skyblue",
                                                               "grey"
                                                        )))))))))


simples2 <- simples2[,c(1,7,2:6)]

## Make table
FigureS5 <- formattable(simples2,
            row.names = F,
            col.names = c(
              "Predictor",
              "Category",
              "Overall mean",
              "Bihar 2017",
              "Bihar 2018",
              "Bangladesh 2019",
              "Bangladesh 2020"
              ),
            align = "c",
            list(
              potpreds = Predictor_column,
              Category = Category_colour,
              Importance_mean_50to200 = Test5,
              Importance_Bihar17_50to200 = Test4,
              Importance_Bihar18_50to200 = Test4,
              Importance_Bangladesh19_50to200 = Test4,
              Importance_Bangladesh20_50to200 = Test4
            ))

# save table
setwd('[insert working directory]')

export_formattable <- function(f, file, width = 1000, height = 1500, 
                               background = "white", delay = 0.2, zoom = 5)
    {
      w <- as.htmlwidget(f, width = width, height = height)
      path <- html_print(w, background = background, viewer = NULL)
      url <- paste0("file:///", gsub("\\\\", "/", normalizePath(path)))
      webshot(url,
              file = file,
              selector = ".formattable_widget",
              delay = delay,
              zoom = zoom)
    }

export_formattable(FigureS5,"FigureS5.png")


```

4.16) Checking robustness of Figure 3 results across models: identifying optimal paratmeters for random forest models that predict relative NUE as a continuous variable, instead of a cateogircal variable

```{r}
library('caret')
library('dplyr')


# Each region individually

for(i in 1:nrow(regs)){
for(j in 1:nrow(Nbins)){

if (i == 5 & j == 4) {next} # Skip 150-200 kg/ha in Odisha (low sample size)

response_name <- "PFPvsN_deviation_region"
predictor_names <- pred_dashboard_6[which(pred_dashboard_6[,regs[i,"Region"]] == "Included"), "potpreds"]
rf_formula <- as.formula(paste0(response_name, " ~ ", paste(predictor_names, collapse = " + ")))

working_data <- nib8[which(nib8$Region == regs[i,"Region"] &
                             nib8$N_kg_ha >= Nbins[j,"Nmin"] & nib8$N_kg_ha <= Nbins[j,"Nmax"]),c(response_name,predictor_names)]

(mtry.default <- floor(sqrt(dim(working_data)[2])))
getModelInfo("ranger")$ranger$parameters
system.time(
  ranger.tune <- train(
                    rf_formula,
                    data = working_data,
                    method="ranger",
                    tuneGrid = expand.grid(.mtry = (mtry.default-1):(mtry.default+3),
                    .splitrule = "variance",
                    .min.node.size = 2:6),
                    trControl = trainControl(method = 'cv')))
print(plot.train(ranger.tune, metric="Rsquared", main = paste0(regs[i,"Region"],"_",Nbins[j,"Nbins"])))
print(plot.train(ranger.tune, metric="RMSE", main = paste0(regs[i,"Region"],"_",Nbins[j,"Nbins"])))
}}


```

4.17) Checking robustness of Figure 3 results across models: defining optimal paratmeters for random forest models that predict relative NUE as a continuous variable, instead of a cateogircal variable

```{r}
# Make tables collating mtry (number of variables to possibly split at in each node) and min.node.size for each model
mtry_table_NUEvsN_regression <- data.frame(matrix(ncol = nrow(Nbins), nrow = nrow(regs) + 2))
colnames(mtry_table_NUEvsN_regression) <- Nbins[,"Nbins"]
rownames(mtry_table_NUEvsN_regression) <- c(regs[,"Region"], "Aggregated_aggSpline", "Aggregated_regSpline")

min_node_size_table_NUEvsN_regression <- data.frame(matrix(ncol = nrow(Nbins), nrow = nrow(regs) + 2))
colnames(min_node_size_table_NUEvsN_regression) <- Nbins[,"Nbins"]
rownames(min_node_size_table_NUEvsN_regression) <- c(regs[,"Region"], "Aggregated_aggSpline", "Aggregated_regSpline")

## AP
mtry_table_NUEvsN_regression["AP","50to200"] <- 6
min_node_size_table_NUEvsN_regression["AP","50to200"] <- 6
mtry_table_NUEvsN_regression["AP","50to100"] <- 4
min_node_size_table_NUEvsN_regression["AP","50to100"] <- 5
mtry_table_NUEvsN_regression["AP","100to150"] <- 6
min_node_size_table_NUEvsN_regression["AP","100to150"] <- 3
mtry_table_NUEvsN_regression["AP","150to200"] <- 8
min_node_size_table_NUEvsN_regression["AP","150to200"] <- 2

## Bangladesh
mtry_table_NUEvsN_regression["Bangladesh","50to200"] <- 5
min_node_size_table_NUEvsN_regression["Bangladesh","50to200"] <- 2
mtry_table_NUEvsN_regression["Bangladesh","50to100"] <- 7
min_node_size_table_NUEvsN_regression["Bangladesh","50to100"] <- 2
mtry_table_NUEvsN_regression["Bangladesh","100to150"] <- 3
min_node_size_table_NUEvsN_regression["Bangladesh","100to150"] <- 2
mtry_table_NUEvsN_regression["Bangladesh","150to200"] <- 3
min_node_size_table_NUEvsN_regression["Bangladesh","150to200"] <- 2

## Bihar
mtry_table_NUEvsN_regression["Bihar","50to200"] <- 8
min_node_size_table_NUEvsN_regression["Bihar","50to200"] <- 2
mtry_table_NUEvsN_regression["Bihar","50to100"] <- 9
min_node_size_table_NUEvsN_regression["Bihar","50to100"] <- 6
mtry_table_NUEvsN_regression["Bihar","100to150"] <- 8
min_node_size_table_NUEvsN_regression["Bihar","100to150"] <- 2
mtry_table_NUEvsN_regression["Bihar","150to200"] <- 7
min_node_size_table_NUEvsN_regression["Bihar","150to200"] <- 3

## Nepal
mtry_table_NUEvsN_regression["Nepal","50to200"] <- 6
min_node_size_table_NUEvsN_regression["Nepal","50to200"] <- 3
mtry_table_NUEvsN_regression["Nepal","50to100"] <- 4
min_node_size_table_NUEvsN_regression["Nepal","50to100"] <- 3
mtry_table_NUEvsN_regression["Nepal","100to150"] <- 8
min_node_size_table_NUEvsN_regression["Nepal","100to150"] <- 5
mtry_table_NUEvsN_regression["Nepal","150to200"] <- 8
min_node_size_table_NUEvsN_regression["Nepal","150to200"] <- 3

## Odisha
mtry_table_NUEvsN_regression["Odisha","50to200"] <- 5
min_node_size_table_NUEvsN_regression["Odisha","50to200"] <- 5
mtry_table_NUEvsN_regression["Odisha","50to100"] <- 6
min_node_size_table_NUEvsN_regression["Odisha","50to100"] <- 3
mtry_table_NUEvsN_regression["Odisha","100to150"] <- 4
min_node_size_table_NUEvsN_regression["Odisha","100to150"] <- 4
# mtry_table_NUEvsN_regression["Odisha","150to200"] <- 14
# min_node_size_table_NUEvsN_regression["Odisha","150to200"] <- 4

## Punjab_Haryana
mtry_table_NUEvsN_regression["Punjab_Haryana","50to200"] <- 6
min_node_size_table_NUEvsN_regression["Punjab_Haryana","50to200"] <- 2
mtry_table_NUEvsN_regression["Punjab_Haryana","50to100"] <- 6
min_node_size_table_NUEvsN_regression["Punjab_Haryana","50to100"] <- 3
mtry_table_NUEvsN_regression["Punjab_Haryana","100to150"] <- 6
min_node_size_table_NUEvsN_regression["Punjab_Haryana","100to150"] <- 6
mtry_table_NUEvsN_regression["Punjab_Haryana","150to200"] <- 6
min_node_size_table_NUEvsN_regression["Punjab_Haryana","150to200"] <- 4


```

4.18) Checking robustness of Figure 3 results across models: fitting random forest models that predict relative NUE as a continuous variable, instead of a cateogircal variable

```{r}

require('ranger')

## Modeling each region individually
for(i in 1:nrow(regs)){
for(j in 1:nrow(Nbins)){

if (i == 5 & j == 4) {next} # Skip 150-200 kg/ha in Odisha (low sample size)

response_name <- "PFPvsN_deviation_region"
predictor_names <- pred_dashboard_6[which(pred_dashboard_6[,regs[i,"Region"]] == "Included"), "potpreds"]
rf_formula <- as.formula(paste0(response_name, " ~ ", paste(predictor_names, collapse = " + ")))
working_data <- nib8[which(nib8$Region == regs[i,"Region"] &
                             nib8$N_kg_ha >= Nbins[j,"Nmin"] & nib8$N_kg_ha <= Nbins[j,"Nmax"]),]

rf_model <- ranger(formula = rf_formula, data = working_data,importance = "permutation"
    , mtry = mtry_table_NUEvsN_regression[regs[i,"Region"],Nbins[j,"Nbins"]]
    , min.node.size = min_node_size_table_NUEvsN_regression[regs[i,"Region"],Nbins[j,"Nbins"]]
)
# print(paste("Below is model output for: ", regs[i,"Region"], "_", Nbins[j,"Nbins"], sep = ""))
summary(model_fit <- predict(rf_model, data = working_data)$predictions)
# plot(working_data[,response_name] ~ rf_model$predictions, pch = 20, asp = 1, cex = 0.6,
#      xlab = "Predicted", ylab = "Actual",
#      main = paste("PFPvsN model fit: ", regs[i,"Region"], "_", Nbins[j,"Nbins"], sep = ""))
# grid(); abline(0,1)
assign(paste0("RF_","PFPvsNreg_",regs[i,"Region"], "_", Nbins[j,"Nbins"]), rf_model)
}}


## Make table collating R2 for each model
Rsquared_PFPvsNreg <- data.frame(matrix(ncol = nrow(Nbins), nrow = nrow(regs) + 2))
colnames(Rsquared_PFPvsNreg) <- Nbins[,"Nbins"]
rownames(Rsquared_PFPvsNreg) <- c(regs[,"Region"], "Aggregated_aggSpline", "Aggregated_regSpline")

for (i in 1:nrow(regs)){
for(j in 1:nrow(Nbins)){

if (i == 5 & j == 4) {next} # Skip 150-200 kg/ha in Odisha (low sample size)

R2 <- get(paste0("RF_","PFPvsNreg_",regs[i,"Region"], "_", Nbins[j,"Nbins"]))$r.squared
Sample_size <- get(paste0("RF_","PFPvsNreg_",regs[i,"Region"], "_", Nbins[j,"Nbins"]))$num.samples
Rsquared_PFPvsNreg[i,j] <- paste0(round(R2,2)
                        # ," (n=", Sample_size, ")"
                        )
}}


# Make nice table
Rsquared_PFPvsNreg_nice <- Rsquared_PFPvsNreg
colnames(Rsquared_PFPvsNreg_nice)[1] <- "RF_50to200"
colnames(Rsquared_PFPvsNreg_nice)[2] <- "RF_50to100"
colnames(Rsquared_PFPvsNreg_nice)[3] <- "RF_100to150"
colnames(Rsquared_PFPvsNreg_nice)[4] <- "RF_150to200"

```

4.19) Checking robustness of Figure 3 results across models: estimating Shapley values for random forest models that predict relative NUE as a continuous variable, instead of a cateogircal variable

```{r}
set.seed(42)
pfun <- function(object, newdata) predict(object, data = newdata)$predictions

varImportance_start <- Sys.time()

pred_dashboard_NUEvsN_regression <- pred_dashboard_6

# Each region

for(i in 1:nrow(regs)){
for(j in 1:nrow(Nbins)){ 

if (i == 5 & j == 4) {next} # Skip 150-200 kg/ha in Odisha (low sample size)
  
region <- regs[i,"Region"]

## Identify predictor data
predictor_names <- pred_dashboard_NUEvsN_regression[which(pred_dashboard_NUEvsN_regression[,region] == "Included"), "potpreds"]
predictor_data <- nib8[which(nib8$Region == region &
                             nib8$N_kg_ha >= Nbins[j,"Nmin"] & nib8$N_kg_ha <= Nbins[j,"Nmax"]), predictor_names]

## Identify model
model_name <- paste0("RF_","PFPvsNreg_",regs[i,"Region"], "_", Nbins[j,"Nbins"])

# Calculate local shap (i.e. average predictor importance for EACH row)
shap <- fastshap::explain(get(model_name),
                          X = predictor_data,
                          pred_wrapper = pfun,
                          adjust = T, # This asks SHAP to say how much each predictor pushed prediction away from average prediction
                          nsim = 10)

# Calculate global shap (i.e. average predictor importance for ALL rows)
shap_imp <- data.frame(
  Variable = names(shap),
  Importance = apply(shap, MARGIN = 2, FUN = function(x) mean(abs(x)))
)

## Plug values into dashboard
for(y in 1:nrow(pred_comparison_NUEvsN_regression)){
name_of_predictor <- pred_comparison_NUEvsN_regression[y,"potpreds"]
if(pred_comparison_NUEvsN_regression[y,region] != "Included") next
pred_comparison_NUEvsN_regression[y, paste("Importance_",region,"_",Nbins[j,"Nbins"], sep="")] <- round((shap_imp[which(shap_imp$Variable == name_of_predictor),"Importance"]),4)
}

## Create shap importance plot
print(ggplot(shap_imp, aes(reorder(Variable, Importance), Importance)) +
  geom_col() +
  coord_flip() +
  xlab("") +
  # xlim(c(0,0.08)) +
  ylab(paste0("Mean shap value in ",region)))

## Store variable importance results and plot
assign(paste("shap_imp_","PFPvsNreg","_",region,"_",Nbins[j,"Nbins"], sep = ""),shap_imp)
assign(paste("shap_","PFPvsNreg","_",region,"_",Nbins[j,"Nbins"], sep = ""),shap)
# assign(paste("var_importance_plot_","CTclass","_",region,"_",Nbins[j,"Nbins"], sep = ""),var_importance_plot)
}}

# Calculate averages across regions

## 50to200
pred_comparison_NUEvsN_regression$Importance_mean_50to200 <- rowMeans(pred_comparison_NUEvsN_regression[,c(
  "Importance_AP_50to200",
  "Importance_Bangladesh_50to200",
  "Importance_Bihar_50to200",
  "Importance_Nepal_50to200",
  "Importance_Odisha_50to200",
  "Importance_Punjab_Haryana_50to200")],
  na.rm = TRUE)

## 50to100
pred_comparison_NUEvsN_regression$Importance_mean_50to100 <- rowMeans(pred_comparison_NUEvsN_regression[,c(
  "Importance_AP_50to100",
  "Importance_Bangladesh_50to100",
  "Importance_Bihar_50to100",
  "Importance_Nepal_50to100",
  "Importance_Odisha_50to100",
  "Importance_Punjab_Haryana_50to100")],
  na.rm = TRUE)

## 100to150
pred_comparison_NUEvsN_regression$Importance_mean_100to150 <- rowMeans(pred_comparison_NUEvsN_regression[,c(
  "Importance_AP_100to150",
  "Importance_Bangladesh_100to150",
  "Importance_Bihar_100to150",
  "Importance_Nepal_100to150",
  "Importance_Odisha_100to150",
  "Importance_Punjab_Haryana_100to150")],
  na.rm = TRUE)

## 150to200
pred_comparison_NUEvsN_regression$Importance_mean_150to200 <- rowMeans(pred_comparison_NUEvsN_regression[,c(
  "Importance_AP_150to200",
  "Importance_Bangladesh_150to200",
  "Importance_Bihar_150to200",
  "Importance_Nepal_150to200",
  # "Importance_Odisha_150to200", # Doesn't exist
  "Importance_Punjab_Haryana_150to200")],
  na.rm = TRUE)

# Work out computational time
varImportance_end <- Sys.time()
print(round(varImportance_end - varImportance_start),0)

```

4.20) Checking robustness of Figure 3 results across models: visualising predictor importance for random forest models that predict relative NUE as a continuous variable, instead of a cateogircal variable (Figure S6 in Supplementary Information 7)

```{r}

library(formattable)

# Prep data

## Get columns of interest
simples3 <- pred_comparison_NUEvsN_regression[,c("potpreds",
                                     "Importance_AP_50to200",
                                     "Importance_Bangladesh_50to200",
                                     "Importance_Bihar_50to200",
                                     "Importance_Nepal_50to200",
                                     "Importance_Odisha_50to200",
                                     "Importance_Punjab_Haryana_50to200",
                                     "Importance_mean_50to200",
                                     "Importance_mean_50to100",
                                     "Importance_mean_100to150",
                                     "Importance_mean_150to200"
                                  ),]

## Put mean at front
simples3 <- simples3[,c(
  "potpreds",
  "Importance_mean_50to200",
  "Importance_AP_50to200",
  "Importance_Bangladesh_50to200",
  "Importance_Bihar_50to200",
  "Importance_Nepal_50to200",
  "Importance_Odisha_50to200",
  "Importance_Punjab_Haryana_50to200",
  "Importance_mean_50to100",
  "Importance_mean_100to150",
  "Importance_mean_150to200"
)]


## Order rows from highest median or median  importance to lowest
simples3 <- simples3[order(simples3$Importance_mean_50to200, decreasing = T),]

## Cut rows with all NAs
simples3 <- simples3[is.na(simples3$Importance_mean_50to200) == F,]

## Make NA invisble
fnc = function(var, decimal.places) {
  var = sprintf(paste0("%1.",decimal.places,"f"), var)
  var[var=="NA"] = ""
  var
}
vars <- c(
  "Importance_mean_50to200",
  "Importance_AP_50to200",
  "Importance_Bangladesh_50to200",
  "Importance_Bihar_50to200",
  "Importance_Nepal_50to200",
  "Importance_Odisha_50to200",
  "Importance_Punjab_Haryana_50to200",
  "Importance_mean_50to100",
  "Importance_mean_100to150",
  "Importance_mean_150to200"
                         )
simples3[,vars] <- mapply(fnc,simples3[,vars],2:3)

## Round the numbers
simples3$Importance_mean_50to200 <- round(as.numeric(simples3$Importance_mean_50to200), 2)
simples3$Importance_AP_50to200 <- round(as.numeric(simples3$Importance_AP_50to200), 2)
simples3$Importance_Bangladesh_50to200 <- round(as.numeric(simples3$Importance_Bangladesh_50to200), 2)
simples3$Importance_Bihar_50to200 <- round(as.numeric(simples3$Importance_Bihar_50to200), 2)
simples3$Importance_Nepal_50to200 <- round(as.numeric(simples3$Importance_Nepal_50to200), 2)
simples3$Importance_Odisha_50to200 <- round(as.numeric(simples3$Importance_Odisha_50to200), 2)
simples3$Importance_Punjab_Haryana_50to200 <- round(as.numeric(simples3$Importance_Punjab_Haryana_50to200), 2)
simples3$Importance_mean_50to100 <- round(as.numeric(simples3$Importance_mean_50to100), 2)
simples3$Importance_mean_100to150 <- round(as.numeric(simples3$Importance_mean_100to150), 2)
simples3$Importance_mean_150to200 <- round(as.numeric(simples3$Importance_mean_150to200), 2)


# Categorize predictors
simples3$Category <- "Unallocated"
simples3[which(simples3$potpreds == "total_precip"),"Category"] <- "Rainfall" 
simples3[which(simples3$potpreds == "monsoon_onset"),"Category"] <- "Rainfall"
simples3[which(simples3$potpreds == "SPRODMR"),"Category"] <- "Socio-economic"
simples3[which(simples3$potpreds == "Field_duration"),"Category"] <- "Crop timing"
simples3[which(simples3$potpreds == "IRRINU"),"Category"] <- "Irrigation"
simples3[which(simples3$potpreds == "TDATE_rel"),"Category"] <- "Crop timing"
simples3[which(simples3$potpreds == "monsoon_retreat"),"Category"] <- "Rainfall"
simples3[which(simples3$potpreds == "avg_dspell_length"),"Category"] <- "Rainfall"
simples3[which(simples3$potpreds == "DCLASS"),"Category"] <- "Soil and landscape"
simples3[which(simples3$potpreds == "DISEV"),"Category"] <- "Other management"
simples3[which(simples3$potpreds == "DISMR"),"Category"] <- "Socio-economic"
simples3[which(simples3$potpreds == "DRSEV"),"Category"] <- "Rainfall"
simples3[which(simples3$potpreds == "EDU"),"Category"] <- "Socio-economic" 
simples3[which(simples3$potpreds == "EST_line"),"Category"] <- "Other management" # Unclear
simples3[which(simples3$potpreds == "FLSEV"),"Category"] <- "Rainfall" 
simples3[which(simples3$potpreds == "GEN"),"Category"] <- "Socio-economic"
simples3[which(simples3$potpreds == "GYP_ha"),"Category"] <- "Nutrient management"
simples3[which(simples3$potpreds == "HHMEM"),"Category"] <- "Socio-economic" 
simples3[which(simples3$potpreds == "HIFAG"),"Category"] <- "Socio-economic"
simples3[which(simples3$potpreds == "K2O_ha"),"Category"] <- "Nutrient management"
simples3[which(simples3$potpreds == "LOD"),"Category"] <- "Other management" # Unclear
simples3[which(simples3$potpreds == "MaxUnsplit_Nperc_within_1_days"),"Category"] <- "Nutrient management"
simples3[which(simples3$potpreds == "Nperc_7to30_DAT"),"Category"] <- "Nutrient management"
simples3[which(simples3$potpreds == "Nperc_pre_7_DAT"),"Category"] <- "Nutrient management"
simples3[which(simples3$potpreds == "Nursery_duration"),"Category"] <- "Crop timing"
simples3[which(simples3$potpreds == "Organic_ha"),"Category"] <- "Nutrient management"
simples3[which(simples3$potpreds == "P2O5_ha"),"Category"] <- "Nutrient management"
simples3[which(simples3$potpreds == "PCRR"),"Category"] <- "Nutrient management"
simples3[which(simples3$potpreds == "SOCCAT"),"Category"] <- "Socio-economic"
simples3[which(simples3$potpreds == "SoilGrids_bdod"),"Category"] <- "Soil and landscape"
simples3[which(simples3$potpreds == "SoilGrids_phh2o"),"Category"] <- "Soil and landscape"
simples3[which(simples3$potpreds == "SoilGrids_sand"),"Category"] <- "Soil and landscape"
simples3[which(simples3$potpreds == "SoilGrids_soc"),"Category"] <- "Soil and landscape"
simples3[which(simples3$potpreds == "SOILTEX"),"Category"] <- "Soil and landscape"
simples3[which(simples3$potpreds == "SOPER"),"Category"] <- "Soil and landscape"
simples3[which(simples3$potpreds == "SRATEHA"),"Category"] <- "Other management"
simples3[which(simples3$potpreds == "VARTYPE"),"Category"] <- "Other management"
simples3[which(simples3$potpreds == "WSEV"),"Category"] <- "Other management"
simples3[which(simples3$potpreds == "Zn_ha"),"Category"] <- "Nutrient management"

# Rename potpredss
simples3[which(simples3$potpreds == "total_precip"),"potpreds"] <- "Total rainfall" 
simples3[which(simples3$potpreds == "monsoon_onset"),"potpreds"] <- "Monsoon onset date"
simples3[which(simples3$potpreds == "SPRODMR"),"potpreds"] <- "Market engagement"
simples3[which(simples3$potpreds == "Field_duration"),"potpreds"] <- "Field duration"
simples3[which(simples3$potpreds == "IRRINU"),"potpreds"] <- "Number of irrigations"
simples3[which(simples3$potpreds == "TDATE_rel"),"potpreds"] <- "Transplanting date"
simples3[which(simples3$potpreds == "monsoon_retreat"),"potpreds"] <- "Monsoon retreat date"
simples3[which(simples3$potpreds == "avg_dspell_length"),"potpreds"] <- "Average dry spell length"
simples3[which(simples3$potpreds == "DCLASS"),"potpreds"] <- "Landscape position"
simples3[which(simples3$potpreds == "DISEV"),"potpreds"] <- "Disease severity"
simples3[which(simples3$potpreds == "DISMR"),"potpreds"] <- "Market distance"
simples3[which(simples3$potpreds == "DRSEV"),"potpreds"] <- "Drought severity"
simples3[which(simples3$potpreds == "EDU"),"potpreds"] <- "Farmer education" 
simples3[which(simples3$potpreds == "EST_line"),"potpreds"] <- "Transplanting method" # Unclear
simples3[which(simples3$potpreds == "FLSEV"),"potpreds"] <- "Flood severity" 
simples3[which(simples3$potpreds == "GEN"),"potpreds"] <- "Farmer gender"
simples3[which(simples3$potpreds == "GYP_ha"),"potpreds"] <- "Gypsum fertilizer"
simples3[which(simples3$potpreds == "HHMEM"),"potpreds"] <- "Household members" 
simples3[which(simples3$potpreds == "HIFAG"),"potpreds"] <- "Farm income dependence"
simples3[which(simples3$potpreds == "K2O_ha"),"potpreds"] <- "Potassium fertilizer"
simples3[which(simples3$potpreds == "LOD"),"potpreds"] <- "Lodging" # Unclear
simples3[which(simples3$potpreds == "MaxUnsplit_Nperc_within_1_days"),"potpreds"] <- "Nitrogen splitting"
simples3[which(simples3$potpreds == "Nperc_7to30_DAT"),"potpreds"] <- "Nitrogen applied at tillering"
simples3[which(simples3$potpreds == "Nperc_pre_7_DAT"),"potpreds"] <- "Nitrogen applied at planting"
simples3[which(simples3$potpreds == "Nursery_duration"),"potpreds"] <- "Nursery duration"
simples3[which(simples3$potpreds == "Organic_ha"),"potpreds"] <- "Organic fertilizer"
simples3[which(simples3$potpreds == "P2O5_ha"),"potpreds"] <- "Phosphorous fertilizer"
simples3[which(simples3$potpreds == "PCRR"),"potpreds"] <- "Previous crop residue"
simples3[which(simples3$potpreds == "SOCCAT"),"potpreds"] <- "Farmer social category"
simples3[which(simples3$potpreds == "SoilGrids_bdod"),"potpreds"] <- "Soil density"
simples3[which(simples3$potpreds == "SoilGrids_phh2o"),"potpreds"] <- "Soil pH"
simples3[which(simples3$potpreds == "SoilGrids_sand"),"potpreds"] <- "Soil sandiness"
simples3[which(simples3$potpreds == "SoilGrids_soc"),"potpreds"] <- "Soil carbon"
simples3[which(simples3$potpreds == "SOILTEX"),"potpreds"] <- "Farmer-judged soil texture"
simples3[which(simples3$potpreds == "SOPER"),"potpreds"] <- "Farmer soil perception"
simples3[which(simples3$potpreds == "SRATEHA"),"potpreds"] <- "Seed rate"
simples3[which(simples3$potpreds == "VARTYPE"),"potpreds"] <- "Variety type"
simples3[which(simples3$potpreds == "WSEV"),"potpreds"] <- "Weed severity"
simples3[which(simples3$potpreds == "Zn_ha"),"potpreds"] <- "Zinc fertilizer"


# Make some nice table formatting

Test6 <- formatter("span",
                  style = x ~ style(display = "inline-block", color = "black","border-radius" = "4px",
                                    "padding-right" = "4px", width = "75px",
                                    "background-color" = ifelse(as.numeric(x) <= .08, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[5],
                                                         ifelse(as.numeric(x) <= .16, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[10],
                                                         ifelse(as.numeric(x) <= .24, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[15],
                                                         ifelse(as.numeric(x) <= .32, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[20],
                                                         ifelse(as.numeric(x) <= .4, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[25],
                                                         ifelse(as.numeric(x) <= .48, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[30],
                                                         ifelse(as.numeric(x) <= .56, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[35],
                                                         ifelse(as.numeric(x) <= .64, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[40],
                                                         ifelse(as.numeric(x) <= .72, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[45],
                                                         ifelse(as.numeric(x) <= .8, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[50],
                                                         ifelse(as.numeric(x) <= .88, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[55],
                                                         ifelse(as.numeric(x) <= .96, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[60],
                                                         ifelse(as.numeric(x) <= 1.04, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[65],
                                                         ifelse(as.numeric(x) <= 1.12, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[70],
                                                         ifelse(as.numeric(x) <= 1.2, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[75],
                                                         ifelse(as.numeric(x) <= 1.28, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[80],
                                                         ifelse(as.numeric(x) <= 1.36, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[85],
                                                         ifelse(as.numeric(x) <= 1.44, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[90],
                                                         ifelse(as.numeric(x) <= 1.52, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[95],
                                                         ifelse(as.numeric(x) <= 1.6, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[100],
                                                         ifelse(as.numeric(x) <= 1.68, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[105],
                                                         ifelse(as.numeric(x) <= 1.76, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[110],
                                                         ifelse(as.numeric(x) <= 1.84, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[115],
                                                         ifelse(as.numeric(x) <= 1.92, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[120],
                                                         ifelse(as.numeric(x) <= 2.0, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[125],
                                                         ifelse(as.numeric(x) <= 2.08, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[130],
                                                         ifelse(as.numeric(x) <= 2.16, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[135],
                                                         ifelse(as.numeric(x) <= 2.24, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[140],
                                                         ifelse(as.numeric(x) <= 2.32, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[145],
                                                         ifelse(as.numeric(x) <= 2.4, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[150],
                                                         "green"))))))))))))))))))))))))))))))))

Test7 <- formatter("span",
                  style = x ~ style(display = "inline-block",
                                    font.weight = "bold", # here the change
                                    color = "black","border-radius" = "4px",
                                    "padding-right" = "4px", width = "75px",
                                    "background-color" = ifelse(as.numeric(x) <= .08, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[5],
                                                         ifelse(as.numeric(x) <= .16, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[10],
                                                         ifelse(as.numeric(x) <= .24, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[15],
                                                         ifelse(as.numeric(x) <= .32, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[20],
                                                         ifelse(as.numeric(x) <= .4, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[25],
                                                         ifelse(as.numeric(x) <= .48, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[30],
                                                         ifelse(as.numeric(x) <= .56, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[35],
                                                         ifelse(as.numeric(x) <= .64, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[40],
                                                         ifelse(as.numeric(x) <= .72, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[45],
                                                         ifelse(as.numeric(x) <= .8, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[50],
                                                         ifelse(as.numeric(x) <= .88, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[55],
                                                         ifelse(as.numeric(x) <= .96, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[60],
                                                         ifelse(as.numeric(x) <= 1.04, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[65],
                                                         ifelse(as.numeric(x) <= 1.12, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[70],
                                                         ifelse(as.numeric(x) <= 1.2, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[75],
                                                         ifelse(as.numeric(x) <= 1.28, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[80],
                                                         ifelse(as.numeric(x) <= 1.36, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[85],
                                                         ifelse(as.numeric(x) <= 1.44, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[90],
                                                         ifelse(as.numeric(x) <= 1.52, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[95],
                                                         ifelse(as.numeric(x) <= 1.6, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[100],
                                                         ifelse(as.numeric(x) <= 1.68, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[105],
                                                         ifelse(as.numeric(x) <= 1.76, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[110],
                                                         ifelse(as.numeric(x) <= 1.84, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[115],
                                                         ifelse(as.numeric(x) <= 1.92, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[120],
                                                         ifelse(as.numeric(x) <= 2.0, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[125],
                                                         ifelse(as.numeric(x) <= 2.08, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[130],
                                                         ifelse(as.numeric(x) <= 2.16, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[135],
                                                         ifelse(as.numeric(x) <= 2.24, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[140],
                                                         ifelse(as.numeric(x) <= 2.32, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[145],
                                                         ifelse(as.numeric(x) <= 2.4, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[150],
                                                         "green"))))))))))))))))))))))))))))))))

Predictor_column <- formatter("span",
                            style = x ~ style(display = "inline-block", color = "black","border-radius" = "4px",                  
                            "padding-right" = "4px", width = "200px"))


Category_colour <- formatter("span",
                            style = x ~ style(display = "inline-block", font.style = "italic", color = "black","border-radius" = "4px",                  
                            "padding-right" = "4px", width = "150px",
                            "background-color" = ifelse(x == "Other management", "darkgoldenrod",
                                                        ifelse(x == "Nutrient management", "mediumseagreen",
                                                        ifelse(x == "Soil and landscape", "chocolate",
                                                        ifelse(x == "Socio-economic", "lightgrey",
                                                        ifelse(x == "Rainfall", "cornflowerblue",
                                                        ifelse(x == "Crop timing", "indianred",
                                                        ifelse(x == "Irrigation", "skyblue",
                                                               "grey"
                                                        )))))))))

# Make nice table disaggregating by region

## Getting relevant data
simples3_region <- simples3[,c(
  "potpreds",
  "Category",
  "Importance_mean_50to200",
  "Importance_AP_50to200",
  "Importance_Bangladesh_50to200",
  "Importance_Bihar_50to200",
  "Importance_Nepal_50to200",
  "Importance_Odisha_50to200",
  "Importance_Punjab_Haryana_50to200"
)]

## Reordering
simples3_reordered <- simples3_region[,c(
  "potpreds",
  "Category",
  "Importance_mean_50to200",
  "Importance_AP_50to200",
  "Importance_Bihar_50to200",
  "Importance_Odisha_50to200",
  "Importance_Punjab_Haryana_50to200",
  "Importance_Bangladesh_50to200",
  "Importance_Nepal_50to200"
)]

## Make table
FigureS6 <- formattable(simples3_reordered,
            row.names = F,
            col.names = c(
              "Predictor",
              "Category",
              "Mean",
              "Andhra Pradesh",
              "Bihar and E.U.P.",
              "Odisha",
              "Punjab & Haryana",
              "Bangladesh's floodplains",
              "Terai of Nepal"),
            align = "c",
            list(
              potpreds = Predictor_column,
              Category = Category_colour,
              Importance_mean_50to200 = Test7,
              Importance_AP_50to200 = Test6,
              Importance_Bangladesh_50to200 = Test6,
              Importance_Bihar_50to200 = Test6,
              Importance_Nepal_50to200 = Test6,
              Importance_Odisha_50to200 = Test6,
              Importance_Punjab_Haryana_50to200 = Test6
            ))

# save table
setwd('[insert working directory]')

export_formattable <- function(f, file, width = 1000, height = 1500, 
                               background = "white", delay = 0.2, zoom = 5)
    {
      w <- as.htmlwidget(f, width = width, height = height)
      path <- html_print(w, background = background, viewer = NULL)
      url <- paste0("file:///", gsub("\\\\", "/", normalizePath(path)))
      webshot(url,
              file = file,
              selector = ".formattable_widget",
              delay = delay,
              zoom = zoom)
    }

export_formattable(FigureS6,"FigureS6.png")

```

4.21) Checking robustness of Figure 3 results across models: Visualising predictor imoprtance for random forest models that predict yield for nitrogen rate 0-200 kg/ha (Figure S7 in Supplementary Information 7)

```{r}

library(formattable)

# Prep data
## Get columns of interest
simples4 <- pred_comparison_YIELD[,c("potpreds",
                                     "Importance_AP_0to200",
                                     "Importance_Bangladesh_0to200",
                                     "Importance_Bihar_0to200",
                                     "Importance_Nepal_0to200",
                                     "Importance_Odisha_0to200",
                                     "Importance_Punjab_Haryana_0to200"
                                  ),]


## Calculate mean
simples4$Importance_mean_0to200 <- NA
simples4$Importance_AP_0to200 <- as.numeric(simples4$Importance_AP_0to200)
simples4$Importance_Bangladesh_0to200 <- as.numeric(simples4$Importance_Bangladesh_0to200)
simples4$Importance_Bihar_0to200 <- as.numeric(simples4$Importance_Bihar_0to200)
simples4$Importance_Nepal_0to200 <- as.numeric(simples4$Importance_Nepal_0to200)
simples4$Importance_Odisha_0to200 <- as.numeric(simples4$Importance_Odisha_0to200)
simples4$Importance_Punjab_Haryana_0to200 <- as.numeric(simples4$Importance_Punjab_Haryana_0to200)

simples4$Importance_mean_0to200 <- rowMeans(simples4[,c(
  "Importance_AP_0to200",
  "Importance_Bangladesh_0to200",
  "Importance_Bihar_0to200",
  "Importance_Nepal_0to200",
  "Importance_Odisha_0to200",
  "Importance_Punjab_Haryana_0to200")],
  na.rm = T)


## Put mean at front
simples4 <- simples4[,c(
  "potpreds",
  "Importance_mean_0to200",
  "Importance_AP_0to200",
  "Importance_Bangladesh_0to200",
  "Importance_Bihar_0to200",
  "Importance_Nepal_0to200",
  "Importance_Odisha_0to200",
  "Importance_Punjab_Haryana_0to200"
)]


## Order rows from highest median or median  importance to lowest
simples4 <- simples4[order(simples4$Importance_mean_0to200, decreasing = T),]

## Cut rows with all NAs
simples4 <- simples4[is.na(simples4$Importance_mean_0to200) == F,]

## Convert to percentage AND round
for(i in 2:ncol(simples4)){
for(w in 1:nrow(simples4)){
simples4[w,i] <- as.numeric(simples4[w,i])
}}

## Make NA invisble
fnc = function(var, decimal.places) {
  var = sprintf(paste0("%1.",decimal.places,"f"), var)
  var[var=="NA"] = ""
  var
}
vars <- c(
  "Importance_mean_0to200",
  "Importance_AP_0to200",
  "Importance_Bangladesh_0to200",
  "Importance_Bihar_0to200",
  "Importance_Nepal_0to200",
  "Importance_Odisha_0to200",
  "Importance_Punjab_Haryana_0to200"
                         )
simples4[,vars] <- mapply(fnc,simples4[,vars],2:3)

## Round the numbers
simples4$Importance_mean_0to200 <- round(as.numeric(simples4$Importance_mean_0to200), 0)
simples4$Importance_AP_0to200 <- round(as.numeric(simples4$Importance_AP_0to200), 0)
simples4$Importance_Bangladesh_0to200 <- round(as.numeric(simples4$Importance_Bangladesh_0to200), 0)
simples4$Importance_Bihar_0to200 <- round(as.numeric(simples4$Importance_Bihar_0to200), 0)
simples4$Importance_Nepal_0to200 <- round(as.numeric(simples4$Importance_Nepal_0to200), 0)
simples4$Importance_Odisha_0to200 <- round(as.numeric(simples4$Importance_Odisha_0to200), 0)
simples4$Importance_Punjab_Haryana_0to200 <- round(as.numeric(simples4$Importance_Punjab_Haryana_0to200), 0)


# Categorize predictors
simples4$Category <- "Unallocated"
simples4[which(simples4$potpreds == "total_precip"),"Category"] <- "Rainfall" 
simples4[which(simples4$potpreds == "monsoon_onset"),"Category"] <- "Rainfall"
simples4[which(simples4$potpreds == "SPRODMR"),"Category"] <- "Socio-economic"
simples4[which(simples4$potpreds == "Field_duration"),"Category"] <- "Crop timing"
simples4[which(simples4$potpreds == "IRRINU"),"Category"] <- "Irrigation"
simples4[which(simples4$potpreds == "TDATE_rel"),"Category"] <- "Crop timing"
simples4[which(simples4$potpreds == "monsoon_retreat"),"Category"] <- "Rainfall"
simples4[which(simples4$potpreds == "avg_dspell_length"),"Category"] <- "Rainfall"
simples4[which(simples4$potpreds == "DCLASS"),"Category"] <- "Soil and landscape"
simples4[which(simples4$potpreds == "DISEV"),"Category"] <- "Other management"
simples4[which(simples4$potpreds == "DISMR"),"Category"] <- "Socio-economic"
simples4[which(simples4$potpreds == "DRSEV"),"Category"] <- "Rainfall"
simples4[which(simples4$potpreds == "EDU"),"Category"] <- "Socio-economic" 
simples4[which(simples4$potpreds == "EST_line"),"Category"] <- "Other management" # Unclear
simples4[which(simples4$potpreds == "FLSEV"),"Category"] <- "Rainfall" 
simples4[which(simples4$potpreds == "GEN"),"Category"] <- "Socio-economic"
simples4[which(simples4$potpreds == "GYP_ha"),"Category"] <- "Nutrient management"
simples4[which(simples4$potpreds == "HHMEM"),"Category"] <- "Socio-economic" 
simples4[which(simples4$potpreds == "HIFAG"),"Category"] <- "Socio-economic"
simples4[which(simples4$potpreds == "K2O_ha"),"Category"] <- "Nutrient management"
simples4[which(simples4$potpreds == "LOD"),"Category"] <- "Other management" # Unclear
simples4[which(simples4$potpreds == "MaxUnsplit_Nperc_within_1_days"),"Category"] <- "Nutrient management"
simples4[which(simples4$potpreds == "Nperc_7to30_DAT"),"Category"] <- "Nutrient management"
simples4[which(simples4$potpreds == "Nperc_pre_7_DAT"),"Category"] <- "Nutrient management"
simples4[which(simples4$potpreds == "Nursery_duration"),"Category"] <- "Crop timing"
simples4[which(simples4$potpreds == "Organic_ha"),"Category"] <- "Nutrient management"
simples4[which(simples4$potpreds == "P2O5_ha"),"Category"] <- "Nutrient management"
simples4[which(simples4$potpreds == "PCRR"),"Category"] <- "Nutrient management"
simples4[which(simples4$potpreds == "SOCCAT"),"Category"] <- "Socio-economic"
simples4[which(simples4$potpreds == "SoilGrids_bdod"),"Category"] <- "Soil and landscape"
simples4[which(simples4$potpreds == "SoilGrids_phh2o"),"Category"] <- "Soil and landscape"
simples4[which(simples4$potpreds == "SoilGrids_sand"),"Category"] <- "Soil and landscape"
simples4[which(simples4$potpreds == "SoilGrids_soc"),"Category"] <- "Soil and landscape"
simples4[which(simples4$potpreds == "SOILTEX"),"Category"] <- "Soil and landscape"
simples4[which(simples4$potpreds == "SOPER"),"Category"] <- "Soil and landscape"
simples4[which(simples4$potpreds == "SRATEHA"),"Category"] <- "Other management"
simples4[which(simples4$potpreds == "VARTYPE"),"Category"] <- "Other management"
simples4[which(simples4$potpreds == "WSEV"),"Category"] <- "Other management"
simples4[which(simples4$potpreds == "Zn_ha"),"Category"] <- "Nutrient management"
simples4[which(simples4$potpreds == "N_kg_ha"),"Category"] <- "Nutrient management"

# Rename potpredss
simples4[which(simples4$potpreds == "total_precip"),"potpreds"] <- "Total rainfall" 
simples4[which(simples4$potpreds == "monsoon_onset"),"potpreds"] <- "Monsoon onset date"
simples4[which(simples4$potpreds == "SPRODMR"),"potpreds"] <- "Market engagement"
simples4[which(simples4$potpreds == "Field_duration"),"potpreds"] <- "Field duration"
simples4[which(simples4$potpreds == "IRRINU"),"potpreds"] <- "Number of irrigations"
simples4[which(simples4$potpreds == "TDATE_rel"),"potpreds"] <- "Transplanting date"
simples4[which(simples4$potpreds == "monsoon_retreat"),"potpreds"] <- "Monsoon retreat date"
simples4[which(simples4$potpreds == "avg_dspell_length"),"potpreds"] <- "Average dry spell length"
simples4[which(simples4$potpreds == "DCLASS"),"potpreds"] <- "Landscape position"
simples4[which(simples4$potpreds == "DISEV"),"potpreds"] <- "Disease severity"
simples4[which(simples4$potpreds == "DISMR"),"potpreds"] <- "Market distance"
simples4[which(simples4$potpreds == "DRSEV"),"potpreds"] <- "Drought severity"
simples4[which(simples4$potpreds == "EDU"),"potpreds"] <- "Farmer education" 
simples4[which(simples4$potpreds == "EST_line"),"potpreds"] <- "Transplanting method" # Unclear
simples4[which(simples4$potpreds == "FLSEV"),"potpreds"] <- "Flood severity" 
simples4[which(simples4$potpreds == "GEN"),"potpreds"] <- "Farmer gender"
simples4[which(simples4$potpreds == "GYP_ha"),"potpreds"] <- "Gypsum fertilizer"
simples4[which(simples4$potpreds == "HHMEM"),"potpreds"] <- "Household members" 
simples4[which(simples4$potpreds == "HIFAG"),"potpreds"] <- "Farm income dependence"
simples4[which(simples4$potpreds == "K2O_ha"),"potpreds"] <- "Potassium fertilizer"
simples4[which(simples4$potpreds == "LOD"),"potpreds"] <- "Lodging" # Unclear
simples4[which(simples4$potpreds == "MaxUnsplit_Nperc_within_1_days"),"potpreds"] <- "Nitrogen splitting"
simples4[which(simples4$potpreds == "Nperc_7to30_DAT"),"potpreds"] <- "Nitrogen applied at tillering"
simples4[which(simples4$potpreds == "Nperc_pre_7_DAT"),"potpreds"] <- "Nitrogen applied at planting"
simples4[which(simples4$potpreds == "Nursery_duration"),"potpreds"] <- "Nursery duration"
simples4[which(simples4$potpreds == "Organic_ha"),"potpreds"] <- "Organic fertilizer"
simples4[which(simples4$potpreds == "P2O5_ha"),"potpreds"] <- "Phosphorous fertilizer"
simples4[which(simples4$potpreds == "PCRR"),"potpreds"] <- "Previous crop residue"
simples4[which(simples4$potpreds == "SOCCAT"),"potpreds"] <- "Farmer social category"
simples4[which(simples4$potpreds == "SoilGrids_bdod"),"potpreds"] <- "Soil density"
simples4[which(simples4$potpreds == "SoilGrids_phh2o"),"potpreds"] <- "Soil pH"
simples4[which(simples4$potpreds == "SoilGrids_sand"),"potpreds"] <- "Soil sandiness"
simples4[which(simples4$potpreds == "SoilGrids_soc"),"potpreds"] <- "Soil carbon"
simples4[which(simples4$potpreds == "SOILTEX"),"potpreds"] <- "Farmer-judged soil texture"
simples4[which(simples4$potpreds == "SOPER"),"potpreds"] <- "Farmer soil perception"
simples4[which(simples4$potpreds == "SRATEHA"),"potpreds"] <- "Seed rate"
simples4[which(simples4$potpreds == "VARTYPE"),"potpreds"] <- "Variety type"
simples4[which(simples4$potpreds == "WSEV"),"potpreds"] <- "Weed severity"
simples4[which(simples4$potpreds == "Zn_ha"),"potpreds"] <- "Zinc fertilizer"
simples4[which(simples4$potpreds == "N_kg_ha"),"potpreds"] <- "Nitrogen rate"


# Make some nice table formatting

Test8 <- formatter("span",
                  style = x ~ style(display = "inline-block", color = "black","border-radius" = "4px",
                                    "padding-right" = "4px", width = "75px",
                                    "background-color" = ifelse(as.numeric(x) <= 5, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[5],
                                                         ifelse(as.numeric(x) <= 10, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[10],
                                                         ifelse(as.numeric(x) <= 15, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[15],
                                                         ifelse(as.numeric(x) <= 25, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[20],
                                                         ifelse(as.numeric(x) <= 30, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[25],
                                                         ifelse(as.numeric(x) <= 35, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[30],
                                                         ifelse(as.numeric(x) <= 40, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[35],
                                                         ifelse(as.numeric(x) <= 45, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[40],
                                                         ifelse(as.numeric(x) <= 50, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[45],
                                                         ifelse(as.numeric(x) <= 55, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[50],
                                                         ifelse(as.numeric(x) <= 60, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[55],
                                                         ifelse(as.numeric(x) <= 65, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[60],
                                                         ifelse(as.numeric(x) <= 70, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[65],
                                                         ifelse(as.numeric(x) <= 75, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[70],
                                                         ifelse(as.numeric(x) <= 80, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[75],
                                                         ifelse(as.numeric(x) <= 85, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[80],
                                                         ifelse(as.numeric(x) <= 90, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[85],
                                                         ifelse(as.numeric(x) <= 95, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[90],
                                                         ifelse(as.numeric(x) <= 100, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[95],
                                                         ifelse(as.numeric(x) <= 105, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[100],
                                                         ifelse(as.numeric(x) <= 110, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[105],
                                                         ifelse(as.numeric(x) <= 115, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[110],
                                                         ifelse(as.numeric(x) <= 120, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[115],
                                                         ifelse(as.numeric(x) <= 125, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[120],
                                                         ifelse(as.numeric(x) <= 130, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[125],
                                                         ifelse(as.numeric(x) <= 135, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[130],
                                                         ifelse(as.numeric(x) <= 140, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[135],
                                                         ifelse(as.numeric(x) <= 145, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[140],
                                                         ifelse(as.numeric(x) <= 150, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[145],
                                                         ifelse(as.numeric(x) <= 155, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[150],
                                                         "green"))))))))))))))))))))))))))))))))

Test9 <- formatter("span",
                  style = x ~ style(display = "inline-block",
                                    font.weight = "bold", # here the change
                                    color = "black","border-radius" = "4px",
                                    "padding-right" = "4px", width = "75px",
                                    "background-color" = ifelse(as.numeric(x) <= 5, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[5],
                                                         ifelse(as.numeric(x) <= 10, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[10],
                                                         ifelse(as.numeric(x) <= 15, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[15],
                                                         ifelse(as.numeric(x) <= 25, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[20],
                                                         ifelse(as.numeric(x) <= 30, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[25],
                                                         ifelse(as.numeric(x) <= 35, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[30],
                                                         ifelse(as.numeric(x) <= 40, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[35],
                                                         ifelse(as.numeric(x) <= 45, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[40],
                                                         ifelse(as.numeric(x) <= 50, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[45],
                                                         ifelse(as.numeric(x) <= 55, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[50],
                                                         ifelse(as.numeric(x) <= 60, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[55],
                                                         ifelse(as.numeric(x) <= 65, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[60],
                                                         ifelse(as.numeric(x) <= 70, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[65],
                                                         ifelse(as.numeric(x) <= 75, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[70],
                                                         ifelse(as.numeric(x) <= 80, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[75],
                                                         ifelse(as.numeric(x) <= 85, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[80],
                                                         ifelse(as.numeric(x) <= 90, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[85],
                                                         ifelse(as.numeric(x) <= 95, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[90],
                                                         ifelse(as.numeric(x) <= 100, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[95],
                                                         ifelse(as.numeric(x) <= 105, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[100],
                                                         ifelse(as.numeric(x) <= 110, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[105],
                                                         ifelse(as.numeric(x) <= 115, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[110],
                                                         ifelse(as.numeric(x) <= 120, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[115],
                                                         ifelse(as.numeric(x) <= 125, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[120],
                                                         ifelse(as.numeric(x) <= 130, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[125],
                                                         ifelse(as.numeric(x) <= 135, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[130],
                                                         ifelse(as.numeric(x) <= 140, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[135],
                                                         ifelse(as.numeric(x) <= 145, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[140],
                                                         ifelse(as.numeric(x) <= 150, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[145],
                                                         ifelse(as.numeric(x) <= 155, colorRampPalette(c("lemonchiffon", "forestgreen"))(150)[150],
                                                         "green"))))))))))))))))))))))))))))))))

Predictor_column <- formatter("span",
                            style = x ~ style(display = "inline-block", color = "black","border-radius" = "4px",                  
                            "padding-right" = "4px", width = "200px"))


Category_colour <- formatter("span",
                            style = x ~ style(display = "inline-block", font.style = "italic", color = "black","border-radius" = "4px",                  
                            "padding-right" = "4px", width = "150px",
                            "background-color" = ifelse(x == "Other management", "darkgoldenrod",
                                                        ifelse(x == "Nutrient management", "mediumseagreen",
                                                        ifelse(x == "Soil and landscape", "chocolate",
                                                        ifelse(x == "Socio-economic", "lightgrey",
                                                        ifelse(x == "Rainfall", "cornflowerblue",
                                                        ifelse(x == "Crop timing", "indianred",
                                                        ifelse(x == "Irrigation", "skyblue",
                                                               "grey"
                                                        )))))))))

# Make nice table disaggregating by region

## Getting relevant data
simples4_region <- simples4[,c(
  "potpreds",
  "Category",
  "Importance_mean_0to200",
  "Importance_AP_0to200",
  "Importance_Bangladesh_0to200",
  "Importance_Bihar_0to200",
  "Importance_Nepal_0to200",
  "Importance_Odisha_0to200",
  "Importance_Punjab_Haryana_0to200"
)]

simples4_reordered <- simples4_region[,c(
  "potpreds",
  "Category",
  "Importance_mean_0to200",
  "Importance_AP_0to200",
  "Importance_Bihar_0to200",
  "Importance_Odisha_0to200",
  "Importance_Punjab_Haryana_0to200",
  "Importance_Bangladesh_0to200",
  "Importance_Nepal_0to200"
)]

## Make table
FigureS7 <- formattable(simples4_reordered,
            row.names = F,
            col.names = c(
              "Predictor",
              "Category",
              "Mean",
              "Andhra Pradesh",
              "Bihar and E.U.P.",
              "Odisha",
              "Punjab & Haryana",
              "Bangladesh's floodplains",
              "Terai of Nepal"),
            align = "c",
            list(
              potpreds = Predictor_column,
              Category = Category_colour,
              Importance_mean_0to200 = Test9,
              Importance_AP_0to200 = Test8,
              Importance_Bangladesh_0to200 = Test8,
              Importance_Bihar_0to200 = Test8,
              Importance_Nepal_0to200 = Test8,
              Importance_Odisha_0to200 = Test8,
              Importance_Punjab_Haryana_0to200 = Test8
            ))

# save table
setwd('[insert working directory]')

export_formattable <- function(f, file, width = 1000, height = 1500, 
                               background = "white", delay = 0.2, zoom = 5)
    {
      w <- as.htmlwidget(f, width = width, height = height)
      path <- html_print(w, background = background, viewer = NULL)
      url <- paste0("file:///", gsub("\\\\", "/", normalizePath(path)))
      webshot(url,
              file = file,
              selector = ".formattable_widget",
              delay = delay,
              zoom = zoom)
    }

export_formattable(FigureS7,"FigureS7.png")

```